apiVersion: batch/v1
kind: Job
metadata:
  name: test-email-producer
  namespace: kafka-demo
spec:
  template:
    spec:
      containers:
      - name: producer
        image: quay.io/strimzi/kafka:latest-kafka-3.8.0
        command: ["/bin/bash"]
        args:
        - -c
        - |
          # Wait for Kafka to be ready
          echo "Waiting for Kafka to be ready..."
          sleep 10

          echo "ðŸ§ª Testing real email delivery to timour.miagol@outlook.de"

          # Create test user registration with your Outlook email address
          TEST_MESSAGE='{"user_id":"test-user-timour","email":"timour.miagol@outlook.de","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","region":"eu-central-1","event_type":"user_registration"}'

          echo "ðŸ“¤ Sending test registration: $TEST_MESSAGE"

          # Send the test message to user-registrations topic
          echo "$TEST_MESSAGE" | /opt/kafka/bin/kafka-console-producer.sh \
            --bootstrap-server my-cluster-kafka-bootstrap.kafka:9092 \
            --topic user-registrations

          echo "âœ… Test registration message sent - should trigger email to timour.miagol@outlook.de"

          # Send a few more test messages
          for i in {1..3}; do
            TEST_MSG='{"user_id":"outlook-test-'$i'","email":"timour.miagol@outlook.de","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'","region":"test-region","event_type":"registration_test"}'
            echo "ðŸ“§ Sending test message $i: $TEST_MSG"
            echo "$TEST_MSG" | /opt/kafka/bin/kafka-console-producer.sh \
              --bootstrap-server my-cluster-kafka-bootstrap.kafka:9092 \
              --topic user-registrations
            sleep 2
          done

          echo "ðŸŽ¯ Test complete - check your Outlook inbox for welcome emails!"
      restartPolicy: Never