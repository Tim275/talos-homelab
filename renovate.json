{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":rebaseStalePrs",
    ":dependencyDashboard",
    ":semanticCommits",
    ":enablePreCommit",
    "docker:enableMajor",
    "helpers:pinGitHubActionDigests"
  ],
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "Renovate Dashboard",
  "schedule": ["before 6am every weekday"],
  "timezone": "Europe/Berlin",
  "prConcurrentLimit": 20,
  "prHourlyLimit": 10,
  "labels": ["dependencies", "renovate"],
  "vulnerabilityAlerts": {
    "enabled": true,
    "labels": ["security", "vulnerability"]
  },
  "terraform": {
    "managerFilePatterns": [
      "/\\.tf$/",
      "/\\.tofu$/"
    ]
  },
  "kubernetes": {
    "fileMatch": [
      "\\.yaml$",
      "\\.yml$"
    ]
  },
  "kustomize": {
    "managerFilePatterns": [
      "/(^|/)kustomization\\.ya?ml(\\.j2)?$/"
    ]
  },
  "customManagers": [
    {
      "customType": "regex",
      "managerFilePatterns": [
        "/\\.tf$/",
        "/\\.tofu$/",
        "/\\.tftpl$/",
        "/\\.yaml$/",
        "/\\.sh$/",
        "/\\.tfvars/"
      ],
      "matchStrings": [
        "(?<currentValue>[\\w+\\.\\-]*)['\",;]*\\s*#\\s?renovate: (?<datasource>\\S+)=(?<depName>\\S+)\\s?(registry=(?<registryUrl>\\S+))?\\s?(versioning=(?<versioning>\\S+))?"
      ]
    },
    {
      "customType": "regex",
      "description": "Update Talos Docker images",
      "fileMatch": ["\\.yaml$"],
      "matchStrings": [
        "image:\\s*(?:ghcr\\.io/)?siderolabs/talos:(?<currentValue>v?[0-9]+\\.[0-9]+\\.[0-9]+)"
      ],
      "datasourceTemplate": "docker",
      "depNameTemplate": "ghcr.io/siderolabs/talos",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Update Rook Ceph Docker images",
      "fileMatch": ["\\.yaml$"],
      "matchStrings": [
        "image:\\s*(?:quay\\.io/)?rook/ceph:(?<currentValue>v?[0-9]+\\.[0-9]+\\.[0-9]+)"
      ],
      "datasourceTemplate": "docker",
      "depNameTemplate": "quay.io/rook/ceph",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Update Helm chart versions in kustomization.yaml",
      "fileMatch": ["kustomization\\.yaml$"],
      "matchStrings": [
        "version:\\s*\"(?<currentValue>[0-9.]+)\"\\s*#\\s*renovate:\\s*helm=(?<depName>[^\\s]+)"
      ],
      "datasourceTemplate": "helm",
      "registryUrlTemplate": "https://grafana.github.io/helm-charts"
    },
    {
      "customType": "regex",
      "description": "Update Talos versions in tfvars files",
      "fileMatch": [
        "\\.tfvars$"
      ],
      "matchStrings": [
        "version\\s*=\\s*\"(?<currentValue>v?[0-9]+\\.[0-9]+\\.[0-9]+)\"",
        "talos_machine_config_version\\s*=\\s*\"(?<currentValue>v?[0-9]+\\.[0-9]+\\.[0-9]+)\""
      ],
      "datasourceTemplate": "github-releases",
      "depNameTemplate": "siderolabs/talos"
    },
    {
      "customType": "regex",
      "description": "Update Kubernetes versions in tfvars files",
      "fileMatch": [
        "\\.tfvars$"
      ],
      "matchStrings": [
        "kubernetes_version\\s*=\\s*\"(?<currentValue>v?[0-9]+\\.[0-9]+\\.[0-9]+)\""
      ],
      "datasourceTemplate": "github-releases",
      "depNameTemplate": "kubernetes/kubernetes"
    },
    {
      "customType": "regex",
      "description": "Update Gateway API versions in tfvars files",
      "fileMatch": [
        "\\.tfvars$"
      ],
      "matchStrings": [
        "gateway_api_version\\s*=\\s*\"(?<currentValue>v?[0-9]+\\.[0-9]+\\.[0-9]+)\""
      ],
      "datasourceTemplate": "github-releases",
      "depNameTemplate": "kubernetes-sigs/gateway-api"
    }
  ],
  "packageRules": [
    {
      "groupName": "Talos System",
      "matchPackageNames": [
        "siderolabs/talos"
      ]
    },
    {
      "groupName": "Kubernetes Core",
      "matchPackageNames": [
        "kubernetes/kubernetes",
        "kubernetes-sigs/gateway-api"
      ]
    },
    {
      "groupName": "Cilium",
      "matchPackageNames": [
        "cilium/**"
      ]
    },
    {
      "groupName": "Monitoring Stack",
      "matchPackageNames": [
        "prometheus-community/**",
        "grafana/**"
      ]
    },
    {
      "groupName": "Storage & Backup",
      "matchPackageNames": [
        "**/rook**",
        "**/velero**"
      ]
    },
    {
      "groupName": "ArgoCD Ecosystem",
      "matchPackageNames": [
        "argoproj/**",
        "**/argo-rollouts**"
      ]
    },
    {
      "groupName": "Istio Service Mesh",
      "matchPackageNames": [
        "**/istio**",
        "istio/**"
      ]
    },
    {
      "groupName": "Security Tools",
      "matchPackageNames": [
        "jetstack/**",
        "**/cert-manager**",
        "bitnami-labs/**",
        "**/sealed-secrets**",
        "**/kyverno**"
      ]
    },
    {
      "groupName": "Database & Platform",
      "matchPackageNames": [
        "**/mongodb**",
        "**/postgresql**",
        "**/cloudnative-pg**",
        "**/kafka**",
        "**/strimzi**",
        "**/n8n**"
      ]
    },
    {
      "matchManagers": [
        "terraform"
      ],
      "matchDepTypes": [
        "provider",
        "required_provider"
      ]
    },
    {
      "matchManagers": [
        "github-actions"
      ],
      "groupName": "GitHub Actions",
      "groupSlug": "github-actions"
    },
    {
      "description": "Auto-merge patch updates (security fixes)",
      "matchUpdateTypes": ["patch"],
      "automerge": true,
      "automergeType": "pr",
      "labels": ["auto-merge", "patch"]
    },
    {
      "description": "Minor updates for trusted packages",
      "matchUpdateTypes": ["minor"],
      "matchPackagePatterns": [
        "grafana",
        "prometheus",
        "loki",
        "tempo"
      ],
      "automerge": true,
      "labels": ["auto-merge", "minor"]
    },
    {
      "description": "Hold major updates for manual review",
      "matchUpdateTypes": ["major"],
      "dependencyDashboardApproval": true,
      "automerge": false,
      "labels": ["major-update", "needs-review"]
    }
  ]
}