{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":rebaseStalePrs",
    ":dependencyDashboard",
    ":semanticCommits",
    "docker:enableMajor",
    "helpers:pinGitHubActionDigests"
  ],
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "Renovate Dashboard",
  "schedule": ["before 6am every weekday"],
  "timezone": "Europe/Berlin",
  "prConcurrentLimit": 20,
  "prHourlyLimit": 10,
  "labels": ["dependencies", "renovate"],
  "vulnerabilityAlerts": {
    "enabled": true,
    "labels": ["security", "vulnerability"]
  },
  "registryAliases": {
    "ghcr.io/siderolabs": "https://ghcr.io/siderolabs",
    "quay.io/rook": "https://quay.io/rook"
  },
  "hostRules": [
    {
      "matchHost": "ghcr.io",
      "hostType": "docker"
    }
  ],
  "helmv3": {
    "registryAliases": {
      "grafana": "https://grafana.github.io/helm-charts",
      "prometheus-community": "https://prometheus-community.github.io/helm-charts",
      "bitnami": "https://charts.bitnami.com/bitnami",
      "jetstack": "https://charts.jetstack.io",
      "argo": "https://argoproj.github.io/argo-helm",
      "istio": "https://istio-release.storage.googleapis.com/charts",
      "cilium": "https://helm.cilium.io"
    }
  },
  "kubernetes": {
    "fileMatch": ["\\.yaml$", "\\.yml$"]
  },
  "customManagers": [
    {
      "customType": "regex",
      "description": "Generic renovate comments",
      "fileMatch": ["\\.tf$", "\\.tofu$", "\\.yaml$", "\\.sh$", "\\.tfvars$"],
      "matchStrings": [
        "(?<currentValue>[\\w+\\.\\-]*)['\",;]*\\s*#\\s?renovate: (?<datasource>\\S+)=(?<depName>\\S+)\\s?(registry=(?<registryUrl>\\S+))?\\s?(versioning=(?<versioning>\\S+))?"
      ]
    },
    {
      "customType": "regex",
      "description": "Update Talos Docker images from ghcr.io",
      "fileMatch": ["\\.yaml$"],
      "matchStrings": [
        "image:\\s*ghcr\\.io/siderolabs/talos:(?<currentValue>v?[0-9]+\\.[0-9]+\\.[0-9]+)"
      ],
      "datasourceTemplate": "docker",
      "depNameTemplate": "ghcr.io/siderolabs/talos",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Update Rook Ceph Docker images",
      "fileMatch": ["\\.yaml$"],
      "matchStrings": [
        "image:\\s*(?:quay\\.io/)?rook/ceph:(?<currentValue>v?[0-9]+\\.[0-9]+\\.[0-9]+)"
      ],
      "datasourceTemplate": "docker",
      "depNameTemplate": "quay.io/rook/ceph",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Update Grafana Helm charts in kustomization.yaml",
      "fileMatch": ["kustomization\\.yaml$"],
      "matchStrings": [
        "version:\\s*[\"']?(?<currentValue>[0-9.]+)[\"']?\\s*#\\s*renovate:\\s*helm=grafana/(?<depName>[^\\s]+)"
      ],
      "datasourceTemplate": "helm",
      "registryUrlTemplate": "https://grafana.github.io/helm-charts"
    },
    {
      "customType": "regex",
      "description": "Update Prometheus Helm charts",
      "fileMatch": ["kustomization\\.yaml$"],
      "matchStrings": [
        "version:\\s*[\"']?(?<currentValue>[0-9.]+)[\"']?\\s*#\\s*renovate:\\s*helm=prometheus-community/(?<depName>[^\\s]+)"
      ],
      "datasourceTemplate": "helm",
      "registryUrlTemplate": "https://prometheus-community.github.io/helm-charts"
    }
  ],
  "packageRules": [
    {
      "groupName": "Talos System",
      "matchPackageNames": ["ghcr.io/siderolabs/talos", "siderolabs/talos"]
    },
    {
      "groupName": "Monitoring Stack",
      "matchPackagePatterns": ["prometheus", "grafana", "loki", "tempo"]
    },
    {
      "groupName": "ArgoCD Ecosystem",
      "matchPackagePatterns": ["argo"]
    },
    {
      "groupName": "Security Tools",
      "matchPackagePatterns": ["cert-manager", "sealed-secrets", "kyverno"]
    },
    {
      "description": "Auto-merge patch updates",
      "matchUpdateTypes": ["patch"],
      "automerge": true,
      "automergeType": "pr",
      "labels": ["auto-merge", "patch"]
    },
    {
      "description": "Hold major updates for manual review",
      "matchUpdateTypes": ["major"],
      "dependencyDashboardApproval": true,
      "automerge": false,
      "labels": ["major-update", "needs-review"]
    }
  ]
}
