{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:best-practices",
    ":dependencyDashboard",
    ":semanticCommits",
    ":separateMajorReleases",
    "docker:enableMajor",
    "helpers:pinGitHubActionDigests",
    "group:monorepos",
    "group:recommended"
  ],
  "dependencyDashboard": true,
  "dependencyDashboardTitle": "Renovate Dashboard",
  "dependencyDashboardLabels": [
    "renovate",
    "dependencies"
  ],
  "schedule": [
    "before 6am every weekday"
  ],
  "timezone": "Europe/Berlin",
  "prConcurrentLimit": 10,
  "prHourlyLimit": 5,
  "branchConcurrentLimit": 15,
  "labels": [
    "dependencies",
    "renovate"
  ],
  "vulnerabilityAlerts": {
    "enabled": true,
    "labels": [
      "security",
      "vulnerability",
      "priority-high"
    ]
  },
  "lockFileMaintenance": {
    "enabled": true,
    "schedule": [
      "before 5am on monday"
    ]
  },
  "kubernetes": {
    "managerFilePatterns": [
      "/\\.yaml$/",
      "/\\.yml$/"
    ]
  },
  "packageRules": [
    {
      "description": "Grafana Helm Charts registry",
      "matchDatasources": [
        "helm"
      ],
      "matchPackageNames": [
        "loki",
        "tempo-distributed",
        "grafana",
        "promtail",
        "grafana-operator"
      ],
      "registryUrls": [
        "https://grafana.github.io/helm-charts"
      ]
    },
    {
      "description": "Talos Docker images - use ghcr.io",
      "matchDatasources": [
        "docker"
      ],
      "registryUrls": [
        "https://ghcr.io"
      ],
      "matchPackageNames": [
        "/siderolabs/talos/"
      ]
    },
    {
      "description": "Group Cilium updates",
      "groupName": "Cilium CNI",
      "matchPackageNames": [
        "/cilium/"
      ]
    },
    {
      "description": "Group ArgoCD ecosystem",
      "groupName": "ArgoCD Ecosystem",
      "matchPackageNames": [
        "/argo/",
        "/argocd/"
      ]
    },
    {
      "description": "Group monitoring stack",
      "groupName": "Monitoring Stack",
      "matchPackageNames": [
        "/prometheus/",
        "/grafana/",
        "/loki/",
        "/tempo/",
        "/victoriametrics/"
      ]
    },
    {
      "description": "Group security tools",
      "groupName": "Security Tools",
      "matchPackageNames": [
        "/cert-manager/",
        "/sealed-secrets/",
        "/kyverno/",
        "/trivy/"
      ]
    },
    {
      "description": "Group storage tools",
      "groupName": "Storage Stack",
      "matchPackageNames": [
        "/rook/",
        "/ceph/",
        "/velero/",
        "/longhorn/",
        "/minio/"
      ]
    },
    {
      "description": "Group Kafka/messaging",
      "groupName": "Messaging Stack",
      "matchPackageNames": [
        "/kafka/",
        "/strimzi/",
        "/redpanda/",
        "/rabbitmq/"
      ]
    },
    {
      "description": "PATCH updates - PRs created, NO automerge (n8n decides)",
      "matchUpdateTypes": [
        "patch"
      ],
      "automerge": false,
      "labels": [
        "patch",
        "low-risk"
      ]
    },
    {
      "description": "MINOR updates - PRs created, NO automerge (n8n decides)",
      "matchUpdateTypes": [
        "minor"
      ],
      "automerge": false,
      "labels": [
        "minor",
        "medium-risk"
      ]
    },
    {
      "description": "MAJOR updates - require manual review",
      "matchUpdateTypes": [
        "major"
      ],
      "automerge": false,
      "labels": [
        "major",
        "high-risk",
        "breaking-change"
      ]
    },
    {
      "description": "Security updates - high priority",
      "matchDepTypes": [
        "security"
      ],
      "labels": [
        "security",
        "priority-high"
      ],
      "automerge": false
    },
    {
      "description": "Critical infrastructure - never automerge",
      "automerge": false,
      "labels": [
        "critical-infrastructure"
      ],
      "matchPackageNames": [
        "/cilium/",
        "/cert-manager/",
        "/cloudnative-pg/",
        "/postgresql/",
        "/etcd/"
      ]
    },
    {
      "description": "Databases - extra careful",
      "automerge": false,
      "labels": [
        "database",
        "high-risk"
      ],
      "matchPackageNames": [
        "/postgres/",
        "/mysql/",
        "/mongodb/",
        "/redis/",
        "/elasticsearch/"
      ]
    }
  ],
  "customManagers": [
    {
      "customType": "regex",
      "description": "Generic renovate comments",
      "managerFilePatterns": [
        "/\\.tf$/",
        "/\\.yaml$/",
        "/\\.yml$/",
        "/\\.sh$/"
      ],
      "matchStrings": [
        "(?<currentValue>[\\w+\\.\\-]*)['\",;]*\\s*#\\s*renovate:\\s*(?<datasource>\\S+)=(?<depName>\\S+)"
      ]
    },
    {
      "customType": "regex",
      "description": "Talos Docker images",
      "managerFilePatterns": [
        "/\\.yaml$/"
      ],
      "matchStrings": [
        "image:\\s*(?:ghcr\\.io/)?siderolabs/talos:(?<currentValue>v?[\\d.]+)"
      ],
      "datasourceTemplate": "docker",
      "depNameTemplate": "ghcr.io/siderolabs/talos"
    },
    {
      "customType": "regex",
      "description": "Helm charts in kustomization with renovate comment",
      "managerFilePatterns": [
        "/kustomization\\.yaml$/"
      ],
      "matchStrings": [
        "version:\\s*[\"']?(?<currentValue>[\\d.]+)[\"']?\\s*#\\s*renovate:\\s*helm=(?<registryUrl>[^/]+)/(?<depName>\\S+)"
      ],
      "datasourceTemplate": "helm",
      "registryUrlTemplate": "https://{{registryUrl}}.github.io/helm-charts"
    }
  ]
}
