{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:best-practices",
    ":dependencyDashboard",
    ":semanticCommits",
    ":separateMajorReleases",
    "docker:enableMajor",
    "helpers:pinGitHubActionDigests",
    "group:monorepos",
    "group:recommended"
  ],

  "dependencyDashboard": true,
  "dependencyDashboardTitle": "Renovate Dashboard",
  "dependencyDashboardLabels": ["renovate", "dependencies"],

  "schedule": ["before 6am every weekday"],
  "timezone": "Europe/Berlin",

  "prConcurrentLimit": 10,
  "prHourlyLimit": 5,
  "branchConcurrentLimit": 15,

  "labels": ["dependencies", "renovate"],

  "vulnerabilityAlerts": {
    "enabled": true,
    "labels": ["security", "vulnerability", "priority-high"]
  },

  "lockFileMaintenance": {
    "enabled": true,
    "schedule": ["before 5am on monday"]
  },

  "kubernetes": {
    "fileMatch": ["\\.yaml$", "\\.yml$"]
  },

  "packageRules": [
    {
      "description": "Grafana Helm Charts registry",
      "matchDatasources": ["helm"],
      "matchPackageNames": ["loki", "tempo-distributed", "grafana", "promtail", "grafana-operator"],
      "registryUrls": ["https://grafana.github.io/helm-charts"]
    },
    {
      "description": "Talos Docker images - use ghcr.io",
      "matchDatasources": ["docker"],
      "matchPackagePatterns": ["siderolabs/talos"],
      "registryUrls": ["https://ghcr.io"]
    },

    {
      "description": "Group Cilium updates",
      "groupName": "Cilium CNI",
      "matchPackagePatterns": ["cilium"]
    },
    {
      "description": "Group ArgoCD ecosystem",
      "groupName": "ArgoCD Ecosystem",
      "matchPackagePatterns": ["argo", "argocd"]
    },
    {
      "description": "Group monitoring stack",
      "groupName": "Monitoring Stack",
      "matchPackagePatterns": ["prometheus", "grafana", "loki", "tempo", "victoriametrics"]
    },
    {
      "description": "Group security tools",
      "groupName": "Security Tools",
      "matchPackagePatterns": ["cert-manager", "sealed-secrets", "kyverno", "trivy"]
    },
    {
      "description": "Group storage tools",
      "groupName": "Storage Stack",
      "matchPackagePatterns": ["rook", "ceph", "velero", "longhorn", "minio"]
    },
    {
      "description": "Group Kafka/messaging",
      "groupName": "Messaging Stack",
      "matchPackagePatterns": ["kafka", "strimzi", "redpanda", "rabbitmq"]
    },

    {
      "description": "PATCH updates - PRs created, NO automerge (n8n decides)",
      "matchUpdateTypes": ["patch"],
      "automerge": false,
      "labels": ["patch", "low-risk"]
    },
    {
      "description": "MINOR updates - PRs created, NO automerge (n8n decides)",
      "matchUpdateTypes": ["minor"],
      "automerge": false,
      "labels": ["minor", "medium-risk"]
    },
    {
      "description": "MAJOR updates - require manual review",
      "matchUpdateTypes": ["major"],
      "automerge": false,
      "labels": ["major", "high-risk", "breaking-change"]
    },
    {
      "description": "Security updates - high priority",
      "matchDepTypes": ["security"],
      "labels": ["security", "priority-high"],
      "automerge": false
    },

    {
      "description": "Critical infrastructure - never automerge",
      "matchPackagePatterns": ["cilium", "cert-manager", "cloudnative-pg", "postgresql", "etcd"],
      "automerge": false,
      "labels": ["critical-infrastructure"]
    },
    {
      "description": "Databases - extra careful",
      "matchPackagePatterns": ["postgres", "mysql", "mongodb", "redis", "elasticsearch"],
      "automerge": false,
      "labels": ["database", "high-risk"]
    }
  ],

  "customManagers": [
    {
      "customType": "regex",
      "description": "Generic renovate comments",
      "fileMatch": ["\\.tf$", "\\.yaml$", "\\.yml$", "\\.sh$"],
      "matchStrings": [
        "(?<currentValue>[\\w+\\.\\-]*)['\",;]*\\s*#\\s*renovate:\\s*(?<datasource>\\S+)=(?<depName>\\S+)"
      ]
    },
    {
      "customType": "regex",
      "description": "Talos Docker images",
      "fileMatch": ["\\.yaml$"],
      "matchStrings": [
        "image:\\s*(?:ghcr\\.io/)?siderolabs/talos:(?<currentValue>v?[\\d.]+)"
      ],
      "datasourceTemplate": "docker",
      "depNameTemplate": "ghcr.io/siderolabs/talos"
    },
    {
      "customType": "regex",
      "description": "Helm charts in kustomization with renovate comment",
      "fileMatch": ["kustomization\\.yaml$"],
      "matchStrings": [
        "version:\\s*[\"']?(?<currentValue>[\\d.]+)[\"']?\\s*#\\s*renovate:\\s*helm=(?<registryUrl>[^/]+)/(?<depName>\\S+)"
      ],
      "datasourceTemplate": "helm",
      "registryUrlTemplate": "https://{{registryUrl}}.github.io/helm-charts"
    }
  ]
}
