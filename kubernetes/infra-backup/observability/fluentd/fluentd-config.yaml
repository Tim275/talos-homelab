apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: elastic-system
data:
  fluent.conf: |-
    # Ignore Fluentd's own logs
    <match fluent.**>
      @type null
    </match>

    # Input: Tail container logs
    <source>
      @type tail
      @id in_tail_container_logs
      path /var/log/containers/*.log
      pos_file /var/log/fluentd-containers.log.pos
      tag kubernetes.*
      read_from_head true
      <parse>
        @type none
        time_format %Y-%m-%dT%H:%M:%S.%NZ    
      </parse>
    </source>

    # Filter: Add Kubernetes metadata
    <filter kubernetes.**>
      @id filter_kubernetes_metadata
      @type kubernetes_metadata
    </filter>

    # Output: Send to our Elasticsearch cluster
    <match **>
       @type elasticsearch_dynamic
       @log_level info
       include_tag_key true
       host production-cluster-es-http.elastic-system
       port 9200
       path ""
       scheme https
       ssl_verify false
       ssl_version TLSv1_2
       user elastic
       password 04h26K03zEMhI7I9DRbk5AT5
       reload_connections false
       reconnect_on_error true
       reload_on_failure true
       log_es_400_reason false
       logstash_prefix logstash
       logstash_dateformat %Y.%m.%d       
       logstash_format true
       index_name logstash
       type_name fluentd
       request_timeout 2147483648
       <buffer>
        @type file
        path /var/log/fluentd_disk_buffer
        total_limit_size 2GB
        flush_thread_count 8
        flush_interval 30s
        chunk_limit_size 20M
        queue_limit_length 100
        retry_max_interval 30
        retry_forever true
       </buffer>
    </match>

    # Exclude logging stack logs to avoid recursion
    <match kubernetes.var.log.containers.**elastic-system**.log>
        @type null
    </match>

    <match kubernetes.var.log.containers.**kube-logging**.log>
        @type null
    </match>

    <match kubernetes.var.log.containers.**monitoring**.log>
        @type null
    </match>

    <match kubernetes.var.log.containers.**infra**.log>
        @type null
    </match>