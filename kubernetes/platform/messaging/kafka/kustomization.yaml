resources:

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namePrefix: messaging-

# 🌊 Sync Wave 12: Enterprise Messaging Platform (Kafka with Strimzi)
commonAnnotations:
  argocd.argoproj.io/sync-wave: "12"
  # 🏢 Enterprise Service Ownership (moved to annotations to prevent service selector pollution)
  enterprise.app.kubernetes.io/managed-by: argocd
  enterprise.app.kubernetes.io/part-of: timour-homelab
  enterprise.app.kubernetes.io/component: messaging-platform
  enterprise.team: timour
  enterprise.service-owner: timour
  enterprise.service-tier: platform

namespace: kafka

resources:
  - namespace.yaml
  - kafka-metrics-config.yaml
  # Kafka Custom Resources - now enabled after operator deployment
  - kafka-cluster.yaml
  - kafka-topic.yaml
  # 🎯 MONITORING: ServiceMonitors moved to infrastructure/monitoring/servicemonitors/ (Vegarn pattern)
  - kafka-exporter-service.yaml  # ✅ CORRECTED Service with proper selector for Kafka Exporter metrics
  - kafka-exporter-servicemonitor.yaml   # Prometheus ServiceMonitor (fixed from VMServiceScrape)

# 🚨 CRITICAL INFRASTRUCTURE AS CODE: Service Labeling für Grafana Dashboard Discovery
# ===================================================================================
#
# 🎯 PROBLEM: Kafka Services haben NICHT die Labels die ServiceMonitor braucht!
# 🎯 LÖSUNG: Kustomize patches fügen automatisch die CRITICAL labels hinzu!
#
# 🔧 WAS PASSIERT:
# 1. Strimzi Kafka Operator erstellt "my-cluster-kafka-brokers" service
# 2. Service hat NUR: app.kubernetes.io/name=kafka, strimzi.io/cluster=my-cluster
# 3. ServiceMonitor sucht: app=kafka, component=kafka-broker, release=prometheus-operator
# 4. MISMATCH = keine metrics in Grafana! 😭
# 5. Diese patches fügen fehlende labels AUTOMATISCH hinzu! 🎉
#
# 🎛️ RULE: JEDER Service der in Grafana sichtbar sein soll MUSS haben:
# - release: prometheus-operator  ← Prometheus entdeckt nur Services mit diesem label
# - app: [SERVICE-NAME]          ← ServiceMonitor selector requirement
# - component: [SERVICE-TYPE]    ← Zusätzliche kategorisierung
#
patches:
  # 🎯 KAFKA BROKERS SERVICE LABELING (CRITICAL für Dashboard Data!)
  - target:
      kind: Service
      name: my-cluster-kafka-brokers
    patch: |-
      - op: add
        path: /metadata/labels/app
        value: kafka
      - op: add
        path: /metadata/labels/component
        value: kafka-broker
      - op: add
        path: /metadata/labels/release
        value: prometheus-operator

  # 🔧 KAFKA EXPORTER SERVICE SELECTOR FIX - Override commonLabels selector pollution
  - target:
      kind: Service
      name: kafka-exporter-metrics
    patch: |-
      - op: replace
        path: /spec/selector
        value:
          strimzi.io/cluster: my-cluster
          strimzi.io/name: my-cluster-kafka-exporter

patchesStrategicMerge:
  # 🔧 Fix service selectors for Strimzi-generated pods (Enterprise vs Operator conflict)
  - kafka-service-selector-fix.yaml


helmCharts:
  - name: strimzi-kafka-operator
    repo: https://strimzi.io/charts/
    version: 0.47.0
    releaseName: strimzi-kafka-operator
    namespace: kafka
    includeCRDs: true
    valuesFile: strimzi-values.yaml
