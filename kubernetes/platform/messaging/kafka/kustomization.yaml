apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# ğŸŒŠ Sync Wave 12: Enterprise Messaging Platform (Kafka with Strimzi)
commonAnnotations:
  argocd.argoproj.io/sync-wave: "12"

namespace: kafka

# ğŸ¢ Enterprise Service Ownership
commonLabels:
  app.kubernetes.io/managed-by: argocd
  app.kubernetes.io/part-of: timour-homelab
  app.kubernetes.io/component: messaging-platform
  team: timour
  service-owner: timour
  service-tier: platform

resources:
  - namespace.yaml
  - kafka-metrics-config.yaml
  # Kafka Custom Resources - now enabled after operator deployment
  - kafka-cluster.yaml
  - kafka-topic.yaml
  # ğŸ¯ MONITORING: ServiceMonitors moved to infrastructure/monitoring/servicemonitors/ (Vegarn pattern)
  - kafka-exporter-service.yaml  # âœ… CORRECTED Service with proper selector for Kafka Exporter metrics
  - kafka-exporter-vmservicescrape.yaml  # VictoriaMetrics scraping config

# ğŸš¨ CRITICAL INFRASTRUCTURE AS CODE: Service Labeling fÃ¼r Grafana Dashboard Discovery
# ===================================================================================
#
# ğŸ¯ PROBLEM: Kafka Services haben NICHT die Labels die ServiceMonitor braucht!
# ğŸ¯ LÃ–SUNG: Kustomize patches fÃ¼gen automatisch die CRITICAL labels hinzu!
#
# ğŸ”§ WAS PASSIERT:
# 1. Strimzi Kafka Operator erstellt "my-cluster-kafka-brokers" service
# 2. Service hat NUR: app.kubernetes.io/name=kafka, strimzi.io/cluster=my-cluster
# 3. ServiceMonitor sucht: app=kafka, component=kafka-broker, release=prometheus-operator
# 4. MISMATCH = keine metrics in Grafana! ğŸ˜­
# 5. Diese patches fÃ¼gen fehlende labels AUTOMATISCH hinzu! ğŸ‰
#
# ğŸ›ï¸ RULE: JEDER Service der in Grafana sichtbar sein soll MUSS haben:
# - release: prometheus-operator  â† Prometheus entdeckt nur Services mit diesem label
# - app: [SERVICE-NAME]          â† ServiceMonitor selector requirement
# - component: [SERVICE-TYPE]    â† ZusÃ¤tzliche kategorisierung
#
patches:
  # ğŸ¯ KAFKA BROKERS SERVICE LABELING (CRITICAL fÃ¼r Dashboard Data!)
  - target:
      kind: Service
      name: my-cluster-kafka-brokers
    patch: |-
      - op: add
        path: /metadata/labels/app
        value: kafka
      - op: add
        path: /metadata/labels/component
        value: kafka-broker
      - op: add
        path: /metadata/labels/release
        value: prometheus-operator

  # ğŸ”§ KAFKA EXPORTER SERVICE SELECTOR FIX - Override commonLabels selector pollution
  - target:
      kind: Service
      name: kafka-exporter-metrics
    patch: |-
      - op: replace
        path: /spec/selector
        value:
          strimzi.io/cluster: my-cluster
          strimzi.io/name: my-cluster-kafka-exporter

patchesStrategicMerge:
  # ğŸ”§ Fix service selectors for Strimzi-generated pods (Enterprise vs Operator conflict)
  - kafka-service-selector-fix.yaml


helmCharts:
  - name: strimzi-kafka-operator
    repo: https://strimzi.io/charts/
    version: 0.47.0
    releaseName: strimzi-kafka-operator
    namespace: kafka
    includeCRDs: true
    valuesFile: strimzi-values.yaml
