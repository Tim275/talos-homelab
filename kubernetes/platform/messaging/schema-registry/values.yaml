# Schema Registry Configuration for Kafka Cluster
# Image: Confluent official (Bitnami discontinued free images Aug 2025)

# ðŸš¨ CRITICAL: Allow non-Bitnami images (Bitnami's security check blocks Confluent)
global:
  security:
    allowInsecureImages: true  # Required because Bitnami free images are dead

# Image configuration - Confluent official cp-schema-registry
image:
  registry: docker.io
  repository: confluentinc/cp-schema-registry
  tag: "8.0.2"  # ðŸš€ Official Confluent image (Bitnami images no longer exist)

# Override command - Confluent image has different entrypoint than Bitnami
command:
  - /etc/confluent/docker/run
args: []

# Disable built-in Kafka (we use external Strimzi cluster)
kafka:
  enabled: false

# Authentication configuration
auth:
  protocol: {}

# Service configuration
service:
  ports:
    client: {}

# External Kafka connection (Strimzi cluster)
externalKafka:
  brokers:
    - PLAINTEXT://my-cluster-kafka-bootstrap:9092

# Environment variables for Confluent Schema Registry
extraEnvVars:
  - name: SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS
    value: "PLAINTEXT://my-cluster-kafka-bootstrap:9092"
  - name: SCHEMA_REGISTRY_HOST_NAME
    valueFrom:
      fieldRef:
        fieldPath: metadata.name
  - name: SCHEMA_REGISTRY_LISTENERS
    value: "http://0.0.0.0:8081"

# Resource limits for homelab environment
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m
    memory: 256Mi

# Persistent storage using Rook Ceph
persistence:
  enabled: true
  storageClass: "rook-ceph-block-enterprise"
  size: 2Gi

# Pod disruption budget
podDisruptionBudget:
  create: true
  minAvailable: 1

# Health checks
livenessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

readinessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

# Security context (adjusted for Confluent image - uses appuser UID 1000)
podSecurityContext:
  enabled: true
  fsGroup: 1000
  runAsUser: 1000
  runAsNonRoot: true

# Network policies (optional)
networkPolicy:
  enabled: false
