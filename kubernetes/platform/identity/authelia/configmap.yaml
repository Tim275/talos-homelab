apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-config
  namespace: authelia
data:
  configuration.yaml: |
    # Authelia Minimal Configuration
    # Resource-optimized for homelab

    theme: light

    server:
      address: tcp://0.0.0.0:9091
      buffers:
        read: 4096
        write: 4096

    log:
      level: info
      format: text

    totp:
      issuer: homelab.local
      period: 30
      skew: 1

    # LLDAP Backend Configuration
    authentication_backend:
      ldap:
        address: ldap://lldap-ldap.lldap.svc.cluster.local:389
        timeout: 5s
        start_tls: false
        base_dn: dc=homelab,dc=local
        attributes:
          username: uid
          group_name: cn
          mail: mail
          display_name: displayName
        additional_users_dn: ou=people
        users_filter: (&({username_attribute}={input})(objectClass=person))
        additional_groups_dn: ou=groups
        groups_filter: (&(member={dn})(objectClass=groupOfNames))
        user: uid=admin,ou=people,dc=homelab,dc=local
        # Password from secret

    # Session Configuration
    session:
      name: authelia_session
      same_site: lax
      secret: # From secret
      expiration: 1h
      inactivity: 5m
      remember_me: 1M
      cookies:
        - domain: homelab.local
          authelia_url: https://auth.homelab.local
          default_redirection_url: https://homelab.local

    # Storage Configuration (SQLite for minimal resources)
    storage:
      local:
        path: /data/db.sqlite3

    # Access Control (Basic)
    access_control:
      default_policy: deny
      rules:
        # Admin access
        - domain: "*.homelab.local"
          policy: two_factor
          subject:
            - "group:cluster-admins"

        # Developer access
        - domain: "*.homelab.local"
          policy: one_factor
          subject:
            - "group:developers"

    # Regulation (Brute-force protection)
    regulation:
      max_retries: 5
      find_time: 10m
      ban_time: 12h

    # Notifier (File-based for now, can add SMTP later)
    notifier:
      disable_startup_check: true
      filesystem:
        filename: /data/notification.txt

    # No identity providers for now - just basic web authentication