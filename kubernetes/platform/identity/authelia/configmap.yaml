apiVersion: v1
kind: ConfigMap
metadata:
  name: authelia-config
  namespace: authelia
data:
  configuration.yaml: |
    # Authelia Minimal Configuration
    # Resource-optimized for homelab

    theme: light

    server:
      address: tcp://0.0.0.0:9091
      buffers:
        read: 4096
        write: 4096

    log:
      level: info
      format: text

    totp:
      issuer: homelab.local
      period: 30
      skew: 1

    # LLDAP Backend Configuration
    authentication_backend:
      ldap:
        address: ldap://lldap-ldap.lldap.svc.cluster.local:389
        timeout: 5s
        start_tls: false
        base_dn: dc=homelab,dc=local
        attributes:
          username: uid
          group_name: cn
          mail: mail
          display_name: displayName
        additional_users_dn: ou=people
        users_filter: (&({username_attribute}={input})(objectClass=person))
        additional_groups_dn: ou=groups
        groups_filter: (&(member={dn})(objectClass=groupOfNames))
        user: uid=admin,ou=people,dc=homelab,dc=local
        # Password from secret

    # Session Configuration (File-based for homelab simplicity)
    session:
      name: authelia_session
      same_site: lax
      secret: # From secret
      expiration: 1h
      inactivity: 5m
      remember_me: 1M
      cookies:
        - domain: homelab.local
          authelia_url: https://auth.homelab.local
          default_redirection_url: https://homelab.local

    # Storage Configuration (SQLite for minimal resources)
    storage:
      local:
        path: /data/db.sqlite3

    # Access Control (Basic)
    access_control:
      default_policy: deny
      rules:
        # Admin access
        - domain: "*.homelab.local"
          policy: two_factor
          subject:
            - "group:cluster-admins"

        # Developer access
        - domain: "*.homelab.local"
          policy: one_factor
          subject:
            - "group:developers"

    # Regulation (Brute-force protection)
    regulation:
      max_retries: 5
      find_time: 10m
      ban_time: 12h

    # Notifier (File-based for now, can add SMTP later)
    notifier:
      disable_startup_check: true
      filesystem:
        filename: /data/notification.txt

    # OIDC Provider Configuration (Enterprise SSO)
    identity_providers:
      oidc:
        hmac_secret: # From secret via env var
        issuer_private_key: # From secret via env var (cert-manager RSA key)
        access_token_lifespan: 1h
        authorize_code_lifespan: 1m
        id_token_lifespan: 1h
        refresh_token_lifespan: 90m
        enable_client_debug_messages: false
        enforce_pkce: public_clients_only
        cors:
          endpoints:
            - authorization
            - token
            - revocation
            - introspection
            - userinfo
          allowed_origins_from_client_redirect_uris: true

        clients:
          # üîê Kubernetes API Server OIDC Client (PRIMARY!)
          # OPTIONAL: OpenID Connect integration for kubectl authentication
          # Replaces X.509 client certificates with OIDC tokens
          # Requires: talosctl patch with kube-apiserver OIDC flags
          - id: kubernetes
            description: Kubernetes API Server Authentication
            secret: Dl8iWXZ4Rj6rZ8b2GYQxrbRZvwMBQkn/ONg05wusD5c=
            public: false
            authorization_policy: two_factor  # MFA required for cluster access
            redirect_uris:
              - http://localhost:8000
              - http://localhost:18000
            scopes:
              - openid
              - profile
              - groups
              - email
            userinfo_signing_algorithm: none

          # ArgoCD OIDC Client (SIMPLE - groups only!)
          - id: argocd
            description: ArgoCD GitOps Platform
            secret: argocd-oidc-secret-placeholder-change-me
            public: false
            authorization_policy: two_factor
            redirect_uris:
              - https://argocd.homelab.local/auth/callback
            scopes:
              - openid
              - profile
              - groups
              - email
            userinfo_signing_algorithm: none

          # Grafana OIDC Client (SIMPLE - groups only!)
          - id: grafana
            description: Grafana Monitoring Dashboard
            secret: Ta4mFsoBZ1Popbp0r0i6cNML39eB7kvtETl5OgIHWYc=
            public: false
            authorization_policy: two_factor
            redirect_uris:
              - https://grafana.homelab.local/login/generic_oauth
            scopes:
              - openid
              - profile
              - groups
              - email
            userinfo_signing_algorithm: none

          # N8N OIDC Client (SIMPLE - groups only!)
          - id: n8n
            description: N8N Workflow Automation
            secret: n8n-oidc-secret-placeholder-change-me
            public: false
            authorization_policy: one_factor
            redirect_uris:
              - https://n8n.homelab.local/rest/oauth2-credential/callback
            scopes:
              - openid
              - profile
              - email
            userinfo_signing_algorithm: none

          # Nextcloud OIDC Client (for future)
          # - id: nextcloud
          #   description: Nextcloud File Storage
          #   secret: # Will be generated separately
          #   public: false
          #   authorization_policy: one_factor
          #   redirect_uris:
          #     - https://cloud.homelab.local/apps/oidc_login/oidc
          #   scopes:
          #     - openid
          #     - profile
          #     - email
