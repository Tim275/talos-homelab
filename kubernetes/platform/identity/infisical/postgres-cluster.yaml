---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: infisical-postgres
  namespace: infisical
spec:
  instances: 1  # Minimal config - single instance
  imageName: ghcr.io/cloudnative-pg/postgresql:17.2

  primaryUpdateStrategy: unsupervised

  postgresql:
    parameters:
      max_connections: "100"
      shared_buffers: "256MB"
      effective_cache_size: "1GB"
      maintenance_work_mem: "64MB"
      checkpoint_completion_target: "0.9"
      wal_buffers: "16MB"
      default_statistics_target: "100"
      random_page_cost: "1.1"
      effective_io_concurrency: "200"
      work_mem: "2621kB"
      min_wal_size: "1GB"
      max_wal_size: "4GB"

  bootstrap:
    initdb:
      database: infisical
      owner: infisical
      # secret:
      #   name: infisical-postgres-credentials
      # CloudNativePG will auto-generate credentials if not specified

  storage:
    storageClass: rook-ceph-block-ssd
    size: 5Gi

  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  # ðŸ“Š Monitoring Configuration (Prometheus Operator PodMonitor)
  monitoring:
    enablePodMonitor: true
    customQueriesConfigMap:
      - name: cnpg-default-monitoring
        key: queries
    disableDefaultQueries: false

  # backup:
  #   retentionPolicy: "15d"
  #   barmanObjectStore:
  #     destinationPath: s3://postgresql-backups/infisical
  #     endpointURL: http://rook-ceph-rgw-ceph-objectstore.rook-ceph.svc:80
  #     s3Credentials:
  #       accessKeyId:
  #         name: infisical-postgres-s3
  #         key: ACCESS_KEY_ID
  #       secretAccessKey:
  #         name: infisical-postgres-s3
  #         key: SECRET_ACCESS_KEY
  #     wal:
  #       compression: gzip
  #       maxParallel: 2
  #     data:
  #       compression: gzip
  #       immediateCheckpoint: true
  #       jobs: 2
