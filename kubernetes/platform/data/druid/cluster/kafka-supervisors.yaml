---
# Druid Kafka Supervisors - Real-time Ingestion from Kafka
# These supervisors consume from Kafka topics and create Druid datasources
apiVersion: batch/v1
kind: Job
metadata:
  name: druid-kafka-supervisors-setup
  namespace: druid
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: druid-kafka-supervisors
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-druid
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for Druid Coordinator..."
              for i in $(seq 1 60); do
                if wget -qO- http://druid-coordinator:8081/status/health 2>/dev/null | grep -q true; then
                  echo "Druid Coordinator is ready!"
                  sleep 10
                  exit 0
                fi
                echo "Attempt $i/60: Druid not ready, waiting 5s..."
                sleep 5
              done
              echo "ERROR: Druid not ready after 5 minutes"
              exit 1
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
      containers:
        - name: setup
          image: curlimages/curl:8.5.0
          command:
            - /bin/sh
            - -c
            - |
              set -e

              DRUID_URL="http://druid-router:8888"
              KAFKA_BOOTSTRAP="my-cluster-kafka-bootstrap.kafka.svc:9092"

              echo "============================================"
              echo "Druid Kafka Supervisors Setup"
              echo "============================================"

              # Function to create or update supervisor
              create_supervisor() {
                local name=$1
                local spec=$2

                echo ""
                echo "=== Creating Supervisor: $name ==="

                # Check if supervisor exists
                existing=$(curl -s "$DRUID_URL/druid/indexer/v1/supervisor/$name" | grep -c "id" || echo "0")

                if [ "$existing" != "0" ]; then
                  echo "Supervisor $name already exists, updating..."
                fi

                # Create/Update supervisor
                response=$(curl -s -X POST "$DRUID_URL/druid/indexer/v1/supervisor" \
                  -H "Content-Type: application/json" \
                  -d "$spec")

                echo "Response: $response"
              }

              echo ""
              echo "=== Creating Orders Supervisor ==="
              create_supervisor "orders-kafka" '{
                "type": "kafka",
                "spec": {
                  "ioConfig": {
                    "type": "kafka",
                    "consumerProperties": {
                      "bootstrap.servers": "'"$KAFKA_BOOTSTRAP"'"
                    },
                    "topic": "orders",
                    "inputFormat": {
                      "type": "json"
                    },
                    "useEarliestOffset": true
                  },
                  "tuningConfig": {
                    "type": "kafka",
                    "maxRowsPerSegment": 5000000,
                    "maxRowsInMemory": 100000
                  },
                  "dataSchema": {
                    "dataSource": "orders",
                    "timestampSpec": {
                      "column": "timestamp",
                      "format": "auto"
                    },
                    "dimensionsSpec": {
                      "dimensions": [
                        "orderId",
                        "customerId",
                        "productId",
                        "status",
                        {"name": "quantity", "type": "long"},
                        {"name": "price", "type": "double"},
                        {"name": "totalAmount", "type": "double"}
                      ]
                    },
                    "granularitySpec": {
                      "queryGranularity": "minute",
                      "rollup": false,
                      "segmentGranularity": "hour"
                    }
                  }
                }
              }'

              echo ""
              echo "=== Creating Payments Supervisor ==="
              create_supervisor "payments-kafka" '{
                "type": "kafka",
                "spec": {
                  "ioConfig": {
                    "type": "kafka",
                    "consumerProperties": {
                      "bootstrap.servers": "'"$KAFKA_BOOTSTRAP"'"
                    },
                    "topic": "payments",
                    "inputFormat": {
                      "type": "json"
                    },
                    "useEarliestOffset": true
                  },
                  "tuningConfig": {
                    "type": "kafka",
                    "maxRowsPerSegment": 5000000,
                    "maxRowsInMemory": 100000
                  },
                  "dataSchema": {
                    "dataSource": "payments",
                    "timestampSpec": {
                      "column": "timestamp",
                      "format": "auto"
                    },
                    "dimensionsSpec": {
                      "dimensions": [
                        "paymentId",
                        "orderId",
                        "customerId",
                        "status",
                        "paymentMethod",
                        {"name": "amount", "type": "double"}
                      ]
                    },
                    "granularitySpec": {
                      "queryGranularity": "minute",
                      "rollup": false,
                      "segmentGranularity": "hour"
                    }
                  }
                }
              }'

              echo ""
              echo "=== Creating Stock Supervisor ==="
              create_supervisor "stock-kafka" '{
                "type": "kafka",
                "spec": {
                  "ioConfig": {
                    "type": "kafka",
                    "consumerProperties": {
                      "bootstrap.servers": "'"$KAFKA_BOOTSTRAP"'"
                    },
                    "topic": "stock",
                    "inputFormat": {
                      "type": "json"
                    },
                    "useEarliestOffset": true
                  },
                  "tuningConfig": {
                    "type": "kafka",
                    "maxRowsPerSegment": 5000000,
                    "maxRowsInMemory": 100000
                  },
                  "dataSchema": {
                    "dataSource": "stock",
                    "timestampSpec": {
                      "column": "timestamp",
                      "format": "auto"
                    },
                    "dimensionsSpec": {
                      "dimensions": [
                        "stockId",
                        "orderId",
                        "productId",
                        "warehouseId",
                        "status",
                        {"name": "quantity", "type": "long"},
                        {"name": "availableStock", "type": "long"}
                      ]
                    },
                    "granularitySpec": {
                      "queryGranularity": "minute",
                      "rollup": false,
                      "segmentGranularity": "hour"
                    }
                  }
                }
              }'

              echo ""
              echo "============================================"
              echo "Verifying Supervisors..."
              echo "============================================"

              sleep 5

              echo ""
              echo "Active Supervisors:"
              curl -s "$DRUID_URL/druid/indexer/v1/supervisor" | tr ',' '\n'

              echo ""
              echo ""
              echo "============================================"
              echo "Kafka Supervisors Setup Complete!"
              echo "============================================"
              echo ""
              echo "Datasources created:"
              echo "  - orders    (from Kafka topic: orders)"
              echo "  - payments  (from Kafka topic: payments)"
              echo "  - stock     (from Kafka topic: stock)"
              echo ""
              echo "View in Druid UI: https://druid.timourhomelab.org"
              echo "  -> Supervisors tab"
              echo "  -> Datasources tab (after data arrives)"
              echo "============================================"
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 200m
              memory: 128Mi
