# Druid mTLS Configuration
# Converts PEM certificates to JKS keystores for Java applications
---
# ConfigMap with TLS conversion script
apiVersion: v1
kind: ConfigMap
metadata:
  name: druid-tls-init-script
  namespace: druid
data:
  init-tls.sh: |
    #!/bin/bash
    set -e

    echo "=== Druid TLS Init Container ==="
    echo "Converting PEM certificates to JKS keystores..."

    TLS_DIR="/opt/druid/tls"
    KEYSTORE_PASS="${KEYSTORE_PASSWORD:-changeit}"

    mkdir -p $TLS_DIR

    # Create PKCS12 from PEM
    echo "Creating PKCS12 keystore..."
    openssl pkcs12 -export \
      -in /certs/tls.crt \
      -inkey /certs/tls.key \
      -out $TLS_DIR/keystore.p12 \
      -name druid \
      -passout pass:$KEYSTORE_PASS

    # Convert PKCS12 to JKS
    echo "Converting to JKS..."
    keytool -importkeystore \
      -srckeystore $TLS_DIR/keystore.p12 \
      -srcstoretype PKCS12 \
      -srcstorepass $KEYSTORE_PASS \
      -destkeystore $TLS_DIR/keystore.jks \
      -deststoretype JKS \
      -deststorepass $KEYSTORE_PASS \
      -noprompt

    # Create truststore with CA certificate
    echo "Creating truststore with CA..."
    keytool -import \
      -file /ca-certs/ca.crt \
      -alias druid-ca \
      -keystore $TLS_DIR/truststore.jks \
      -storepass $KEYSTORE_PASS \
      -noprompt

    # Set permissions
    chmod 644 $TLS_DIR/*.jks $TLS_DIR/*.p12

    echo "TLS initialization complete!"
    ls -la $TLS_DIR/
---
# Secret for keystore password
apiVersion: v1
kind: Secret
metadata:
  name: druid-tls-password
  namespace: druid
type: Opaque
stringData:
  KEYSTORE_PASSWORD: "druid-tls-2026"
  TRUSTSTORE_PASSWORD: "druid-tls-2026"
