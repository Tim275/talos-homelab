# Druid Internal mTLS Certificates
# Enterprise Best Practice: All internal communication encrypted
# PKCS12 keystores generated by cert-manager for direct use by Druid
---
# Self-signed CA for Druid internal mTLS
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: druid-internal-ca
  namespace: druid
spec:
  isCA: true
  commonName: druid-internal-ca
  secretName: druid-internal-ca-secret
  duration: 87600h # 10 years
  renewBefore: 720h # 30 days
  privateKey:
    algorithm: ECDSA
    size: 256
  issuerRef:
    name: selfsigned-cluster-issuer
    kind: ClusterIssuer
    group: cert-manager.io
---
# Issuer using the internal CA
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: druid-internal-issuer
  namespace: druid
spec:
  ca:
    secretName: druid-internal-ca-secret
---
# Coordinator/Overlord certificate with PKCS12 keystore
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: druid-coordinator-tls
  namespace: druid
spec:
  secretName: druid-coordinator-tls
  duration: 8760h # 1 year
  renewBefore: 720h
  privateKey:
    algorithm: ECDSA
    size: 256
  keystores:
    pkcs12:
      create: true
      passwordSecretRef:
        name: druid-keystore-password
        key: password
  usages:
    - server auth
    - client auth
  dnsNames:
    - druid-coordinator
    - druid-coordinator.druid.svc
    - druid-coordinator.druid.svc.cluster.local
    - druid-coordinator-0
    - druid-coordinator-0.druid-coordinator-headless.druid.svc.cluster.local
    - localhost
  issuerRef:
    name: druid-internal-issuer
    kind: Issuer
---
# Broker certificate with PKCS12 keystore
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: druid-broker-tls
  namespace: druid
spec:
  secretName: druid-broker-tls
  duration: 8760h
  renewBefore: 720h
  privateKey:
    algorithm: ECDSA
    size: 256
  keystores:
    pkcs12:
      create: true
      passwordSecretRef:
        name: druid-keystore-password
        key: password
  usages:
    - server auth
    - client auth
  dnsNames:
    - druid-broker
    - druid-broker.druid.svc
    - druid-broker.druid.svc.cluster.local
    - druid-broker-0
    - druid-broker-0.druid-broker-headless.druid.svc.cluster.local
    - localhost
  issuerRef:
    name: druid-internal-issuer
    kind: Issuer
---
# Historical certificate with PKCS12 keystore
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: druid-historical-tls
  namespace: druid
spec:
  secretName: druid-historical-tls
  duration: 8760h
  renewBefore: 720h
  privateKey:
    algorithm: ECDSA
    size: 256
  keystores:
    pkcs12:
      create: true
      passwordSecretRef:
        name: druid-keystore-password
        key: password
  usages:
    - server auth
    - client auth
  dnsNames:
    - druid-historical-default
    - druid-historical-default.druid.svc
    - druid-historical-default.druid.svc.cluster.local
    - druid-historical-default-0
    - druid-historical-default-0.druid-historical-default-headless.druid.svc.cluster.local
    - localhost
  issuerRef:
    name: druid-internal-issuer
    kind: Issuer
---
# Indexer/MiddleManager certificate with PKCS12 keystore
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: druid-indexer-tls
  namespace: druid
spec:
  secretName: druid-indexer-tls
  duration: 8760h
  renewBefore: 720h
  privateKey:
    algorithm: ECDSA
    size: 256
  keystores:
    pkcs12:
      create: true
      passwordSecretRef:
        name: druid-keystore-password
        key: password
  usages:
    - server auth
    - client auth
  dnsNames:
    - druid-indexer-default
    - druid-indexer-default.druid.svc
    - druid-indexer-default.druid.svc.cluster.local
    - druid-indexer-default-0
    - druid-indexer-default-0.druid-indexer-default-headless.druid.svc.cluster.local
    - localhost
  issuerRef:
    name: druid-internal-issuer
    kind: Issuer
---
# Router certificate with PKCS12 keystore
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: druid-router-tls
  namespace: druid
spec:
  secretName: druid-router-tls
  duration: 8760h
  renewBefore: 720h
  privateKey:
    algorithm: ECDSA
    size: 256
  keystores:
    pkcs12:
      create: true
      passwordSecretRef:
        name: druid-keystore-password
        key: password
  usages:
    - server auth
    - client auth
  dnsNames:
    - druid-router
    - druid-router.druid.svc
    - druid-router.druid.svc.cluster.local
    - druid-router-0
    - druid-router-0.druid-router-headless.druid.svc.cluster.local
    - localhost
  issuerRef:
    name: druid-internal-issuer
    kind: Issuer
