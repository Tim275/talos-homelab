# Druid Audit Logging Configuration
# Enterprise Best Practice: Track all API access and modifications
---
# ConfigMap for Druid audit log configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: druid-audit-config
  namespace: druid
data:
  # Audit log format (JSON for structured logging)
  audit-log-format: "json"
  # Log4j2 configuration for audit logging
  log4j2-audit.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <Configuration status="WARN">
      <Appenders>
        <!-- Console appender for stdout (collected by Kubernetes) -->
        <Console name="Console" target="SYSTEM_OUT">
          <PatternLayout pattern="%d{ISO8601} %p [%t] %c - %m%n"/>
        </Console>

        <!-- Audit log appender - separate file for compliance -->
        <RollingFile name="AuditLog"
                     fileName="/opt/druid/var/log/druid/audit.log"
                     filePattern="/opt/druid/var/log/druid/audit-%d{yyyy-MM-dd}-%i.log.gz">
          <JsonLayout complete="false" compact="true" eventEol="true">
            <KeyValuePair key="service" value="druid"/>
            <KeyValuePair key="environment" value="homelab"/>
          </JsonLayout>
          <Policies>
            <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
            <SizeBasedTriggeringPolicy size="100MB"/>
          </Policies>
          <DefaultRolloverStrategy max="30"/>
        </RollingFile>
      </Appenders>

      <Loggers>
        <!-- Audit logger for request/response logging -->
        <Logger name="org.apache.druid.server.security.Authenticator" level="INFO" additivity="false">
          <AppenderRef ref="AuditLog"/>
          <AppenderRef ref="Console"/>
        </Logger>

        <!-- Query audit logging -->
        <Logger name="org.apache.druid.server.QueryResource" level="INFO" additivity="false">
          <AppenderRef ref="AuditLog"/>
          <AppenderRef ref="Console"/>
        </Logger>

        <!-- Supervisor changes audit -->
        <Logger name="org.apache.druid.indexing.overlord.supervisor" level="INFO" additivity="false">
          <AppenderRef ref="AuditLog"/>
          <AppenderRef ref="Console"/>
        </Logger>

        <!-- Task lifecycle audit -->
        <Logger name="org.apache.druid.indexing.overlord.TaskQueue" level="INFO" additivity="false">
          <AppenderRef ref="AuditLog"/>
          <AppenderRef ref="Console"/>
        </Logger>

        <Root level="INFO">
          <AppenderRef ref="Console"/>
        </Root>
      </Loggers>
    </Configuration>
---
# PrometheusRule for audit alerts
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: druid-audit-alerts
  namespace: druid
  labels:
    app.kubernetes.io/name: druid
    prometheus: kube-prometheus
    release: prometheus
spec:
  groups:
    - name: druid-audit
      rules:
        # Alert on unusual query patterns
        - alert: DruidHighQueryRateFromSingleSource
          expr: |
            sum by (source) (rate(druid_query_count[5m])) > 100
          for: 5m
          labels:
            severity: warning
            category: audit
          annotations:
            summary: "High query rate from single source"
            description: "Source {{ $labels.source }} is generating {{ $value }} queries/sec"

        # Alert on failed authentication attempts
        - alert: DruidAuthenticationFailures
          expr: |
            sum(rate(druid_security_authentication_failure_total[5m])) > 0.1
          for: 2m
          labels:
            severity: warning
            category: security
          annotations:
            summary: "Druid authentication failures detected"
            description: "{{ $value }} auth failures per second"

        # Alert on supervisor modifications
        - alert: DruidSupervisorModified
          expr: |
            changes(druid_supervisor_status[5m]) > 0
          labels:
            severity: info
            category: audit
          annotations:
            summary: "Druid supervisor configuration changed"
            description: "Supervisor {{ $labels.dataSource }} was modified"
---
# Fluentbit config for shipping audit logs (if Fluentbit is installed)
apiVersion: v1
kind: ConfigMap
metadata:
  name: druid-fluentbit-config
  namespace: druid
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         5
        Log_Level     info
        Daemon        off
        Parsers_File  parsers.conf

    [INPUT]
        Name              tail
        Path              /opt/druid/var/log/druid/audit.log
        Parser            json
        Tag               druid.audit
        Refresh_Interval  10
        Mem_Buf_Limit     5MB

    [OUTPUT]
        Name              stdout
        Match             druid.*
        Format            json_lines

    # Uncomment to send to Loki
    # [OUTPUT]
    #     Name              loki
    #     Match             druid.*
    #     Host              loki.monitoring.svc
    #     Port              3100
    #     Labels            job=druid,component=audit

  parsers.conf: |
    [PARSER]
        Name        json
        Format      json
        Time_Key    timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%L
