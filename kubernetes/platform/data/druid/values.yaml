# Druid Helm Chart - Minimal Working Config
image:
  repository: apache/druid
  tag: "30.0.1"

# ZooKeeper
zookeeper:
  enabled: true
  replicaCount: 1
  image:
    registry: docker.io
    repository: bitnamilegacy/zookeeper
    tag: "3.8.4-debian-12-r0"
  persistence:
    enabled: true
    storageClass: rook-ceph-block-enterprise
    size: 2Gi

# Disable built-in PostgreSQL (use CNPG)
postgresql:
  enabled: false

# External metadata
metadataStore:
  type: postgresql
  host: druid-postgres-rw.druid.svc
  port: 5432
  user: druid
  password: druid-metadata-2026

# Deep storage
deepStorage:
  type: local

# Common config for all services
env:
  - name: druid_extensions_loadList
    value: '["postgresql-metadata-storage", "druid-kafka-indexing-service", "druid-datasketches"]'

# Extensions
configVars:
  druid_extensions_loadList: '["postgresql-metadata-storage", "druid-kafka-indexing-service", "druid-datasketches"]'
  druid_storage_type: local
  druid_storage_storageDirectory: /opt/druid/var/druid/segments

# Coordinator
coordinator:
  replicaCount: 1
  resources:
    requests:
      cpu: 100m
      memory: 768Mi
    limits:
      cpu: 500m
      memory: 1536Mi
  persistence:
    enabled: true
    storageClass: rook-ceph-block-enterprise
    size: 5Gi
  envVars:
    DRUID_XMX: 512m
    DRUID_XMS: 512m
    DRUID_MAXDIRECTMEMORYSIZE: 200m
    druid_coordinator_asOverlord_enabled: "true"
    druid_coordinator_asOverlord_overlordService: druid/overlord

# Broker
broker:
  replicaCount: 1
  resources:
    requests:
      cpu: 100m
      memory: 768Mi
    limits:
      cpu: 500m
      memory: 1536Mi
  envVars:
    DRUID_XMX: 384m
    DRUID_XMS: 384m
    DRUID_MAXDIRECTMEMORYSIZE: 400m
    druid_processing_buffer_sizeBytes: "50000000"
    druid_processing_numMergeBuffers: "2"
    druid_processing_numThreads: "1"

# Historical
historical:
  tiers:
    default:
      envVars:
        DRUID_XMX: 384m
        DRUID_XMS: 384m
        DRUID_MAXDIRECTMEMORYSIZE: 400m
        druid_processing_buffer_sizeBytes: "50000000"
        druid_processing_numMergeBuffers: "2"
        druid_processing_numThreads: "1"
        druid_server_tier: "tier_default"
        druid_segmentCache_locations: '[{"path":"/opt/druid/var/druid/segment-cache","maxSize":"1GiB"}]'
      resources:
        requests:
          cpu: 100m
          memory: 768Mi
        limits:
          cpu: 500m
          memory: 1536Mi
      persistence:
        size: 10Gi
        storageClass: rook-ceph-block-enterprise

# MiddleManager for Kafka ingestion tasks
middleManager:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  envVars:
    DRUID_XMX: 256m
    DRUID_XMS: 256m
    DRUID_MAXDIRECTMEMORYSIZE: 256m
    druid_indexer_runner_javaOptsArray: '["-server", "-Xmx512m", "-Xms512m", "-XX:MaxDirectMemorySize=256m"]'
    druid_indexer_fork_property_druid_processing_buffer_sizeBytes: "50000000"
  persistence:
    enabled: true
    storageClass: rook-ceph-block-enterprise
    size: 5Gi

# Disable Indexer (using MiddleManager instead)
indexer:
  enabled: false

# Router (UI)
router:
  replicaCount: 1
  resources:
    requests:
      cpu: 50m
      memory: 256Mi
    limits:
      cpu: 250m
      memory: 512Mi
  envVars:
    DRUID_XMX: 128m
    DRUID_XMS: 128m
    DRUID_MAXDIRECTMEMORYSIZE: 100m
    druid_router_managementProxy_enabled: "true"
