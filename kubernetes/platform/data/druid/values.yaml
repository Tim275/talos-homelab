# Druid Helm Chart - Enterprise Production Config (Homelab-Optimized)
# Features: mTLS, Schema Registry, OIDC-Ready, Tuned Resources
image:
  repository: apache/druid
  tag: "30.0.1"

# ZooKeeper - Single node for homelab
zookeeper:
  enabled: true
  replicaCount: 1
  image:
    registry: docker.io
    repository: bitnamilegacy/zookeeper
    tag: "3.8.4-debian-12-r0"
  persistence:
    enabled: true
    storageClass: rook-ceph-block-enterprise
    size: 2Gi
  resources:
    requests:
      cpu: 50m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# Disable built-in PostgreSQL (use CNPG)
postgresql:
  enabled: false

# External metadata store
metadataStore:
  type: postgresql
  host: druid-postgres-rw.druid.svc
  port: 5432
  user: druid
  password: druid-metadata-2026

# Deep storage - Rook-Ceph S3
deepStorage:
  type: s3

# Extensions - Enterprise stack
extensions:
  loadList:
    - druid-kafka-indexing-service
    - druid-datasketches
    - druid-multi-stage-query
    - postgresql-metadata-storage
    - druid-s3-extensions
    - prometheus-emitter
    # Security extensions
    - druid-basic-security
    # Future: druid-pac4j for OIDC

# Global config
configVars:
  # S3 Deep Storage (Rook-Ceph)
  druid_storage_type: s3
  druid_storage_bucket: druid-segments-3ba7b62e-6999-486f-a26b-7a3a8e95a4a7
  druid_storage_baseKey: segments
  druid_s3_accessKey: "$(AWS_ACCESS_KEY_ID)"
  druid_s3_secretKey: "$(AWS_SECRET_ACCESS_KEY)"
  druid_s3_endpoint_url: "http://rook-ceph-rgw-homelab-objectstore.rook-ceph.svc:80"
  druid_s3_enablePathStyleAccess: "true"
  druid_s3_protocol: "http"

  # ZooKeeper
  druid_zk_service_enabled: "true"
  druid_discovery_type: curator
  druid_serverview_type: http
  druid_coordinator_loadqueuepeon_type: http

  # Prometheus Metrics
  druid_emitter: prometheus
  druid_emitter_prometheus_port: 9090
  druid_emitter_prometheus_strategy: exporter

  # TLS/mTLS Configuration - Enterprise Best Practice
  # Keystore settings (JKS format required for Java)
  druid_server_https_keyStorePath: /opt/druid/tls/keystore.jks
  druid_server_https_keyStorePassword: druid-tls-2026
  druid_server_https_keyStoreType: jks
  druid_server_https_certAlias: druid
  # Truststore settings (for mTLS client verification)
  druid_client_https_trustStorePath: /opt/druid/tls/truststore.jks
  druid_client_https_trustStorePassword: druid-tls-2026
  druid_client_https_trustStoreType: jks
  # Enable both ports during migration, disable plaintext later
  druid_enablePlaintextPort: "true"
  druid_enableTlsPort: "true"
  # Internal client TLS
  druid_client_https_protocol: TLSv1.2

  # Schema Registry (Apicurio)
  # Supervisors will reference: http://apicurio-registry.kafka.svc:8080/apis/ccompat/v7

# Coordinator (runs Overlord) - Leadership role, needs stability
coordinator:
  replicaCount: 1
  resources:
    requests:
      cpu: 150m
      memory: 896Mi
    limits:
      cpu: 750m
      memory: 1792Mi
  persistence:
    enabled: true
    storageClass: rook-ceph-block-enterprise
    size: 5Gi
  envVars:
    DRUID_XMX: 768m
    DRUID_XMS: 768m
    DRUID_MAXDIRECTMEMORYSIZE: 256m
    druid_coordinator_asOverlord_enabled: "true"
    druid_coordinator_asOverlord_overlordService: druid/overlord
    # Coordinator tuning
    druid_coordinator_period: PT60S
    druid_coordinator_startDelay: PT30S
  extraEnvFrom:
    - secretRef:
        name: druid-deep-storage

# Broker - Query router, needs fast response
broker:
  replicaCount: 1
  resources:
    requests:
      cpu: 150m
      memory: 896Mi
    limits:
      cpu: 750m
      memory: 1792Mi
  envVars:
    DRUID_XMX: 512m
    DRUID_XMS: 512m
    DRUID_MAXDIRECTMEMORYSIZE: 512m
    # Processing tuned for homelab
    druid_processing_buffer_sizeBytes: "50000000"
    druid_processing_numMergeBuffers: "2"
    druid_processing_numThreads: "1"
    # Query tuning
    druid_broker_cache_useCache: "true"
    druid_broker_cache_populateCache: "true"
    druid_broker_http_numConnections: "5"
  extraEnvFrom:
    - secretRef:
        name: druid-deep-storage

# Historical - Segment storage, needs disk I/O
historical:
  tiers:
    default:
      replicaCount: 1
      envVars:
        DRUID_XMX: 512m
        DRUID_XMS: 512m
        DRUID_MAXDIRECTMEMORYSIZE: 512m
        druid_processing_buffer_sizeBytes: "50000000"
        druid_processing_numMergeBuffers: "2"
        druid_processing_numThreads: "1"
        druid_server_tier: "tier_default"
        druid_segmentCache_locations: '[{"path":"/opt/druid/var/druid/segment-cache","maxSize":"5GiB"}]'
        # Historical tuning
        druid_server_maxSize: 5368709120
        druid_historical_cache_useCache: "true"
      resources:
        requests:
          cpu: 150m
          memory: 1024Mi
        limits:
          cpu: 750m
          memory: 2048Mi
      persistence:
        size: 10Gi
        storageClass: rook-ceph-block-enterprise
      extraEnvFrom:
        - secretRef:
            name: druid-deep-storage

# Indexer/MiddleManager - Task execution, needs CPU for ingestion
indexer:
  enabled: true
  defaults:
    replicaCount: 1
    resources:
      requests:
        cpu: 300m
        memory: 2560Mi
      limits:
        cpu: 2000m
        memory: 4608Mi
    envVars:
      # MiddleManager JVM
      DRUID_XMX: 512m
      DRUID_XMS: 512m
      DRUID_MAXDIRECTMEMORYSIZE: 512m
      # Peon JVM - 4 concurrent tasks
      druid_indexer_runner_javaOpts: "-server -Xms384m -Xmx384m -XX:MaxDirectMemorySize=384m -XX:+ExitOnOutOfMemoryError -Duser.timezone=UTC"
      # Task processing
      druid_indexer_fork_property_druid_processing_buffer_sizeBytes: "50000000"
      druid_indexer_fork_property_druid_processing_numMergeBuffers: "2"
      druid_indexer_fork_property_druid_processing_numThreads: "1"
      # Worker capacity - 4 for 4 supervisors
      druid_worker_capacity: "4"
      # Task tuning
      druid_indexer_task_restoreTasksOnRestart: "true"
      druid_indexer_task_gracefulShutdownTimeout: PT30S
    persistence:
      enabled: true
      storageClass: rook-ceph-block-enterprise
      size: 10Gi
    extraEnvFrom:
      - secretRef:
          name: druid-deep-storage

# Router - Web console, lightweight
router:
  replicaCount: 1
  resources:
    requests:
      cpu: 50m
      memory: 256Mi
    limits:
      cpu: 300m
      memory: 512Mi
  envVars:
    DRUID_XMX: 192m
    DRUID_XMS: 192m
    DRUID_MAXDIRECTMEMORYSIZE: 128m
    druid_router_managementProxy_enabled: "true"
    druid_router_http_numConnections: "10"
    druid_router_http_readTimeout: PT5M
  extraEnvFrom:
    - secretRef:
        name: druid-deep-storage
