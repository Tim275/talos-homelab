---
# Complete Infrastructure Bootstrap
# This file deploys everything needed for GitOps infrastructure management
---
# 1. Create ArgoCD namespace
apiVersion: v1
kind: Namespace
metadata:
  name: argocd
  labels:
    dev.stonegarden: infrastructure
---
# 2. Install ArgoCD (using Kustomization to pull from upstream)
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-install
  namespace: argocd
data:
  install.yaml: |
    apiVersion: kustomize.config.k8s.io/v1beta1
    kind: Kustomization
    namespace: argocd
    resources:
      - https://raw.githubusercontent.com/argoproj/argo-cd/v2.13.2/manifests/install.yaml
---
# 3. Create app-of-apps project
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: app-of-apps
  namespace: argocd
spec:
  description: Parent project for infrastructure ApplicationSets
  sourceRepos:
    - 'https://github.com/Tim275/talos-homelab'
    - 'https://github.com/Tim275/talos-homelab.git'
  destinations:
    - namespace: '*'
      server: https://kubernetes.default.svc
  clusterResourceWhitelist:
    - group: '*'
      kind: '*'
  namespaceResourceWhitelist:
    - group: '*'
      kind: '*'
---
# 4. Root ApplicationSet for Infrastructure
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: infrastructure
  namespace: argocd
  labels:
    dev.stonegarden: infrastructure
  annotations:
    argocd.argoproj.io/sync-wave: "1"
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - list:
        elements:
          # CRDs must be applied first
          - name: crds
            path: kubernetes/crds
            syncWave: "-2"
          # Infrastructure categories
          - name: storage
            path: kubernetes/infra/storage
            syncWave: "0"
          - name: controllers
            path: kubernetes/infra/controllers
            syncWave: "1"
          - name: network
            path: kubernetes/infra/network
            syncWave: "2"
          - name: monitoring
            path: kubernetes/infra/monitoring
            syncWave: "3"
          - name: backup
            path: kubernetes/infra/backup
            syncWave: "4"
  template:
    metadata:
      name: '{{.name}}'
      namespace: argocd
      labels:
        dev.stonegarden: infrastructure
        category: '{{.name}}'
      annotations:
        argocd.argoproj.io/sync-wave: '{{.syncWave}}'
    spec:
      project: app-of-apps
      source:
        repoURL: https://github.com/Tim275/talos-homelab
        targetRevision: HEAD
        path: '{{.path}}'
      destination:
        server: https://kubernetes.default.svc
      syncPolicy:
        automated:
          selfHeal: true
          prune: true
        syncOptions:
          - CreateNamespace=true
          - ServerSideApply=true
        retry:
          limit: 5
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
      revisionHistoryLimit: 3