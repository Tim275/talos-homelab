apiVersion: v1
kind: ConfigMap
metadata:
  name: fluent-bit-config
  namespace: elastic-system
data:
  fluent-bit.conf: |
    [SERVICE]
        Daemon          false
        Flush           1
        Log_Level       info
        Parsers_File    /fluent-bit/etc/parsers.conf
        HTTP_Server     On
        HTTP_Listen     0.0.0.0
        HTTP_Port       2020
        Health_Check    On
        storage.path    /var/log/fluentbit/storage
        storage.sync    full
        storage.checksum    on
        storage.backlog.mem_limit    5M
    
    # INPUT 1: Kubernetes pod/container logs
    [INPUT]
        Name            tail
        Path            /var/log/containers/*.log
        Path_Key        filename
        multiline.parser    cri
        Tag             kube.*
        DB              /var/log/fluentbit/tail-db/flb_kube.db
        storage.type    filesystem
        Skip_Long_Lines On
    
    # INPUT 2: Talos kernel messages via kmsg (privileged access)
    [INPUT]
        Name              kmsg
        Tag               host.kernel
        
    # INPUT 3: Talos system logs via /proc/kmsg (privileged access)
    [INPUT]
        Name              tail
        Path              /host/proc/kmsg
        Path_Key          source_file
        Tag               host.talos.kernel
        DB                /var/log/fluentbit/tail-db/flb_talos_kernel.db
        storage.type      filesystem
        Parser            kmsg
        
    # INPUT 4: Talos dmesg kernel ring buffer (via file tail)
    [INPUT]
        Name            tail
        Path            /host/proc/kmsg
        Path_Key        source_file
        Tag             host.talos.dmesg
        DB              /var/log/fluentbit/tail-db/flb_dmesg.db
        storage.type    filesystem
        Parser          kmsg
        Skip_Long_Lines On
        
    # INPUT 5: Talos etcd logs (critical for cluster health)
    [INPUT]
        Name            tail
        Path            /host/var/log/etcd/*.log
        Path_Key        source_file
        Tag             host.talos.etcd
        DB              /var/log/fluentbit/tail-db/flb_etcd.db
        storage.type    filesystem
        Skip_Long_Lines On
        
    # INPUT 6: Kubernetes API server audit logs (Talos static pods)
    [INPUT]
        Name            tail
        Path            /host/var/log/audit/kube/*.log
        Path_Key        source_file
        Tag             host.talos.apiserver-audit
        DB              /var/log/fluentbit/tail-db/flb_apiserver_audit.db
        storage.type    filesystem
        Parser          json
        Skip_Long_Lines On
        
    # INPUT 7: Kubelet logs from Talos host
    [INPUT]
        Name            tail
        Path            /host/var/log/kubelet/*.log
        Path_Key        source_file
        Tag             host.talos.kubelet
        DB              /var/log/fluentbit/tail-db/flb_kubelet.db
        storage.type    filesystem
        Skip_Long_Lines On
        
    # INPUT 8: Containerd logs from Talos host
    [INPUT]
        Name            tail
        Path            /host/var/log/containerd/*.log
        Path_Key        source_file
        Tag             host.talos.containerd
        DB              /var/log/fluentbit/tail-db/flb_containerd.db
        storage.type    filesystem
        Skip_Long_Lines On
        
    # INPUT 9: Talos system service logs (if available)
    [INPUT]
        Name            tail
        Path            /host/var/log/*.log
        Path_Key        source_file
        Tag             host.talos.system
        DB              /var/log/fluentbit/tail-db/flb_talos_system.db
        storage.type    filesystem
        Skip_Long_Lines On
        
    # INPUT 10: Talos machine service logs
    [INPUT]
        Name            tail
        Path            /host/run/system/logs/*
        Path_Key        source_file
        Tag             host.talos.machine
        DB              /var/log/fluentbit/tail-db/flb_machine.db
        storage.type    filesystem
        Skip_Long_Lines On
        
    # INPUT 11: Host system journal logs (via file tail)
    [INPUT]
        Name            tail
        Path            /host/var/log/journal/*/*.journal
        Path_Key        source_file
        Tag             host.talos.systemd
        DB              /var/log/fluentbit/tail-db/flb_systemd.db
        storage.type    filesystem
        Skip_Long_Lines On
    
    # FILTER: Add Kubernetes metadata to pod logs
    [FILTER]
        Name            kubernetes
        Match           kube.*
        Buffer_Size     512k
        Kube_Tag_Prefix kube.var.log.containers.
        Merge_Log       Off
        K8S-Logging.Parser  On
        K8S-Logging.Exclude On
        Labels          On
        Annotations     Off
    
    # FILTER: Simplify Kubernetes field names
    [FILTER]
        Name        modify
        Match       kube.*
        Rename      kubernetes_pod_name pod
        Rename      kubernetes_namespace_name namespace
        Rename      kubernetes_container_name container
        Rename      kubernetes_host host
        Remove_wildcard kubernetes_
        Remove      _p
        Add         log_source pod_container
    
    # Add source identification for Talos logs
    [FILTER]
        Name        modify
        Match       host.talos.*
        Add         log_source talos
        Add         log_type host
    
    [FILTER]
        Name        modify
        Match       host.kernel
        Add         log_source talos
        Add         log_type kernel
    
    # OUTPUT: Forward everything to Fluentd (SIMPLE)
    [OUTPUT]
        Name        forward
        Match       *
        Host        fluentd.elastic-system.svc.cluster.local
        Port        24224
        storage.total_limit_size    5M
        Retry_Limit 3
  
  parsers.conf: |
    [PARSER]
        Name        syslog-rfc3164-nopri
        Format      regex
        Regex       ^(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_/.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^:]*)? *(?<log>.*)$
        Time_Key    time
        Time_Format %b %d %H:%M:%S
        Time_Keep   Off
        
    [PARSER]
        Name        kmsg
        Format      regex
        Regex       ^<(?<priority>[0-9]+)>(?<time>[^\]]+)\] (?<log>.*)$
        Time_Key    time
        Time_Format %Y-%m-%d %H:%M:%S
        Time_Keep   Off
        
    [PARSER]
        Name        json
        Format      json
        Time_Key    timestamp
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z
        Time_Keep   On