# Kyverno Policy Engine Configuration
# Helm Chart: kyverno/kyverno v3.5.2
# CNCF Incubating Project - Kubernetes-native Policy Management

# üö® CRITICAL SAFETY CONFIG - Prevents cluster-wide outages
# This config prevents the disaster that happened on 2025-10-03

admissionController:
  container:
    extraArgs:
      # üö® CRITICAL: Set failurePolicy to Ignore for all webhooks
      - --webhookFailurePolicy=Ignore
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

backgroundController:
  enabled: true
  container:
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

cleanupController:
  enabled: true
  container:
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        cpu: 200m
        memory: 128Mi

reportsController:
  enabled: true
  container:
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 200m
        memory: 256Mi

# üö® MUST-HAVE #3: Cleanup webhooks on uninstall
# Prevents stuck webhooks after Kyverno deletion
webhooksCleanup:
  enabled: true

# üîê Security Configuration
config:
  # üö® MUST-HAVE #1: failurePolicy Ignore
  # If Kyverno webhook is down, allow deployments (don't block entire cluster!)
  webhooks:
    - namespaceSelector:
        matchExpressions:
          # üö® MUST-HAVE #2: Exclude critical namespaces
          - key: kubernetes.io/metadata.name
            operator: NotIn
            values:
              - kube-system
              - kube-public
              - kube-node-lease
              - argocd
              - kyverno          # Don't block self!
              - istio-system
              - rook-ceph
              - cert-manager
              - sealed-secrets
      failurePolicy: Ignore      # CRITICAL!
      timeoutSeconds: 10

  # Don't validate these resources
  resourceFilters:
    - '[Event,*,*]'
    - '[*,kube-system,*]'
    - '[*,kube-public,*]'
    - '[*,kube-node-lease,*]'
    - '[Node,*,*]'
    - '[*,argocd,*]'
    - '[*,kyverno,*]'        # Don't validate self
  generateSuccessEvents: false

# üéØ Features
features:
  policyExceptions:
    enabled: true
  admissionReports:
    enabled: true
  backgroundScan:
    enabled: true
    backgroundScanInterval: 1h
  logging:
    format: json
    verbosity: 2

# üõ°Ô∏è Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000
  seccompProfile:
    type: RuntimeDefault

containerSecurityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 1000
  seccompProfile:
    type: RuntimeDefault
  capabilities:
    drop:
      - ALL

# üì¶ RBAC
rbac:
  create: true
  serviceAccount:
    create: true

# üîß CRDs
crds:
  install: true
