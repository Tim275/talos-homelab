apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: restrict-image-registries
  annotations:
    policies.kyverno.io/title: Restrict Image Registries
    policies.kyverno.io/category: Best Practices, Security
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Only allows container images from approved registries.
      Prevents pulling images from untrusted sources.
spec:
  background: true
  rules:
    - name: validate-registries
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - velero
                - kube-system
      validate:
        failureAction: Enforce
        message: >-
          Images must come from approved registries only:
          - ghcr.io (GitHub Container Registry)
          - quay.io (Red Hat Quay)
          - docker.io (Docker Hub - official images only)
          - registry.k8s.io (Kubernetes official registry)
          - gcr.io/distroless (Google Distroless)
        foreach:
          - list: "request.object.spec.containers"
            pattern:
              image: "ghcr.io/* | quay.io/* | docker.io/library/* | registry.k8s.io/* | gcr.io/distroless/*"
          - list: "request.object.spec.[initContainers, ephemeralContainers][]"
            pattern:
              image: "ghcr.io/* | quay.io/* | docker.io/library/* | registry.k8s.io/* | gcr.io/distroless/*"
