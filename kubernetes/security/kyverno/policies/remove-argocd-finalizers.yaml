apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: remove-argocd-finalizers
  annotations:
    policies.kyverno.io/title: Remove ArgoCD Application Finalizers
    policies.kyverno.io/category: Cleanup
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Application
    policies.kyverno.io/description: >-
      Automatically removes 'resources-finalizer.argocd.argoproj.io' from ALL Applications.
      This prevents Applications from getting stuck during deletion when managed resources
      fail to delete. Applications will be deleted immediately without waiting for
      resource cleanup.

      ⚠️ WARNING: This means deleted Applications may leave resources in the cluster!
      Use with caution in production environments.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: remove-resources-finalizer
      match:
        any:
          - resources:
              kinds:
                - Application
              namespaces:
                - argocd
      mutate:
        patchStrategicMerge:
          metadata:
            finalizers:
              - (remove): resources-finalizer.argocd.argoproj.io
