---
# Enable Kustomize+Helm support in ArgoCD
# This patches ArgoCD to support Kustomize with Helm charts
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cmd-params-cm
  namespace: argocd
data:
  # Enable Git submodules and Helm in repo-server
  reposerver.enable.git.submodule: "true" 
  # Enable Helm support
  kustomize.build.options: "--enable-helm"
  # Increase timeout for complex builds
  reposerver.git.request.timeout: "300"
---
# Ensure repo-server has Helm binary
apiVersion: apps/v1
kind: Deployment
metadata:
  name: argocd-repo-server
  namespace: argocd
spec:
  template:
    spec:
      initContainers:
      # Install Helm binary
      - name: install-helm
        image: alpine/helm:3.16.4
        command: ["/bin/sh"]
        args:
          - -c
          - |
            echo "ðŸ”§ Installing Helm for ArgoCD..."
            cp /usr/bin/helm /shared/helm
            chmod +x /shared/helm
            /shared/helm version
            echo "âœ… Helm installed successfully"
        volumeMounts:
        - name: helm-bin
          mountPath: /shared
      containers:
      - name: argocd-repo-server
        env:
        # Add Helm to PATH
        - name: PATH
          value: "/shared:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        # Helm cache directories
        - name: HELM_CACHE_HOME
          value: /tmp/helm/cache
        - name: HELM_CONFIG_HOME
          value: /tmp/helm/config
        - name: HELM_DATA_HOME
          value: /tmp/helm/data
        # Increase timeouts for complex builds
        - name: ARGOCD_EXEC_TIMEOUT
          value: "300s"
        volumeMounts:
        - name: helm-bin
          mountPath: /shared
        - name: helm-cache
          mountPath: /tmp/helm
      volumes:
      # Shared volume for Helm binary
      - name: helm-bin
        emptyDir: {}
      # Helm cache volume
      - name: helm-cache
        emptyDir: {}