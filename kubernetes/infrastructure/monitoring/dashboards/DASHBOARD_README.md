# 📊 Enterprise Grafana Dashboard Management

## 🎯 Overview

This directory contains enterprise-grade Grafana dashboards for comprehensive monitoring of our Kubernetes homelab infrastructure. All dashboards follow GitOps principles and are automatically deployed via ArgoCD.

## 🏗️ Architecture

```
dashboards/
├── DASHBOARD_README.md              # This file - documentation & best practices
├── kustomization.yaml               # Kustomize configuration for dashboard deployment
├── application.yaml                 # ArgoCD Application for dashboard management
├── rook-ceph-dashboards.yaml        # 🗄️ Storage cluster monitoring
├── cilium-hubble-dashboards.yaml    # 🌐 Network observability & security
├── istio-dashboards.yaml            # 🕸️ Service mesh monitoring
├── kafka-dashboards.yaml            # 📨 Message streaming platform
├── n8n-dashboards.yaml              # 🔄 Workflow automation & databases
└── elasticsearch-dashboards.yaml    # 🔍 Search & analytics platform
```

## 🚀 Quick Start

### Adding a New Dashboard

Du hast **2 Ansätze** zur Auswahl:

#### **🚀 Method 1: GrafanaDashboard CRD (EMPFOHLEN)**
```yaml
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: my-service-dashboard
  namespace: monitoring
  labels:
    app.kubernetes.io/name: my-service
    team: platform
  annotations:
    argocd.argoproj.io/sync-wave: "7"
    grafana_folder: "Applications"  # Folder in Grafana UI
spec:
  instanceSelector:
    matchLabels:
      dashboards: "grafana"
  json: |
    {
      "dashboard": {
        "uid": "my-service-uid",
        "title": "My Service Monitoring",
        # ... dashboard JSON
      }
    }
```

**✅ Vorteile:**
- Native Kubernetes Resource
- CRD Validation
- Bessere ArgoCD Integration
- Namespace Scoping
- Automatic folder organization

#### **🔧 Method 2: ConfigMap (Fallback)**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-service-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"  # ⚠️ CRITICAL: Required for Grafana discovery
    app.kubernetes.io/component: monitoring-dashboards
    app.kubernetes.io/part-of: monitoring-stack
  annotations:
    grafana_folder: "Applications"
data:
  my-service.json: |
    {
      "dashboard": {
        "id": 12345,
        "uid": "my-service-uid",
        "title": "My Service Monitoring",
        # ... dashboard JSON
      }
    }
```

**✅ Wann verwenden:**
- Wenn GrafanaDashboard CRD nicht verfügbar
- Legacy Systeme
- Einfache Test-Dashboards

2. **Add to Kustomization**:
```yaml
# kustomization.yaml
resources:
  - application.yaml
  - my-service-dashboard.yaml  # Add your new dashboard
```

3. **Commit & Push** - ArgoCD will automatically deploy! 🎉

## 📋 Best Practices

### 🏷️ Labeling Standards

**ALWAYS include these labels**:
```yaml
labels:
  grafana_dashboard: "1"                    # Required for Grafana auto-discovery
  app.kubernetes.io/component: monitoring-dashboards
  app.kubernetes.io/part-of: monitoring-stack
  team: platform                           # Optional: Team ownership
```

### 🎨 Dashboard Design Principles

#### **1. Enterprise Color Scheme**
```json
{
  "style": "dark",                    // Always use dark theme
  "timezone": "browser",              // User's local timezone
  "refresh": "30s"                    // Standard refresh interval
}
```

#### **2. Panel Layout (24-column grid)**
```json
{
  "gridPos": {
    "h": 8,      // Height in grid units (4 = small, 8 = medium, 12 = large)
    "w": 12,     // Width (6 = quarter, 12 = half, 24 = full)
    "x": 0,      // X position (0-23)
    "y": 0       // Y position (auto-increment)
  }
}
```

#### **3. Standard Panel Types**
- **`stat`**: Single metrics (status, counts)
- **`timeseries`**: Time-based data (rates, utilization)
- **`table`**: Tabular data (top talkers, inventories)
- **`piechart`**: Proportional data (resource distribution)

#### **4. Metric Naming Convention**
```json
{
  "expr": "rate(metric_name_total[5m])",
  "legendFormat": "{{label}} - {{description}}",
  "refId": "A"
}
```

### 📊 Dashboard Structure Template

```json
{
  "dashboard": {
    "id": 0,                          // Auto-generated by Grafana
    "uid": "service-component",       // Unique identifier (kebab-case)
    "title": "Service Component Monitoring",
    "tags": ["service", "component", "category"],
    "style": "dark",
    "timezone": "browser",
    "refresh": "30s",
    "time": {
      "from": "now-1h",              // Default time range
      "to": "now"
    },
    "templating": {
      "list": [
        {
          "name": "datasource",
          "type": "datasource",
          "query": "prometheus"
        },
        {
          "name": "namespace",        // Environment filtering
          "type": "query",
          "query": "label_values(metric, namespace)",
          "includeAll": true,
          "allValue": ".*"
        }
      ]
    },
    "panels": [
      // Status panels first (row 0)
      {
        "id": 1,
        "title": "Service Status",
        "type": "stat",
        "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0}
      },
      // Time series panels (row 1+)
      {
        "id": 2,
        "title": "Request Rate",
        "type": "timeseries",
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4}
      }
    ],
    "version": 1
  }
}
```

### 🎯 Metric Query Best Practices

#### **Rate Calculations**
```promql
# ✅ CORRECT: 5-minute rate for smoothing
rate(http_requests_total[5m])

# ✅ CORRECT: Increase for counters over time
increase(errors_total[1h])

# ❌ AVOID: Instant values for rates
http_requests_total
```

#### **Aggregation Patterns**
```promql
# ✅ Service-level aggregation
sum by (service) (rate(requests_total[5m]))

# ✅ Environment filtering with templating
sum by (pod) (container_memory_usage_bytes{namespace=~"$namespace"})

# ✅ Percentiles for latency
histogram_quantile(0.95, rate(request_duration_seconds_bucket[5m]))
```

#### **Alerting-Ready Queries**
```promql
# ✅ Error rate (percentage)
(rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])) * 100

# ✅ Availability (SLI)
(rate(http_requests_total{status!~"5.."}[5m]) / rate(http_requests_total[5m])) * 100
```

### 🔧 Field Configuration Examples

#### **Status Panels with Color Thresholds**
```json
{
  "fieldConfig": {
    "defaults": {
      "mappings": [
        {"options": {"0": {"text": "DOWN", "color": "red"}}, "type": "value"},
        {"options": {"1": {"text": "UP", "color": "green"}}, "type": "value"}
      ]
    }
  },
  "options": {
    "colorMode": "background"
  }
}
```

#### **Units and Formatting**
```json
{
  "fieldConfig": {
    "defaults": {
      "unit": "bytes",              // bytes, ops, percent, ms, s
      "min": 0,                     // Set minimums for percentages
      "max": 100,                   // Set maximums for percentages
      "decimals": 2                 // Decimal precision
    }
  }
}
```

### 📁 File Organization

#### **Multi-Dashboard Files**
```yaml
# service-dashboards.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: service-overview-dashboard
data:
  service-overview.json: |
    { "dashboard": ... }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: service-details-dashboard
data:
  service-details.json: |
    { "dashboard": ... }
```

## 🔍 Dashboard Categories

### **🗄️ Infrastructure Dashboards**
- **Storage**: Rook Ceph cluster health, capacity, IOPS
- **Networking**: Cilium/Hubble flows, network policies
- **Compute**: Node resources, Kubernetes cluster health

### **🕸️ Platform Dashboards**
- **Service Mesh**: Istio control plane, traffic management
- **Messaging**: Kafka cluster, consumer lag, topics
- **Databases**: PostgreSQL performance, backup status

### **📱 Application Dashboards**
- **Workflow Automation**: N8N execution metrics
- **Search Platform**: Elasticsearch cluster health
- **Web Services**: HTTP metrics, response times

## 🚨 Troubleshooting

### **Dashboard Not Appearing**
1. ✅ Check `grafana_dashboard: "1"` label
2. ✅ Verify JSON syntax with `jq .`
3. ✅ Check ArgoCD Application sync status
4. ✅ Verify ConfigMap exists in `monitoring` namespace

### **Queries Not Working**
1. ✅ Test queries in Grafana Query Explorer
2. ✅ Verify ServiceMonitor exists and is scraping
3. ✅ Check Prometheus targets page
4. ✅ Validate metric names in Prometheus

### **Performance Issues**
1. ✅ Use appropriate time ranges (`[5m]` for rates)
2. ✅ Limit high-cardinality labels
3. ✅ Use `rate()` instead of raw counters
4. ✅ Optimize panel refresh intervals

## 📚 Resources

### **Official Documentation**
- [Grafana Dashboard API](https://grafana.com/docs/grafana/latest/dashboards/)
- [Grafana Panel Types](https://grafana.com/docs/grafana/latest/panels/)
- [PromQL Query Guide](https://prometheus.io/docs/prometheus/latest/querying/basics/)

### **Our GitOps Patterns**
- [ArgoCD Applications](/kubernetes/infrastructure/monitoring/README.md)
- [ServiceMonitor Configuration](/kubernetes/infrastructure/monitoring/SERVICEMONITOR_README.md)
- [Prometheus Setup](/kubernetes/infrastructure/monitoring/prometheus/README.md)

### **Dashboard Examples**
- [Grafana Dashboard Repository](https://grafana.com/grafana/dashboards/)
- [Kubernetes Community Dashboards](https://github.com/dotdc/grafana-dashboards-kubernetes)

---

## 🤝 Contributing

1. **Follow naming conventions**: `service-component-dashboards.yaml`
2. **Test locally** with `kubectl apply --dry-run`
3. **Validate JSON** with `jq . dashboard.json`
4. **Create PR** with dashboard screenshots
5. **Document metrics** and their purpose

---

**🚀 Happy Monitoring!**

*For questions about dashboard development, reach out to the Platform Team or check our [monitoring documentation](../README.md).*
