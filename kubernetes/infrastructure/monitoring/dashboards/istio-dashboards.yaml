apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-control-plane-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
    app.kubernetes.io/component: monitoring-dashboards
    app.kubernetes.io/part-of: monitoring-stack
data:
  istio-control-plane.json: |
    {
      "dashboard": {
        "id": 7645,
        "uid": "istio-control-plane",
        "title": "Istio Control Plane Dashboard",
        "tags": ["istio", "control-plane", "service-mesh"],
        "style": "dark",
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "templating": {
          "list": [
            {
              "name": "datasource",
              "type": "datasource",
              "query": "prometheus",
              "current": {
                "value": "Prometheus",
                "text": "Prometheus"
              }
            }
          ]
        },
        "panels": [
          {
            "id": 1,
            "title": "Istiod Status",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "up{job=\"istiod\"}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "mappings": [
                  {"options": {"0": {"text": "DOWN", "color": "red"}}, "type": "value"},
                  {"options": {"1": {"text": "UP", "color": "green"}}, "type": "value"}
                ]
              }
            },
            "options": {
              "colorMode": "background"
            }
          },
          {
            "id": 2,
            "title": "Pilot XDS Pushes",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 4},
            "targets": [
              {
                "expr": "rate(pilot_xds_pushes_total[5m])",
                "legendFormat": "{{type}}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops"
              }
            }
          },
          {
            "id": 3,
            "title": "Pilot XDS Push Time",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 4},
            "targets": [
              {
                "expr": "histogram_quantile(0.99, rate(pilot_xds_push_time_bucket[5m]))",
                "legendFormat": "99th percentile",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.90, rate(pilot_xds_push_time_bucket[5m]))",
                "legendFormat": "90th percentile",
                "refId": "B"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "s"
              }
            }
          },
          {
            "id": 4,
            "title": "Connected Envoy Proxies",
            "type": "stat",
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 0},
            "targets": [
              {
                "expr": "pilot_xds_eds_instances",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "displayName": "Connected Proxies"
              }
            }
          },
          {
            "id": 5,
            "title": "Configuration Validation Errors",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12},
            "targets": [
              {
                "expr": "rate(galley_validation_failed_total[5m])",
                "legendFormat": "Validation Failures",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops",
                "color": {
                  "fixedColor": "red",
                  "mode": "fixed"
                }
              }
            }
          }
        ],
        "version": 1
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: istio-service-dashboard
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
    app.kubernetes.io/component: monitoring-dashboards
    app.kubernetes.io/part-of: monitoring-stack
data:
  istio-service.json: |
    {
      "dashboard": {
        "id": 7636,
        "uid": "istio-service",
        "title": "Istio Service Dashboard",
        "tags": ["istio", "service-mesh", "services"],
        "style": "dark",
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "templating": {
          "list": [
            {
              "name": "namespace",
              "type": "query",
              "query": "label_values(istio_requests_total, destination_namespace)",
              "current": {
                "value": "All",
                "text": "All"
              },
              "includeAll": true
            },
            {
              "name": "service",
              "type": "query",
              "query": "label_values(istio_requests_total{destination_namespace=~\"$namespace\"}, destination_service_name)",
              "current": {
                "value": "All",
                "text": "All"
              },
              "includeAll": true
            }
          ]
        },
        "panels": [
          {
            "id": 1,
            "title": "Request Rate",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(istio_requests_total{destination_namespace=~\"$namespace\",destination_service_name=~\"$service\"}[5m])) by (destination_service_name)",
                "legendFormat": "{{destination_service_name}}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops"
              }
            }
          },
          {
            "id": 2,
            "title": "Success Rate",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
            "targets": [
              {
                "expr": "sum(rate(istio_requests_total{destination_namespace=~\"$namespace\",destination_service_name=~\"$service\",response_code!~\"5.*\"}[5m])) / sum(rate(istio_requests_total{destination_namespace=~\"$namespace\",destination_service_name=~\"$service\"}[5m])) * 100",
                "legendFormat": "Success Rate %",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "percent",
                "min": 0,
                "max": 100
              }
            }
          },
          {
            "id": 3,
            "title": "Response Time (P99, P90, P50)",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
            "targets": [
              {
                "expr": "histogram_quantile(0.99, sum(rate(istio_request_duration_milliseconds_bucket{destination_namespace=~\"$namespace\",destination_service_name=~\"$service\"}[5m])) by (destination_service_name, le))",
                "legendFormat": "P99 {{destination_service_name}}",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.90, sum(rate(istio_request_duration_milliseconds_bucket{destination_namespace=~\"$namespace\",destination_service_name=~\"$service\"}[5m])) by (destination_service_name, le))",
                "legendFormat": "P90 {{destination_service_name}}",
                "refId": "B"
              },
              {
                "expr": "histogram_quantile(0.50, sum(rate(istio_request_duration_milliseconds_bucket{destination_namespace=~\"$namespace\",destination_service_name=~\"$service\"}[5m])) by (destination_service_name, le))",
                "legendFormat": "P50 {{destination_service_name}}",
                "refId": "C"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ms"
              }
            }
          },
          {
            "id": 4,
            "title": "HTTP Status Codes",
            "type": "timeseries",
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
            "targets": [
              {
                "expr": "sum(rate(istio_requests_total{destination_namespace=~\"$namespace\",destination_service_name=~\"$service\"}[5m])) by (response_code)",
                "legendFormat": "{{response_code}}",
                "refId": "A"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "unit": "ops"
              }
            }
          }
        ],
        "version": 1
      }
    }
