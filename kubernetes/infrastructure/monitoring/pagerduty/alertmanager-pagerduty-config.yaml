apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-pagerduty-config
  namespace: monitoring
  annotations:
    argocd.argoproj.io/sync-wave: "5"
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'pagerduty-critical'
      routes:
      - match:
          severity: critical
        receiver: pagerduty-critical
        continue: false
      - match:
          severity: warning
        receiver: pagerduty-warning
        continue: false
      - receiver: 'null'

    receivers:
    - name: 'pagerduty-critical'
      pagerduty_configs:
      - routing_key_file: /etc/alertmanager/secrets/pagerduty-integration-key/integration-key
        send_resolved: true
        description: '{{ .CommonAnnotations.summary }}'
        severity: critical
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          description: '{{ .CommonAnnotations.description }}'
          action: '{{ .CommonAnnotations.action }}'

    - name: 'pagerduty-warning'
      pagerduty_configs:
      - routing_key_file: /etc/alertmanager/secrets/pagerduty-integration-key/integration-key
        send_resolved: true
        description: '{{ .CommonAnnotations.summary }}'
        severity: warning
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          description: '{{ .CommonAnnotations.description }}'
          action: '{{ .CommonAnnotations.action }}'

    - name: 'null'

    inhibit_rules:
    - source_match:
        severity: critical
      target_match:
        severity: warning
      equal: ['alertname', 'cluster', 'service']
