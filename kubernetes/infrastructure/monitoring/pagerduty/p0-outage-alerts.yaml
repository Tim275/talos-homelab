apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: p0-outage-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus-stack
    role: alert-rules
spec:
  groups:
  - name: p0-complete-outages
    interval: 30s
    rules:
    - alert: KubernetesAPIServerCompleteOutage
      expr: |
        absent(up{job="apiserver"}) or count(up{job="apiserver"} == 1) == 0
      for: 1m
      labels:
        severity: outage
        priority: P0
        component: infrastructure
        tier: tier-0
      annotations:
        summary: "ðŸš¨ COMPLETE OUTAGE - Kubernetes API Server DOWN - ALL HANDS!"
        description: "ALL Kubernetes API servers are unreachable. Cluster is completely unavailable. This is a P0 OUTAGE. Page everyone immediately!"
        action: "kubectl get nodes (will fail) && ssh to control plane nodes && systemctl status kubelet"
        impact: "Complete cluster outage - no workloads accessible"
        runbook_url: "https://kubernetes.io/docs/tasks/debug-application-cluster/debug-cluster/"

    - alert: CephCompleteOutage
      expr: |
        absent(ceph_health_status) or count(ceph_mon_quorum_status == 1) == 0
      for: 1m
      labels:
        severity: outage
        priority: P0
        component: storage
        tier: tier-0
      annotations:
        summary: "ðŸš¨ COMPLETE OUTAGE - Ceph Cluster DEAD - ALL HANDS!"
        description: "Ceph cluster is completely unavailable. ALL monitors are down or unreachable. ALL storage operations are blocked. This is a P0 OUTAGE!"
        action: "kubectl get pods -n rook-ceph && kubectl logs -n rook-ceph -l app=rook-ceph-mon"
        impact: "Complete storage outage - all PVCs unavailable, pods failing to start"
        runbook_url: "https://docs.ceph.com/en/latest/rados/troubleshooting/troubleshooting-mon/"

    - alert: PostgreSQLCompleteOutage
      expr: |
        absent(cnpg_pg_postmaster_up{job="cnpg-clusters"}) or
        count(cnpg_pg_postmaster_up{job="cnpg-clusters"} == 1) == 0
      for: 2m
      labels:
        severity: outage
        priority: P0
        component: database
        tier: tier-1
      annotations:
        summary: "ðŸš¨ COMPLETE OUTAGE - ALL PostgreSQL instances DOWN - ALL HANDS!"
        description: "ALL PostgreSQL database instances are down. Complete database service outage. Applications cannot read or write to database. This is a P0 OUTAGE!"
        action: "kubectl get pods -n cloudnative-pg && kubectl logs -n cloudnative-pg -l cnpg.io/cluster --tail=100"
        impact: "Complete database outage - all database-dependent services unavailable"
        dashboard_url: "https://grafana.homelab.local/d/postgresql-overview"

    - alert: ClusterCapacityCritical
      expr: |
        (count(kube_node_status_condition{condition="Ready",status="true"}) / count(kube_node_info)) < 0.5
      for: 2m
      labels:
        severity: outage
        priority: P0
        component: infrastructure
        tier: tier-0
      annotations:
        summary: "ðŸš¨ CLUSTER CAPACITY CRITICAL - >50% nodes DOWN - ALL HANDS!"
        description: "More than 50% of cluster nodes are down. Cluster capacity critically low. Massive workload disruption. This is a P0 OUTAGE!"
        action: "kubectl get nodes && kubectl describe nodes | grep -A 5 Conditions"
        impact: "Majority of workloads unavailable or evicted"
        current_value: "{{ $value | humanizePercentage }} nodes ready"
        threshold: "50% nodes ready"

    - alert: IstioGatewayCompleteOutage
      expr: |
        absent(up{job="istio-ingressgateway"}) or
        count(up{job="istio-ingressgateway"} == 1) == 0
      for: 2m
      labels:
        severity: outage
        priority: P0
        component: network
        tier: tier-0
      annotations:
        summary: "ðŸš¨ COMPLETE OUTAGE - Istio Gateway DOWN - ALL ingress BLOCKED - ALL HANDS!"
        description: "ALL Istio ingress gateways are down. Complete ingress outage - no external traffic can reach cluster. This is a P0 OUTAGE!"
        action: "kubectl get pods -n istio-system -l app=istio-ingressgateway && kubectl logs -n istio-system -l app=istio-ingressgateway"
        impact: "Complete ingress outage - all external services unreachable"

    - alert: ArgoCDCompleteOutage
      expr: |
        (absent(up{job="argocd-application-controller-metrics"}) or count(up{job="argocd-application-controller-metrics"} == 1) == 0) and
        (absent(up{job="argocd-server-metrics"}) or count(up{job="argocd-server-metrics"} == 1) == 0) and
        (absent(up{job="argocd-repo-server-metrics"}) or count(up{job="argocd-repo-server-metrics"} == 1) == 0)
      for: 2m
      labels:
        severity: outage
        priority: P0
        component: argocd
        tier: tier-0
      annotations:
        summary: "ðŸš¨ COMPLETE OUTAGE - ArgoCD DEAD - GitOps BLOCKED - ALL HANDS!"
        description: "ALL ArgoCD components (controller, server, repo-server) are down. Complete GitOps outage - no deployments possible. This is a P0 OUTAGE!"
        action: "kubectl get pods -n argocd && kubectl logs -n argocd -l app.kubernetes.io/part-of=argocd"
        impact: "Complete GitOps outage - no deployments, syncs, or application management possible"

    - alert: ElasticsearchCompleteOutage
      expr: |
        absent(up{namespace="elastic-system",app="elasticsearch-exporter"}) or
        count(up{namespace="elastic-system",app="elasticsearch-exporter"} == 1) == 0 or
        (elasticsearch_cluster_health_status == 2 and elasticsearch_cluster_health_number_of_nodes == 0)
      for: 2m
      labels:
        severity: outage
        priority: P0
        component: logging
        tier: tier-1
      annotations:
        summary: "ðŸš¨ COMPLETE OUTAGE - Elasticsearch Cluster DEAD - ALL HANDS!"
        description: "ALL Elasticsearch nodes are down or unreachable. Complete logging/observability outage. No logs can be indexed or queried. This is a P0 OUTAGE!"
        action: "kubectl get pods -n elastic-system -l common.k8s.elastic.co/type=elasticsearch && kubectl logs -n elastic-system -l common.k8s.elastic.co/type=elasticsearch --tail=100"
        impact: "Complete logging outage - no log ingestion, Kibana unavailable, Jaeger traces lost"
        runbook_url: "https://www.elastic.co/guide/en/elasticsearch/reference/current/cluster-health.html"
