apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# : Parent manages namespaces, children inherit
# Namespace managed by: monitoring/namespace.yaml (parent app)
namespace: monitoring

resources:
  # - alertmanager-slack-webhooks-sealed-secret.yaml  # Slack webhook for #alerts channel (DISABLED: Using PagerDuty instead)
  - telegram-bot-sealed.yaml  # Telegram bot token for mobile alerts (@Timour_homelab_bot)

  # ===== LAYER ALERTS - Enterprise 5-Layer Architecture =====
  - layer1-infrastructure-alerts.yaml
  - layer2-security-alerts.yaml
  - layer3-network-alerts.yaml
  - layer4-storage-alerts.yaml
  - layer5-platform-alerts.yaml

  # ===== APPLICATION ALERTS =====
  - n8n-application-alerts.yaml   # n8n Automation Platform alerts (Pod down, workflow errors, memory)
  - argocd-alerts.yaml
  - argocd-enhanced-alerts.yaml  # ArgoCD: Git failures, webhooks, API errors, drift detection
  - velero-backup-alerts.yaml    # Tier-0 Backup Monitoring
  - cnpg-postgresql-alerts.yaml  # CloudNativePG production alerts
  - mongodb-alerts.yaml          # MongoDB OMS alerts
  - cert-manager-alerts.yaml     # Certificate expiration alerts
  - kafka-alerts.yaml            # Kafka messaging alerts
  - keycloak-alerts.yaml         # Keycloak authentication alerts
  - rabbitmq-alerts.yaml         # RabbitMQ messaging alerts
  - redis-alerts.yaml            # Redis cache alerts

  # ===== ENTERPRISE ALERTS (existing) =====
  - enterprise-critical-alerts.yaml  # Enterprise critical: PVC filling, WAL archiving, OOM, restarts
  - enterprise-workload-alerts.yaml  # Enterprise: RabbitMQ, Jobs, HPA, PDB, Cloudflared, Quotas
  - node-allocation-alerts.yaml      # Node CPU/Memory REQUESTS alerts (scheduling failures)
  - ceph-cluster-alerts.yaml         # Ceph health, slow ops, degraded PGs, RGW latency

  # ===== NEW ENTERPRISE ALERTS (2025) =====
  - slo-sli-alerts.yaml                    # Google SRE: Error budgets, SLO breach detection
  - prometheus-self-monitoring-alerts.yaml # Prometheus + Alertmanager self-monitoring
  - loki-alerts.yaml                       # Loki log aggregation monitoring
  - grafana-cloudflared-alerts.yaml        # Grafana dashboards + Cloudflare tunnel
  - kubernetes-workload-alerts.yaml        # PVC, Deployments, Jobs, CronJobs, HPA
  - talos-os-alerts.yaml                   # Talos Linux OS level monitoring

  # ===== SERVICEMONITORS - Infrastructure Monitoring =====
  - servicemonitors/servicemonitor-grafana.yaml              # Grafana UI metrics
  - servicemonitors/servicemonitor-grafana-operator.yaml     # Grafana Operator controller metrics
  - servicemonitors/servicemonitor-cert-manager.yaml         # SSL certificate health
  # NOTE: sealed-secrets ServiceMonitor removed - now created by sealed-secrets Helm chart
  # (was causing SharedResourceWarning due to duplicate management)
  # ArgoCD: Controller, API Server, Repo Server, ApplicationSet
  - servicemonitors/argocd-complete.yaml

  # ===== SERVICEMONITORS - Network & Service Mesh =====
  - servicemonitors/servicemonitor-istio-istiod.yaml         # Istio control plane metrics (istiod)
  - servicemonitors/servicemonitor-envoy-gateway.yaml        # Envoy Gateway metrics

  # ===== SERVICEMONITORS - Storage =====
  - servicemonitors/servicemonitor-ceph.yaml                 # Ceph cluster health
  - servicemonitors/servicemonitor-ceph-exporter.yaml        # Ceph exporter metrics

  # ===== SERVICEMONITORS - Observability =====
  - servicemonitors/servicemonitor-elasticsearch-exporter.yaml  # Elasticsearch health
  - servicemonitors/servicemonitor-elasticsearch-cluster.yaml   # Elasticsearch cluster metrics
  - servicemonitors/vector-agent.yaml                           # Vector logging agent
  - servicemonitors/vector-aggregator.yaml                      # Vector aggregator
  - servicemonitors/servicemonitor-vector.yaml                  # Vector Aggregator metrics (fixed port)
  # - servicemonitors/loki.yaml  # Loki Helm chart creates its own ServiceMonitor
  - servicemonitors/jaeger.yaml                                 # Jaeger tracing
  - servicemonitors/servicemonitor-influxdb.yaml                # InfluxDB metrics
  - servicemonitors/servicemonitor-opentelemetry-collector.yaml # OpenTelemetry Collector

  # ===== SERVICEMONITORS - Messaging =====
  - servicemonitors/servicemonitor-kafka-exporter.yaml          # Kafka metrics
  - servicemonitors/servicemonitor-schema-registry.yaml         # Confluent Schema Registry
  - servicemonitors/servicemonitor-rabbitmq.yaml                # RabbitMQ metrics

  # ===== SERVICEMONITORS - Databases =====
  - servicemonitors/cnpg-clusters.yaml                          # PostgreSQL cluster metrics
  - servicemonitors/servicemonitor-mongodb.yaml                 # MongoDB OMS metrics

  # ===== SERVICEMONITORS - Applications =====
  - servicemonitors/servicemonitor-n8n-dev.yaml                 # N8N dev environment
  - servicemonitors/servicemonitor-n8n-prod.yaml                # N8N prod environment

helmCharts:
  - name: kube-prometheus-stack
    repo: https://prometheus-community.github.io/helm-charts
    includeCRDs: true  # CRDs required for PrometheusRule resources
    namespace: monitoring
    version: 75.15.1
    releaseName: kube-prometheus-stack
    valuesFile: ./values.yaml
