apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: keycloak-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus-stack
    release: kube-prometheus-stack
    layer: security
spec:
  groups:
    - name: security.keycloak.critical
      interval: 30s
      rules:
        # ====== P0: CRITICAL - Keycloak Down ======
        - alert: KeycloakDown
          expr: |
            up{job="keycloak"} == 0
          for: 2m
          labels:
            severity: critical
            priority: p0
            component: keycloak
            tier: security
            layer: layer2
          annotations:
            summary: "Keycloak authentication service is DOWN"
            description: |
              Keycloak instance {{ $labels.instance }} is unreachable.
              COMPLETE AUTHENTICATION FAILURE!

              Impact: All user logins FAILING, SSO unavailable
              Team: @security-oncall

              Check: kubectl -n keycloak get pods
              Check: kubectl -n keycloak logs -l app=keycloak --tail=100

        # ====== P0: CRITICAL - Keycloak Database Connection Failed ======
        # : Check actual DB pod health
        - alert: KeycloakDatabaseConnectionFailed
          expr: |
            # PostgreSQL pod not ready (condition=Ready, status=true should be 1)
            (
              kube_pod_status_ready{namespace="keycloak", pod=~"keycloak-db-.*", condition="true"} == 0
              and on(pod) kube_pod_status_phase{namespace="keycloak", pod=~"keycloak-db-.*", phase="Running"} == 1
            )
            # OR Keycloak pod restarting rapidly (DB connection issues cause restarts)
            or (increase(kube_pod_container_status_restarts_total{namespace="keycloak", container="keycloak"}[10m]) > 3)
          for: 5m
          labels:
            severity: critical
            priority: p0
            component: keycloak
            tier: security
            layer: layer2
          annotations:
            summary: "Keycloak database connection issues detected"
            description: |
              Keycloak PostgreSQL database is unhealthy or unreachable.
              Authentication backend UNAVAILABLE!

              Impact: Login failures, session management broken
              Team: @security-oncall

              Check DB: kubectl -n keycloak get cluster keycloak-db
              Check Pods: kubectl -n keycloak get pods -l cnpg.io/cluster=keycloak-db
              Check Logs: kubectl -n keycloak logs -l app.kubernetes.io/name=keycloak --tail=50 | grep -i database

    - name: security.keycloak.high
      interval: 30s
      rules:
        # ====== P1: HIGH - Keycloak LDAP Federation Failed ======
        # : Monitor external identity provider connectivity
        - alert: KeycloakLDAPFederationFailed
          expr: |
            # LLDAP pod not ready (running but unhealthy)
            (
              kube_pod_status_ready{namespace="lldap", pod=~"lldap-.*", condition="true"} == 0
              and on(pod) kube_pod_status_phase{namespace="lldap", pod=~"lldap-.*", phase="Running"} == 1
            )
            # OR LLDAP pod not running at all
            or (
              absent(kube_pod_status_phase{namespace="lldap", pod=~"lldap-.*", phase="Running"} == 1)
            )
          for: 5m
          labels:
            severity: warning
            priority: p1
            component: keycloak
            tier: security
            layer: layer2
          annotations:
            summary: "Keycloak LDAP federation connection failed"
            description: |
              Keycloak cannot connect to LDAP provider (LLDAP).
              User federation BROKEN - LDAP users cannot authenticate!

              Impact: LDAP-synced users cannot login
              Team: @security-oncall

              Check LLDAP: kubectl -n lldap get pods
              Check Secret: kubectl -n keycloak get secret keycloak-lldap-admin
              Check Logs: kubectl -n keycloak logs -l app.kubernetes.io/name=keycloak | grep -i ldap

        # ====== P1: HIGH - Keycloak Auth Failure Rate High ======
        - alert: KeycloakAuthFailureRateHigh
          expr: |
            sum(rate(keycloak_failed_login_attempts[5m])) > 10
          for: 10m
          labels:
            severity: warning
            priority: p1
            component: keycloak
            tier: security
            layer: layer2
          annotations:
            summary: "Keycloak auth failure rate is {{ $value }}/sec"
            description: |
              Keycloak is experiencing {{ $value }} failed login attempts per second.
              Possible brute-force attack or service degradation!

              Duration: >10 minutes
              Action: Check for attack patterns, review auth logs

              Check: kubectl -n keycloak logs -l app=keycloak | grep "Failed login"

        # ====== P1: HIGH - Keycloak Realm Unavailable ======
        # Disabled: keycloak_realms metric not exported by default Keycloak
        # Use KeycloakDown alert instead for availability monitoring
        # - alert: KeycloakRealmUnavailable
        #   expr: |
        #     absent(keycloak_realms) or keycloak_realms == 0
        #   for: 5m
        #   labels:
        #     severity: warning
        #     priority: p1
        #     component: keycloak
        #     tier: security
        #     layer: layer2
        #   annotations:
        #     summary: "Keycloak realms are unavailable"
        #     description: |
        #       No Keycloak realms are accessible.
        #       SSO configuration error or database issue!
        #
        #       Impact: Cannot authenticate users
        #       Duration: >5 minutes

        # ====== P1: HIGH - Keycloak Memory High ======
        - alert: KeycloakMemoryHigh
          expr: |
            (container_memory_working_set_bytes{namespace="keycloak", container="keycloak"}
            / container_spec_memory_limit_bytes{namespace="keycloak", container="keycloak"}) > 0.9
          for: 10m
          labels:
            severity: warning
            priority: p1
            component: keycloak
            tier: security
            layer: layer2
          annotations:
            summary: "Keycloak memory usage is {{ $value | humanizePercentage }}"
            description: |
              Keycloak pod {{ $labels.pod }} memory usage is {{ $value | humanizePercentage }}.
              Risk of OOMKill!

              Current: {{ $value | humanizePercentage }}
              Limit: 100%
              Action: Consider increasing memory limits

    - name: security.keycloak.medium
      interval: 60s
      rules:
        # ====== P2: MEDIUM - Keycloak Response Time Slow ======
        - alert: KeycloakResponseTimeSlow
          expr: |
            histogram_quantile(0.99, sum(rate(keycloak_request_duration_seconds_bucket[5m])) by (le)) > 5
          for: 15m
          labels:
            severity: info
            priority: p2
            component: keycloak
            tier: security
            layer: layer2
          annotations:
            summary: "Keycloak p99 response time is {{ $value }}s"
            description: |
              Keycloak 99th percentile response time is {{ $value }} seconds.
              Users experiencing slow authentication!

              Duration: >15 minutes
              Action: Check database performance, review resource usage
