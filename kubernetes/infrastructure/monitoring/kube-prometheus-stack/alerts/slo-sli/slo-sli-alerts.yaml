# ============================================================================
# SLO/SLI ALERTS - Google SRE s
# Based on: https://sre.google/workbook/alerting-on-slos/
# ============================================================================
# Error Budget Burn Rate Alerting:
#   - Fast burn (2% in 1h) = 14.4x normal rate -> Page immediately
#   - Slow burn (5% in 6h) = 2x normal rate -> Page within 1h
#   - For 99.9% SLO: 0.1% error budget per month = ~43 minutes downtime
# ============================================================================
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: slo-sli-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus-stack
    release: kube-prometheus-stack
    tier: slo
spec:
  groups:
    # ========================================================================
    # SLO RECORDING RULES - Calculate error budgets
    # ========================================================================
    - name: slo.recording.rules
      interval: 30s
      rules:
        # Error ratio for HTTP services (5xx / total)
        - record: slo:http_request_error_ratio:rate5m
          expr: |
            sum(rate(http_requests_total{status=~"5.."}[5m])) by (job, namespace)
            /
            sum(rate(http_requests_total[5m])) by (job, namespace)

        # Availability SLI (successful requests / total)
        - record: slo:availability:ratio
          expr: |
            1 - (
              sum(rate(http_requests_total{status=~"5.."}[5m])) by (job, namespace)
              /
              sum(rate(http_requests_total[5m])) by (job, namespace)
            )

        # Latency SLI (requests under threshold / total)
        - record: slo:latency_p99:ratio
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_request_duration_seconds_bucket[5m])) by (job, namespace, le)
            )

    # ========================================================================
    # P0: CRITICAL - SLO BREACH ALERTS
    # ========================================================================
    - name: slo.critical
      interval: 30s
      rules:
        # ====== P0: CRITICAL - Availability SLO Breach (99.9%) ======
        - alert: AvailabilitySLOBreach
          expr: |
            (
              1 - (
                sum(rate(http_requests_total{status=~"5.."}[1h])) by (job, namespace)
                /
                sum(rate(http_requests_total[1h])) by (job, namespace)
              )
            ) < 0.999
          for: 5m
          labels:
            severity: critical
            priority: p0
            component: slo
            tier: slo
            layer: slo
          annotations:
            summary: "SLO BREACH: {{ $labels.job }} availability below 99.9%"
            description: |
              Service {{ $labels.job }} in {{ $labels.namespace }} has breached
              the 99.9% availability SLO!

              Current Availability: {{ $value | humanizePercentage }}
              Target SLO: 99.9%
              Error Budget: EXHAUSTED

              Impact: Users experiencing errors
              Team: @platform-oncall

              Action: Immediate investigation required

        # ====== P0: CRITICAL - Error Budget Burn Fast (2% in 1h) ======
        - alert: ErrorBudgetBurnFast
          expr: |
            (
              sum(rate(http_requests_total{status=~"5.."}[1h])) by (job, namespace)
              /
              sum(rate(http_requests_total[1h])) by (job, namespace)
            ) > (14.4 * 0.001)
          for: 2m
          labels:
            severity: critical
            priority: p0
            component: slo
            tier: slo
            layer: slo
          annotations:
            summary: "FAST ERROR BUDGET BURN: {{ $labels.job }} burning 2% budget/hour"
            description: |
              Service {{ $labels.job }} is consuming error budget at 14.4x normal rate!
              At this rate, monthly error budget exhausts in ~1 hour.

              Current Error Rate: {{ $value | humanizePercentage }}
              Burn Rate: 14.4x normal (2%/hour)

              Impact: Will breach SLO within 1 hour if not fixed
              Team: @platform-oncall

              Action: PAGE - Immediate investigation required

    # ========================================================================
    # P1: HIGH - SLO WARNING ALERTS
    # ========================================================================
    - name: slo.high
      interval: 30s
      rules:
        # ====== P1: HIGH - Error Budget Burn Slow (5% in 6h) ======
        - alert: ErrorBudgetBurnSlow
          expr: |
            (
              sum(rate(http_requests_total{status=~"5.."}[6h])) by (job, namespace)
              /
              sum(rate(http_requests_total[6h])) by (job, namespace)
            ) > (2 * 0.001)
          for: 15m
          labels:
            severity: warning
            priority: p1
            component: slo
            tier: slo
            layer: slo
          annotations:
            summary: "SLOW ERROR BUDGET BURN: {{ $labels.job }} burning 5% budget/6h"
            description: |
              Service {{ $labels.job }} is consuming error budget at 2x normal rate.
              At this rate, monthly error budget exhausts in ~3 days.

              Current Error Rate: {{ $value | humanizePercentage }}
              Burn Rate: 2x normal (5%/6h)

              Impact: Will breach SLO within 3 days if not fixed
              Action: Investigate within 1 hour

        # ====== P1: HIGH - Latency SLO Breach (p99 > 500ms) ======
        - alert: LatencyBudgetExceeded
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_request_duration_seconds_bucket[5m])) by (job, namespace, le)
            ) > 0.5
          for: 10m
          labels:
            severity: warning
            priority: p1
            component: slo
            tier: slo
            layer: slo
          annotations:
            summary: "LATENCY SLO BREACH: {{ $labels.job }} p99 > 500ms"
            description: |
              Service {{ $labels.job }} p99 latency exceeds 500ms target.

              Current p99: {{ $value | humanizeDuration }}
              Target: 500ms

              Impact: User experience degraded
              Action: Check service performance and dependencies

        # ====== P1: HIGH - Error Rate Spike ======
        - alert: ErrorRateSpike
          expr: |
            (
              sum(rate(http_requests_total{status=~"5.."}[5m])) by (job, namespace)
              /
              sum(rate(http_requests_total[5m])) by (job, namespace)
            ) > 0.01
          for: 5m
          labels:
            severity: warning
            priority: p1
            component: slo
            tier: slo
            layer: slo
          annotations:
            summary: "Error rate spike: {{ $labels.job }} >1% errors"
            description: |
              Service {{ $labels.job }} error rate exceeds 1%.

              Current Error Rate: {{ $value | humanizePercentage }}
              Threshold: 1%

              Action: Check service logs and dependencies

    # ========================================================================
    # P2: MEDIUM - SLO INFORMATIONAL
    # ========================================================================
    - name: slo.medium
      interval: 60s
      rules:
        # ====== P2: MEDIUM - Error Budget Low (50% consumed) ======
        - alert: ErrorBudgetLow
          expr: |
            (
              1 - (
                sum(increase(http_requests_total{status=~"5.."}[30d])) by (job, namespace)
                /
                sum(increase(http_requests_total[30d])) by (job, namespace)
              )
            ) < 0.9995
          for: 1h
          labels:
            severity: info
            priority: p2
            component: slo
            tier: slo
            layer: slo
          annotations:
            summary: "Error budget low: {{ $labels.job }} >50% consumed"
            description: |
              Service {{ $labels.job }} has consumed >50% of monthly error budget.

              30-Day Availability: {{ $value | humanizePercentage }}
              Target: 99.9%

              Action: Monitor closely, prepare for capacity review
