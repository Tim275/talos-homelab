# ============================================================================
# TALOS LINUX OS ALERTS
# Enterprise Tier-0: Operating System level monitoring for Talos
# ============================================================================
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: talos-os-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus-stack
    release: kube-prometheus-stack
    tier: infrastructure
spec:
  groups:
    # ========================================================================
    # TALOS CRITICAL ALERTS
    # ========================================================================
    - name: talos.critical
      interval: 30s
      rules:
        # ====== P1: CRITICAL - Talos Node Unhealthy ======
        - alert: TalosNodeUnhealthy
          expr: |
            talos_node_ready == 0
          for: 5m
          labels:
            severity: critical
            priority: p1
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Talos node {{ $labels.node }} is UNHEALTHY"
            description: |
              Talos node {{ $labels.node }} is not in healthy state.
              Operating system level failure!

              Node: {{ $labels.node }}
              Duration: >5 minutes

              Impact: Node cannot serve workloads, pod scheduling affected
              Team: @platform-oncall

              Check: talosctl -n {{ $labels.node }} health
              Check: talosctl -n {{ $labels.node }} dmesg

        # ====== P1: CRITICAL - Talos API Unreachable ======
        - alert: TalosAPIUnreachable
          expr: |
            up{job="talos"} == 0
          for: 3m
          labels:
            severity: critical
            priority: p1
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Talos API unreachable on {{ $labels.instance }}"
            description: |
              Cannot connect to Talos API on {{ $labels.instance }}.
              Node management operations will fail!

              Instance: {{ $labels.instance }}
              Duration: >3 minutes

              Impact: Cannot perform OS upgrades, config changes, or diagnostics
              Team: @platform-oncall

              Check: talosctl -n {{ $labels.instance }} version

        # ====== P1: CRITICAL - Talos Etcd Member Down ======
        - alert: TalosEtcdMemberDown
          expr: |
            talos_etcd_member_health == 0
          for: 3m
          labels:
            severity: critical
            priority: p1
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Talos etcd member {{ $labels.member }} is DOWN"
            description: |
              Etcd member {{ $labels.member }} on Talos node is down.
              Cluster state at risk if quorum lost!

              Member: {{ $labels.member }}
              Node: {{ $labels.node }}
              Duration: >3 minutes

              Impact: Cluster state inconsistency risk
              Team: @platform-oncall

              Check: talosctl -n {{ $labels.node }} etcd members

    # ========================================================================
    # TALOS HIGH ALERTS
    # ========================================================================
    - name: talos.high
      interval: 30s
      rules:
        # ====== P2: HIGH - Talos Machine Config Drift ======
        - alert: TalosMachineConfigDrift
          expr: |
            talos_machine_config_version != on(node) group_left()
            max(talos_machine_config_version) by ()
          for: 30m
          labels:
            severity: warning
            priority: p2
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Talos node {{ $labels.node }} has config drift"
            description: |
              Talos node {{ $labels.node }} is running a different machine config
              version than the cluster majority.

              Node Config Version: {{ $value }}
              Duration: >30 minutes

              Impact: Node may behave differently than expected
              Action: Apply consistent machine config across all nodes

              Check: talosctl -n {{ $labels.node }} get machineconfig

        # ====== P2: HIGH - Talos Disk Space Low ======
        - alert: TalosDiskSpaceLow
          expr: |
            (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) < 0.15
          for: 15m
          labels:
            severity: warning
            priority: p2
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Talos node {{ $labels.instance }} disk space <15%"
            description: |
              Root filesystem on {{ $labels.instance }} has less than 15% free space.
              Talos operations may fail!

              Available: {{ $value | humanizePercentage }}
              Mountpoint: {{ $labels.mountpoint }}
              Duration: >15 minutes

              Impact: System instability, unable to write logs
              Action: Clean up container images, check for large files

        # ====== P2: HIGH - Talos Kubelet Not Running ======
        - alert: TalosKubeletNotRunning
          expr: |
            talos_service_health{service="kubelet"} == 0
          for: 5m
          labels:
            severity: warning
            priority: p2
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Kubelet not running on Talos node {{ $labels.node }}"
            description: |
              Kubelet service is not healthy on Talos node {{ $labels.node }}.
              Pods cannot be scheduled or managed on this node!

              Service: kubelet
              Node: {{ $labels.node }}
              Duration: >5 minutes

              Check: talosctl -n {{ $labels.node }} services
              Check: talosctl -n {{ $labels.node }} logs kubelet

        # ====== P2: HIGH - Talos Containerd Not Running ======
        - alert: TalosContainerdNotRunning
          expr: |
            talos_service_health{service="containerd"} == 0
          for: 3m
          labels:
            severity: warning
            priority: p2
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Containerd not running on Talos node {{ $labels.node }}"
            description: |
              Containerd service is not healthy on Talos node {{ $labels.node }}.
              Container runtime failure - NO PODS CAN RUN!

              Service: containerd
              Node: {{ $labels.node }}
              Duration: >3 minutes

              Check: talosctl -n {{ $labels.node }} services
              Check: talosctl -n {{ $labels.node }} logs containerd

        # ====== P2: HIGH - Talos System Time Out of Sync ======
        - alert: TalosTimeOutOfSync
          expr: |
            abs(node_timex_offset_seconds) > 0.5
          for: 10m
          labels:
            severity: warning
            priority: p2
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Talos node {{ $labels.instance }} time drift >500ms"
            description: |
              System time on {{ $labels.instance }} is out of sync by {{ $value }}s.
              Certificate validation and distributed systems may fail!

              Time Drift: {{ $value }}s
              Threshold: 500ms
              Duration: >10 minutes

              Impact: TLS cert issues, etcd problems, log correlation broken
              Action: Check NTP configuration

    # ========================================================================
    # TALOS MEDIUM ALERTS
    # ========================================================================
    - name: talos.medium
      interval: 60s
      rules:
        # ====== P3: MEDIUM - Talos Upgrade Available ======
        - alert: TalosUpgradeAvailable
          expr: |
            talos_version < on() group_left() max(talos_version_latest)
          for: 24h
          labels:
            severity: info
            priority: p3
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Talos upgrade available for {{ $labels.node }}"
            description: |
              A newer Talos version is available for node {{ $labels.node }}.

              Current Version: {{ $labels.version }}
              Duration: >24 hours

              Action: Plan upgrade during maintenance window
              Docs: https://www.talos.dev/latest/talos-guides/upgrading-talos/

        # ====== P3: MEDIUM - Talos Service Restarting ======
        - alert: TalosServiceRestarting
          expr: |
            increase(talos_service_restarts_total[1h]) > 3
          for: 15m
          labels:
            severity: info
            priority: p3
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Talos service {{ $labels.service }} restarting frequently"
            description: |
              Talos service {{ $labels.service }} on {{ $labels.node }}
              has restarted {{ $value }} times in the last hour.

              Service: {{ $labels.service }}
              Node: {{ $labels.node }}
              Restarts (1h): {{ $value }}

              Action: Check service logs for errors

        # ====== P3: MEDIUM - Talos Kernel Errors ======
        - alert: TalosKernelErrors
          expr: |
            increase(node_vmstat_oom_kill[1h]) > 0
          for: 5m
          labels:
            severity: info
            priority: p3
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "OOM kills detected on Talos node {{ $labels.instance }}"
            description: |
              {{ $value }} OOM kills occurred on {{ $labels.instance }} in the last hour.
              Memory pressure is causing pods to be killed.

              OOM Kills (1h): {{ $value }}

              Action: Review pod memory limits and node capacity

        # ====== P3: MEDIUM - Talos Network Interface Errors ======
        - alert: TalosNetworkInterfaceErrors
          expr: |
            rate(node_network_receive_errs_total[5m]) > 0
            or
            rate(node_network_transmit_errs_total[5m]) > 0
          for: 15m
          labels:
            severity: info
            priority: p3
            component: talos
            tier: infrastructure
            layer: layer0
          annotations:
            summary: "Network errors on Talos node {{ $labels.instance }}"
            description: |
              Network interface {{ $labels.device }} on {{ $labels.instance }}
              is experiencing packet errors.

              Device: {{ $labels.device }}
              Error Rate: {{ $value }}/s

              Action: Check network cabling and switch configuration
