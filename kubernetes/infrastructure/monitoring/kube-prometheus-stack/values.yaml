# yamllint disable rule:line-length
# https://github.com/prometheus-community/helm-charts/blob/main/charts/kube-prometheus-stack/values.yaml
prometheus:
  prometheusSpec:
    # Retention configuration (prevents disk full)
    retention: 15d           # 15 days retention (homelab standard)
    retentionSize: "45GB"    # 90% of 50GB PVC (prevents disk full)

    # üîß Extended startup probe for slow Ceph storage WAL loading
    # WAL loading takes ~2-3 min per segment on Ceph block storage
    # With 68 WAL segments, startup can take 1.5-2 hours
    startupProbe:
      enabled: true
      initialDelaySeconds: 60        # Wait 60s before first probe
      periodSeconds: 30              # Check every 30s
      timeoutSeconds: 10             # 10s timeout per probe
      failureThreshold: 300          # Allow 300 failures = 2.5+ hours startup time

    podMonitorNamespaceSelector: {}
    podMonitorSelectorNilUsesHelmValues: false
    podMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}
    serviceMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector: {}
    # nodeSelector:
    #   topology.kubernetes.io/zone: abel
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: rook-ceph-block-enterprise  # Use your correct storage class
          # volumeName: pv-prometheus  # Let Kubernetes auto-provision
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 50G
          # selector:  # Remove specific PV selector, let Kubernetes handle it
          #   matchLabels:
          #     app: prometheus

# https://github.com/siderolabs/talos/discussions/7214
kubeControllerManager:
  enabled: true
  serviceMonitor:
    relabelings:
      - sourceLabels: [ __meta_kubernetes_pod_node_name ]
        separator: ;
        regex: ^(.*)$
        targetLabel: nodename
        replacement: $1
        action: replace
    metricRelabelings:
      - action: labeldrop
        regex: pod

kubeEtcd:
  enabled: true
  service:
    selector:
      # etcd doesn't run as a container,
      # but most probably runs on the same nodes that host a controller
      k8s-app: kube-controller-manager
  serviceMonitor:
    relabelings:
      - sourceLabels: [ __meta_kubernetes_pod_node_name ]
        separator: ;
        regex: ^(.*)$
        targetLabel: nodename
        replacement: $1
        action: replace
    metricRelabelings:
      - action: labeldrop
        regex: pod

kubeProxy:
  # Cilium replaces Kube Proxy
  enabled: false

kubeScheduler:
  enabled: true
  serviceMonitor:
    relabelings:
      - sourceLabels: [ __meta_kubernetes_pod_node_name ]
        separator: ;
        regex: ^(.*)$
        targetLabel: nodename
        replacement: $1
        action: replace
    metricRelabelings:
      - action: labeldrop
        regex: pod

nodeExporter:
  enabled: true

grafana:
  enabled: false
  forceDeployDatasources: false
  forceDeployDashboards: false
  defaultDashboardsEnabled: false
  defaultDashboardsTimezone: Europe/Berlin  # Fixed timezone for Germany
  operator:
    dashboardsConfigMapRefEnabled: true
    matchLabels:
      app: grafana
    folder: Kubernetes

# Disable all default Prometheus rules - we use custom enterprise rules
defaultRules:
  create: false
  rules:
    alertmanager: false
    etcd: false
    configReloaders: false
    general: false
    k8s: false
    kubeApiserverAvailability: false
    kubeApiserverBurnrate: false
    kubeApiserverHistogram: false
    kubeApiserverSlos: false
    kubeControllerManager: false
    kubelet: false
    kubeProxy: false
    kubePrometheusGeneral: false
    kubePrometheusNodeRecording: false
    kubernetesApps: false
    kubernetesResources: false
    kubernetesStorage: false
    kubernetesSystem: false
    kubeSchedulerAlerting: false
    kubeSchedulerRecording: false
    kubeStateMetrics: false
    network: false
    node: false
    nodeExporterAlerting: false
    nodeExporterRecording: false
    prometheus: false
    prometheusOperator: false
    windows: false

prometheusOperator:
  admissionWebhooks:
    enabled: false  # Disable admission webhooks completely
    patch:
      enabled: false
    certManager:
      enabled: false
  # Disable TLS completely to avoid cert mount issues
  tls:
    enabled: false
  # üõ°Ô∏è Homelab Stability: Resource limits for Prometheus Operator
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 1000m     # 10x burst for CRD operations
      memory: 1Gi    # 4x headroom for operator

# üõ°Ô∏è Homelab Stability: Resource limits for Kube State Metrics
kube-state-metrics:
  resources:
    requests:
      cpu: 50m       # Actual: ~7m CPU
      memory: 64Mi   # Actual: ~27Mi memory
    limits:
      cpu: 500m      # 10x burst for metrics collection
      memory: 512Mi  # ~20x headroom for cluster growth

  # üîß Fix CrashLoopBackOff: Increase probe delays (was 5s, now 30s)
  # Root cause: kube-state-metrics needs time to start and expose health endpoints
  livenessProbe:
    initialDelaySeconds: 30  # Changed from default 5s to prevent premature probe failures
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    initialDelaySeconds: 30  # Changed from default 5s to allow full startup
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

# üö® ENTERPRISE ALERTMANAGER CONFIG - Production Grade
# Based on your real production alerting system
# Priority Levels: P1 (Critical) ‚Üí P2 (High) ‚Üí P3 (Warning) ‚Üí P5 (Info)


alertmanager:
  alertmanagerSpec:
    secrets:
      - pagerduty-integration-key
      - slack-webhook-url
  config:
    global:
      resolve_timeout: 5m
      pagerduty_url: https://events.pagerduty.com/v2/enqueue

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'default'
      routes:
        - matchers:
            - priority="p0"
          receiver: 'pagerduty-critical'
          continue: true

        - matchers:
            - priority="p0"
          receiver: 'slack-critical'

        - matchers:
            - priority="p1"
          receiver: 'pagerduty-high'
          continue: true

        - matchers:
            - priority="p1"
          receiver: 'slack-high'

        - matchers:
            - priority="p2"
          receiver: 'slack-medium'

        - matchers:
            - priority="p3"
          receiver: 'slack-info'

        - matchers:
            - priority="argocd-gitops"
          receiver: 'slack-argocd-deployments'

    inhibit_rules:
      - source_matchers:
          - severity="critical"
        target_matchers:
          - severity="warning"
        equal: ['alertname', 'namespace', 'instance']

      - source_matchers:
          - priority="p0"
        target_matchers:
          - priority=~"p1|p2|p3"
        equal: ['job', 'namespace']

      - source_matchers:
          - alertname="NodeDown"
        target_matchers:
          - alertname=~"Pod.*|Container.*"
        equal: ['node']

    receivers:
      - name: 'default'
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/slack-webhook-url/url
            channel: '#alerts'
            send_resolved: true
            title: |-
              [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
            text: |-
              {{ range .Alerts }}
              *Alert:* {{ .Labels.alertname }}
              *Severity:* {{ .Labels.severity | toUpper }}
              {{ if .Labels.namespace }}*Namespace:* `{{ .Labels.namespace }}`{{ end }}
              {{ if .Labels.pod }}*Pod:* `{{ .Labels.pod }}`{{ end }}
              {{ if .Labels.container }}*Container:* `{{ .Labels.container }}`{{ end }}
              {{ if .Labels.node }}*Node:* `{{ .Labels.node }}`{{ end }}
              {{ if .Labels.job }}*Job:* `{{ .Labels.job }}`{{ end }}
              *Summary:* {{ .Annotations.summary }}
              {{ if .Annotations.description }}*Description:* {{ .Annotations.description }}{{ end }}
              {{ if .Annotations.impact }}*Impact:* {{ .Annotations.impact }}{{ end }}
              {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
              {{ end }}
            color: |-
              {{ if eq .Status "firing" }}
                {{ if eq .CommonLabels.severity "critical" }}danger{{ else if eq .CommonLabels.severity "warning" }}warning{{ else }}#439FE0{{ end }}
              {{ else }}good{{ end }}

      - name: 'pagerduty-critical'
        pagerduty_configs:
          - routing_key_file: /etc/alertmanager/secrets/pagerduty-integration-key/integration-key
            severity: critical
            description: '{{ .CommonAnnotations.summary }}'
            details:
              firing: '{{ .Alerts.Firing | len }}'
              resolved: '{{ .Alerts.Resolved | len }}'
              alertname: '{{ .CommonLabels.alertname }}'
              namespace: '{{ .CommonLabels.namespace }}'
              priority: '{{ .CommonLabels.priority }}'
              component: '{{ .CommonLabels.component }}'
              impact: '{{ .CommonAnnotations.impact }}'
            send_resolved: true

      - name: 'pagerduty-high'
        pagerduty_configs:
          - routing_key_file: /etc/alertmanager/secrets/pagerduty-integration-key/integration-key
            severity: warning
            description: '{{ .CommonAnnotations.summary }}'
            details:
              firing: '{{ .Alerts.Firing | len }}'
              resolved: '{{ .Alerts.Resolved | len }}'
              alertname: '{{ .CommonLabels.alertname }}'
              namespace: '{{ .CommonLabels.namespace }}'
              priority: '{{ .CommonLabels.priority }}'
            send_resolved: true

      - name: 'slack-critical'
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/slack-webhook-url/url
            channel: '#alerts-critical'
            send_resolved: true
            color: 'danger'
            title: ':rotating_light: P0 CRITICAL: {{ .CommonLabels.alertname }}'
            text: |
              *Summary:* {{ .CommonAnnotations.summary }}
              *Description:* {{ .CommonAnnotations.description }}
              *Impact:* {{ .CommonAnnotations.impact }}
              *Namespace:* {{ .CommonLabels.namespace }}
              *Component:* {{ .CommonLabels.component }}

      - name: 'slack-high'
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/slack-webhook-url/url
            channel: '#alerts-high'
            send_resolved: true
            color: 'warning'
            title: ':warning: P1 HIGH: {{ .CommonLabels.alertname }}'
            text: |
              *Summary:* {{ .CommonAnnotations.summary }}
              *Namespace:* {{ .CommonLabels.namespace }}

      - name: 'slack-medium'
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/slack-webhook-url/url
            channel: '#alerts-medium'
            send_resolved: true
            color: '#439FE0'
            title: ':information_source: P2: {{ .CommonLabels.alertname }}'
            text: '{{ .CommonAnnotations.summary }}'

      - name: 'slack-info'
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/slack-webhook-url/url
            channel: '#alerts-info'
            send_resolved: false
            color: 'good'
            title: ':memo: P3: {{ .CommonLabels.alertname }}'
            text: '{{ .CommonAnnotations.summary }}'

      - name: 'slack-argocd-deployments'
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/slack-webhook-url/url
            channel: '#argocd-deployments'
            send_resolved: true
            color: '#5B9BD5'
            title: ':git: ArgoCD: {{ .CommonLabels.alertname }}'
            text: |
              *Application:* {{ .CommonAnnotations.application }}
              *Project:* {{ .CommonAnnotations.project }}
              *Summary:* {{ .CommonAnnotations.summary }}
              *Status:* {{ .CommonAnnotations.sync_status }}{{ .CommonAnnotations.health_status }}{{ .CommonAnnotations.phase }}
              *Impact:* {{ .CommonAnnotations.impact }}
