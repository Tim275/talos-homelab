# ğŸ¯ N8N WORKFLOW AUTOMATION METRICS MONITORING
#
# ğŸš¨ CRITICAL UNDERSTANDING: N8N Service Discovery fÃ¼r Prometheus + Grafana
# ===========================================================================
#
# PROBLEM: N8N lÃ¤uft aber wird NICHT in Grafana monitoring dashboards angezeigt
# ROOT CAUSE: N8N Service braucht spezifische labels fÃ¼r ServiceMonitor matching
#
# GRAFANA DASHBOARD DATA FLOW:
# 1. N8N Service (port 5678) â†’ 2. ServiceMonitor (selector) â†’ 3. Prometheus (discovery) â†’ 4. Grafana (query)
#
# ğŸ”§ INFRASTRUCTURE AS CODE SOLUTION:
# =================================
# 1. Diese ServiceMonitor CRD definiert WAS zu monitoren ist
# 2. Kustomize patch in n8n/kustomization.yaml fÃ¼gt LABELS zum N8N Service hinzu
# 3. Prometheus Operator entdeckt automatisch ServiceMonitor mit "release: prometheus-operator"
# 4. Grafana kann jetzt n8n_* metrics anzeigen (+ HTTP health checks)
#
# ğŸ›ï¸ SERVICE LABELS REQUIREMENTS (Critical fÃ¼r Discovery):
# ========================================================
# n8n service MUSS haben:
# - release: prometheus-operator  â† CRITICAL: Prometheus entdeckt nur Services mit diesem label
# - app: n8n                     â† ServiceMonitor selector requirement
# - component: workflow-engine    â† ZusÃ¤tzliche kategorisierung
# - monitoring: enabled          â† Explicit monitoring flag
#
# ğŸ’¡ WIE ES FUNKTIONIERT:
# - ServiceMonitor.spec.selector.matchLabels sucht Services mit "app: n8n"
# - ServiceMonitor selbst braucht "release: prometheus-operator" damit Prometheus es findet
# - Service braucht BEIDE labels damit matching klappt
# - Prometheus scraped dann HTTP health + potential custom metrics
#
# ğŸ¯ N8N METRICS ENDPOINTS (Potential):
# - Health check: http://n8n:5678/healthz oder /health
# - Workflow stats: http://n8n:5678/metrics (wenn aktiviert)
# - Custom metrics: can be configured in N8N settings
#
# ğŸ“Š MONITORING STRATEGY:
# - HTTP health monitoring (up/down status)
# - Response time tracking
# - Potential custom workflow metrics (executions, errors, etc.)
# - Application availability monitoring
#
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: n8n-workflow-engine
  namespace: n8n-prod
  annotations:
    argocd.argoproj.io/tracking-id: kube-prometheus-stack:monitoring.coreos.com/ServiceMonitor:monitoring/n8n-workflow-engine
  labels:
    argocd.argoproj.io/instance: kube-prometheus-stack
    app.kubernetes.io/name: n8n-workflow-engine
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: workflow-automation
    team: platform
    release: prometheus-operator  # ğŸ¯ CRITICAL: Prometheus ServiceMonitor discovery
spec:
  namespaceSelector:
    matchNames:
      - n8n-prod
      - n8n-dev
  selector:
    matchLabels:
      app: n8n                    # ğŸ¯ CRITICAL: Must match service labels
      component: workflow-engine  # ğŸ¯ CRITICAL: Must match service labels
  endpoints:
    - port: http                  # ğŸ¯ Port name from service (5678)
      path: /healthz              # ğŸ¯ N8N health check endpoint (assuming standard)
      interval: 30s               # ğŸ¯ Scrape every 30 seconds
      scrapeTimeout: 10s          # ğŸ¯ Timeout after 10 seconds
      honorLabels: true           # ğŸ¯ Keep original metric labels
      scheme: http                # ğŸ¯ N8N uses HTTP
    # ğŸ¯ Alternative metrics endpoint (if N8N metrics are enabled)
    - port: http
      path: /metrics
      interval: 30s
      scrapeTimeout: 10s
      honorLabels: true
      scheme: http
