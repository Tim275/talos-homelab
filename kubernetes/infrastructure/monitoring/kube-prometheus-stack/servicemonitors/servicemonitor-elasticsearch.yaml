# ELASTICSEARCH CLUSTER METRICS MONITORING
#
# CRITICAL UNDERSTANDING: Elasticsearch Service Discovery für Prometheus + Grafana
# =================================================================================
#
# PROBLEM: Elasticsearch exposes metrics aber die werden NICHT in Grafana angezeigt
# ROOT CAUSE: Elasticsearch Service braucht spezifische labels für ServiceMonitor matching
#
# GRAFANA DASHBOARD DATA FLOW:
# 1. ES Service (port 9200) → 2. ServiceMonitor (selector) → 3. Prometheus (discovery) → 4. Grafana (query)
#
# INFRASTRUCTURE AS CODE SOLUTION:
# =================================
# 1. Diese ServiceMonitor CRD definiert WAS zu monitoren ist
# 2. Kustomize patch in elastic/kustomization.yaml fügt LABELS zum ES Service hinzu
# 3. Prometheus Operator entdeckt automatisch ServiceMonitor mit "release: prometheus-operator"
# 4. Grafana kann jetzt elasticsearch_* metrics anzeigen
#
# SERVICE LABELS REQUIREMENTS (Critical für Discovery):
# ========================================================
# production-cluster-es-http service MUSS haben:
# - release: prometheus-operator      ← CRITICAL: Prometheus entdeckt nur Services mit diesem label
# - app: elasticsearch               ← ServiceMonitor selector requirement
# - component: elasticsearch-master  ← Zusätzliche kategorisierung
# - cluster: production-cluster      ← ES cluster identification
#
# WIE ES FUNKTIONIERT:
# - ServiceMonitor.spec.selector.matchLabels sucht Services mit "app: elasticsearch"
# - ServiceMonitor selbst braucht "release: prometheus-operator" damit Prometheus es findet
# - Service braucht BEIDE labels damit matching klappt
# - Prometheus scraped dann automatisch port 9200 für metrics (über /_prometheus/metrics endpoint)
#
# ELASTICSEARCH METRICS ENDPOINT:
# - Standard ES metrics: http://es-service:9200/_prometheus/metrics
# - Cluster health: http://es-service:9200/_cluster/health
# - Node stats: http://es-service:9200/_nodes/_local/stats
#
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: elasticsearch-cluster
  namespace: monitoring
  annotations:
    argocd.argoproj.io/tracking-id: kube-prometheus-stack:monitoring.coreos.com/ServiceMonitor:monitoring/elasticsearch-cluster
  labels:
    argocd.argoproj.io/instance: kube-prometheus-stack
    app.kubernetes.io/name: elasticsearch-cluster
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: elasticsearch
    team: platform
    release: prometheus-operator  # CRITICAL: Prometheus ServiceMonitor discovery
spec:
  namespaceSelector:
    matchNames:
      - elastic-system
  selector:
    matchLabels:
      app: elasticsearch                    # CRITICAL: Must match service labels
      component: elasticsearch-master       # CRITICAL: Must match service labels
  endpoints:
    - port: https                          # Port name from service (9200)
      path: /_prometheus/metrics           # Elasticsearch Prometheus metrics endpoint
      interval: 30s                       # Scrape every 30 seconds
      scrapeTimeout: 10s                  # Timeout after 10 seconds
      honorLabels: true                   # Keep original metric labels
      scheme: https                       # Elasticsearch uses HTTPS
      tlsConfig:                          # TLS configuration für secure ES cluster
        insecureSkipVerify: true          # Skip cert verification für self-signed certs
