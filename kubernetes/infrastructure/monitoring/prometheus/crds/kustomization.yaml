apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Download CRDs directly from upstream and strip annotations
resources:
- https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.77.1/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagers.yaml
- https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.77.1/example/prometheus-operator-crd/monitoring.coreos.com_alertmanagerconfigs.yaml
- https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.77.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheuses.yaml
- https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.77.1/example/prometheus-operator-crd/monitoring.coreos.com_prometheusagents.yaml
- https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.77.1/example/prometheus-operator-crd/monitoring.coreos.com_thanosrulers.yaml
- https://raw.githubusercontent.com/prometheus-operator/prometheus-operator/v0.77.1/example/prometheus-operator-crd/monitoring.coreos.com_scrapeconfigs.yaml

# Add only ArgoCD sync wave
commonAnnotations:
  argocd.argoproj.io/sync-wave: "0"

# Remove problematic annotations
patchesJson6902:
- target:
    group: apiextensions.k8s.io
    version: v1
    kind: CustomResourceDefinition
    name: alertmanagers.monitoring.coreos.com
  patch: |-
    - op: remove
      path: /metadata/annotations/controller-gen.kubebuilder.io~1version
- target:
    group: apiextensions.k8s.io
    version: v1
    kind: CustomResourceDefinition
    name: alertmanagerconfigs.monitoring.coreos.com
  patch: |-
    - op: remove
      path: /metadata/annotations/controller-gen.kubebuilder.io~1version
- target:
    group: apiextensions.k8s.io
    version: v1
    kind: CustomResourceDefinition
    name: prometheuses.monitoring.coreos.com
  patch: |-
    - op: remove
      path: /metadata/annotations/controller-gen.kubebuilder.io~1version
- target:
    group: apiextensions.k8s.io
    version: v1
    kind: CustomResourceDefinition
    name: prometheusagents.monitoring.coreos.com
  patch: |-
    - op: remove
      path: /metadata/annotations/controller-gen.kubebuilder.io~1version
- target:
    group: apiextensions.k8s.io
    version: v1
    kind: CustomResourceDefinition
    name: thanosrulers.monitoring.coreos.com
  patch: |-
    - op: remove
      path: /metadata/annotations/controller-gen.kubebuilder.io~1version
- target:
    group: apiextensions.k8s.io
    version: v1
    kind: CustomResourceDefinition
    name: scrapeconfigs.monitoring.coreos.com
  patch: |-
    - op: remove
      path: /metadata/annotations/controller-gen.kubebuilder.io~1version