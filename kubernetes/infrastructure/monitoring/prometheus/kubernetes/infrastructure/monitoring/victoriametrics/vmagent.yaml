---
# 🔄 VMAGENT - Metrics Collection Agent
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAgent
metadata:
  name: vm-agent
  namespace: monitoring
  annotations:
    argocd.argoproj.io/sync-wave: "4"  # After VM Operator
  labels:
    app.kubernetes.io/name: vm-agent
    app.kubernetes.io/part-of: victoriametrics
spec:
  # 🎯 RESOURCE ALLOCATION
  resources:
    requests:
      cpu: 200m
      memory: 300Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # 📡 REMOTE WRITE to VMCluster
  remoteWrite:
    - url: "http://vminsert-vm-cluster.monitoring.svc.cluster.local:8480/insert/0/prometheus/"

  # 🔧 SCRAPE CONFIGURATION
  scrapeInterval: "30s"
  scrapeTimeout: "10s"

  # 🏷️ EXTERNAL LABELS
  externalLabels:
    cluster: "homelab"
    replica: "vm-agent"

  # 🔍 ENABLE ALL CRD DISCOVERY
  selectAllByDefault: true

  # ⚡ PERFORMANCE TUNING
  extraArgs:
    promscrape.maxScrapeSize: "16MB"
    remoteWrite.maxBlockSize: "8MB"
    memory.allowedPercent: "60"
