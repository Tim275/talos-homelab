# üöÄ NASA-LEVEL PLATFORM IDENTITY & DEVELOPER MONITORING
# ======================================================
# Comprehensive monitoring for identity and developer platform services
# Enterprise identity & developer observability: LLDAP, Authelia, Backstage
#

# üîê LLDAP USER DIRECTORY MONITORING
# =================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: lldap
  namespace: monitoring
  labels:
    app.kubernetes.io/name: lldap
    app.kubernetes.io/component: user-directory
    app.kubernetes.io/part-of: platform-identity
    release: prometheus-operator  # NASA-level discovery
spec:
  namespaceSelector:
    matchNames:
      - lldap
  selector:
    matchLabels:
      app.kubernetes.io/name: lldap
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      scrapeTimeout: 10s
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: 'lldap_.*|ldap_.*|actix_.*|tokio_.*'
          action: keep
        # Keep authentication metrics
        - sourceLabels: [__name__]
          regex: '.*(auth|login|user|group|bind).*'
          action: keep

---
# üîê AUTHELIA OIDC PROVIDER MONITORING
# ==================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: authelia
  namespace: monitoring
  labels:
    app.kubernetes.io/name: authelia
    app.kubernetes.io/component: oidc-provider
    app.kubernetes.io/part-of: platform-identity
    release: prometheus-operator
spec:
  namespaceSelector:
    matchNames:
      - authelia
  selector:
    matchLabels:
      app.kubernetes.io/name: authelia
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      scrapeTimeout: 10s
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: 'authelia_.*|go_.*|process_.*'
          action: keep
        # Keep authentication & authorization metrics
        - sourceLabels: [__name__]
          regex: '.*(auth|oidc|session|totp|webauthn|policy).*'
          action: keep

---
# üë®‚Äçüíª BACKSTAGE DEVELOPER PORTAL MONITORING
# =========================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: backstage
  namespace: monitoring
  labels:
    app.kubernetes.io/name: backstage
    app.kubernetes.io/component: developer-portal
    app.kubernetes.io/part-of: platform-developer
    release: prometheus-operator
spec:
  namespaceSelector:
    matchNames:
      - backstage
  selector:
    matchLabels:
      app.kubernetes.io/name: backstage
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      scrapeTimeout: 10s
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: 'backstage_.*|nodejs_.*|http_.*'
          action: keep
        # Keep developer portal specific metrics
        - sourceLabels: [__name__]
          regex: '.*(catalog|scaffold|techdocs|plugin).*'
          action: keep

---
# üìä QUANTLAB POSTGRESQL (ADDITIONAL PLATFORM DB)
# ==============================================
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: quantlab-postgresql
  namespace: monitoring
  labels:
    app.kubernetes.io/name: quantlab-postgresql
    app.kubernetes.io/component: database
    app.kubernetes.io/part-of: platform-data
    release: prometheus-operator
spec:
  namespaceSelector:
    matchNames:
      - quantlab
  selector:
    matchLabels:
      postgresql: quantlab-postgres
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
      scheme: http
      scrapeTimeout: 10s
      metricRelabelings:
        - sourceLabels: [__name__]
          regex: 'pg_.*|postgresql_.*|cnpg_.*'
          action: keep
        # Keep PostgreSQL performance metrics
        - sourceLabels: [__name__]
          regex: '.*(connection|query|transaction|lock|replication).*'
          action: keep
