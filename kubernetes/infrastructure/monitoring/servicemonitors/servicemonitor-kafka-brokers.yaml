# 🎯 KAFKA BROKERS METRICS MONITORING
#
# 🚨 CRITICAL UNDERSTANDING: Service Discovery for Prometheus + Grafana
# =====================================================================
#
# PROBLEM: Kafka exposes metrics on port 9090 aber Prometheus findet den Service NICHT
# ROOT CAUSE: Services brauchen spezifische labels damit ServiceMonitor sie matchen kann
#
# GRAFANA DASHBOARD DATA FLOW:
# 1. Kafka Service (port 9090) → 2. ServiceMonitor (selector) → 3. Prometheus (discovery) → 4. Grafana (query)
#
# 🔧 INFRASTRUCTURE AS CODE SOLUTION:
# =================================
# 1. Diese ServiceMonitor CRD definiert WAS zu monitoren ist
# 2. Kustomize patch in kafka/kustomization.yaml fügt LABELS zum Service hinzu
# 3. Prometheus Operator entdeckt automatisch ServiceMonitor mit "release: prometheus-operator"
# 4. Grafana kann jetzt kafka_* metrics anzeigen
#
# 🎛️ SERVICE LABELS REQUIREMENTS (Critical für Discovery):
# ========================================================
# my-cluster-kafka-brokers service MUSS haben:
# - release: prometheus-operator  ← CRITICAL: Prometheus entdeckt nur Services mit diesem label
# - app: kafka                    ← ServiceMonitor selector requirement
# - component: kafka-broker       ← Zusätzliche kategorisierung
#
# 💡 WIE ES FUNKTIONIERT:
# - ServiceMonitor.spec.selector.matchLabels sucht Services mit "app: kafka"
# - ServiceMonitor selbst braucht "release: prometheus-operator" damit Prometheus es findet
# - Service braucht BEIDE labels damit matching klappt
# - Prometheus scraped dann automatisch port 9090 für metrics
#
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kafka-brokers
  namespace: kafka
  labels:
    app.kubernetes.io/name: kafka-brokers
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: kafka-cluster
    team: platform
    release: prometheus-operator  # 🎯 CRITICAL: Prometheus ServiceMonitor discovery
spec:
  namespaceSelector:
    matchNames:
      - kafka
  selector:
    matchLabels:
      app.kubernetes.io/name: kafka            # 🎯 CRITICAL: Must match service labels
      strimzi.io/component-type: kafka        # 🎯 CRITICAL: Must match service labels
  endpoints:
    - port: tcp-ctrlplane         # 🎯 Port name from service (9090)
      path: /metrics              # 🎯 Kafka JMX metrics endpoint
      interval: 30s               # 🎯 Scrape every 30 seconds
      scrapeTimeout: 10s          # 🎯 Timeout after 10 seconds
      honorLabels: true           # 🎯 Keep original metric labels
