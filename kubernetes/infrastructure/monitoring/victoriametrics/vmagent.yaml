# üîÑ VMAGENT - Metrics Collection (replaces Prometheus scraping)
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAgent
metadata:
  name: vm-agent
  namespace: monitoring
  annotations:
    argocd.argoproj.io/sync-wave: "4"  # After VM Operator
  labels:
    app.kubernetes.io/name: vm-agent
    app.kubernetes.io/part-of: victoriametrics
spec:
  # üéØ RESOURCE ALLOCATION
  resources:
    requests:
      cpu: 200m
      memory: 300Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # üì° REMOTE WRITE CONFIGURATION (to VMCluster)
  remoteWrite:
    - url: "http://vminsert-vm-cluster.monitoring.svc.cluster.local:8480/insert/0/prometheus/"

  # üîß AGENT CONFIGURATION
  scrapeInterval: "30s"  # Default scrape interval
  scrapeTimeout: "10s"   # Scrape timeout

  # üè∑Ô∏è EXTERNAL LABELS
  externalLabels:
    cluster: "homelab"
    replica: "vm-agent"

  # ‚ö° PERFORMANCE TUNING & PROMETHEUS DISCOVERY CONTROL
  extraArgs:
    promscrape.maxScrapeSize: "16MB"    # Max response size
    remoteWrite.maxBlockSize: "8MB"     # Max block size for remote write
    memory.allowedPercent: "60"         # Memory usage limit
    promscrape.kubernetesSDDisableByDefault: "true"  # Disable auto kubernetes discovery
    promscrape.discovery.disableCompression: "true"  # Reduce discovery overhead
    promscrape.kubernetes.disableEndpoints: "true"   # CRITICAL: Disable kubernetes-service-endpoints
    promscrape.kubernetes.disablePods: "true"        # CRITICAL: Disable kubernetes-pods auto-discovery

  # üö´ DISABLE AUTOMATIC SERVICE DISCOVERY - STRICT WHITELIST ONLY
  # DISABLED: No automatic discovery, only inlineScrapeConfig controls
  selectAllByDefault: false

  # üéØ AUTOMATIC KUBERNETES SERVICE DISCOVERY
  # VMAgent automatically discovers services with annotation prometheus.io/scrape=true
  # Works exactly like Prometheus - no manual VMServiceScrape needed!

  # üéØ STRICT NAMESPACE FILTERING - ONLY monitoring namespace
  serviceScrapeNamespaceSelector:
    matchLabels:
      name: monitoring  # Only monitoring namespace
  podScrapeNamespaceSelector:
    matchLabels:
      name: monitoring  # Only monitoring namespace

  # üéØ PROMETHEUS OPERATOR COMPATIBILITY
  # VMAgent can directly scrape Prometheus ServiceMonitors and PodMonitors
  # These are auto-converted internally by VictoriaMetrics operator

  # üö´ DISABLE INLINE SCRAPE CONFIG - USE ONLY VMServiceScrapes
  # All service discovery now happens through VMServiceScrapes
  # This prevents the unfiltered scraping of all services
