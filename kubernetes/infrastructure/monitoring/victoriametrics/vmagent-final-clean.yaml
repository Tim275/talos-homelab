# üéØ FINAL CLEAN VMAGENT - No Kubernetes Service Discovery At All
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAgent
metadata:
  name: vm-agent
  namespace: monitoring
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  labels:
    app.kubernetes.io/name: vm-agent
    app.kubernetes.io/part-of: victoriametrics
spec:
  # üéØ MINIMAL RESOURCES
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # üì° REMOTE WRITE to VMCluster
  remoteWrite:
    - url: "http://vminsert-vm-cluster.monitoring.svc.cluster.local:8480/insert/0/prometheus/"

  # üîß BASIC AGENT CONFIG
  scrapeInterval: "30s"
  scrapeTimeout: "10s"

  # üè∑Ô∏è CLUSTER LABELS
  externalLabels:
    cluster: "talos-homelab"

  # üö® PERFORMANCE TUNING
  extraArgs:
    promscrape.maxScrapeSize: "16MB"
    memory.allowedPercent: "60"

  # üéØ NUCLEAR OPTION - DISABLE ALL AUTO-DISCOVERY
  selectAllByDefault: false

  # AGGRESSIVE EMPTY SELECTORS - MATCH NOTHING
  serviceScrapeSelector:
    matchLabels:
      vmagent.disabled: "true"  # Never match - this label doesn't exist
  podScrapeSelector:
    matchLabels:
      vmagent.disabled: "true"  # Never match - this label doesn't exist
  nodeScrapeSelector:
    matchLabels:
      vmagent.disabled: "true"  # Never match - this label doesn't exist
  staticScrapeSelector:
    matchLabels:
      vmagent.disabled: "true"  # Never match - this label doesn't exist

  # AGGRESSIVE NAMESPACE SELECTORS - MATCH NOTHING
  serviceScrapeNamespaceSelector:
    matchLabels:
      vmagent.disabled: "true"  # Never match - this label doesn't exist
  podScrapeNamespaceSelector:
    matchLabels:
      vmagent.disabled: "true"  # Never match - this label doesn't exist

  # üéØ TALOS INFRASTRUCTURE ONLY - STATIC TARGETS + KUBERNETES API
  inlineScrapeConfig: |
    global:
      scrape_interval: 30s
      evaluation_interval: 30s

    scrape_configs:
      # ================================================================================
      # TALOS INFRASTRUCTURE MONITORING - CRITICAL ONLY
      # ================================================================================

      # Node Exporter (System Metrics) - STATIC TARGET
      - job_name: 'node-exporter-static'
        static_configs:
          - targets: ['node-exporter.monitoring.svc.cluster.local:9100']
        metrics_path: '/metrics'
        scrape_interval: 30s
        scrape_timeout: 10s

      # VictoriaMetrics Self-Monitoring - STATIC TARGETS
      - job_name: 'victoriametrics-static'
        static_configs:
          - targets:
            - 'vmselect-vm-cluster.monitoring.svc.cluster.local:8481'
            - 'vminsert-vm-cluster.monitoring.svc.cluster.local:8480'
            - 'vmstorage-vm-cluster.monitoring.svc.cluster.local:8482'
        metrics_path: '/metrics'
        scrape_interval: 30s
        scrape_timeout: 10s

      # Kubernetes API Server - ESSENTIAL FOR CLUSTER HEALTH
      - job_name: 'kubernetes-apiserver-essential'
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        static_configs:
          - targets: ['kubernetes.default.svc.cluster.local:443']
        metrics_path: '/metrics'
        scrape_interval: 60s
        scrape_timeout: 10s

      # Talos Nodes - DIRECT KUBELET ACCESS (NO SERVICE DISCOVERY)
      - job_name: 'talos-nodes-direct'
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        static_configs:
          - targets:
            - '192.168.68.101:10250'  # ctrl-0
            - '192.168.68.103:10250'  # worker-1
            - '192.168.68.104:10250'  # worker-2
            - '192.168.68.105:10250'  # worker-3
            - '192.168.68.107:10250'  # worker-4
            - '192.168.68.108:10250'  # worker-5
            - '192.168.68.109:10250'  # worker-6
        metrics_path: '/metrics'
        scrape_interval: 30s
        scrape_timeout: 10s

      # Talos cAdvisor - DIRECT KUBELET ACCESS (NO SERVICE DISCOVERY)
      - job_name: 'talos-cadvisor-direct'
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        static_configs:
          - targets:
            - '192.168.68.101:10250'  # ctrl-0
            - '192.168.68.103:10250'  # worker-1
            - '192.168.68.104:10250'  # worker-2
            - '192.168.68.105:10250'  # worker-3
            - '192.168.68.107:10250'  # worker-4
            - '192.168.68.108:10250'  # worker-5
            - '192.168.68.109:10250'  # worker-6
        metrics_path: '/metrics/cadvisor'
        scrape_interval: 30s
        scrape_timeout: 10s
