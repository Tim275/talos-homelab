# üéØ MINIMAL TALOS VMAGENT - Zero Complexity, Maximum Reliability
apiVersion: operator.victoriametrics.com/v1beta1
kind: VMAgent
metadata:
  name: vm-agent
  namespace: monitoring
  annotations:
    argocd.argoproj.io/sync-wave: "4"
  labels:
    app.kubernetes.io/name: vm-agent
    app.kubernetes.io/part-of: victoriametrics
spec:
  # üéØ MINIMAL RESOURCES
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

  # üì° REMOTE WRITE to VMCluster
  remoteWrite:
    - url: "http://vminsert-vm-cluster.monitoring.svc.cluster.local:8480/insert/0/prometheus/"

  # üîß BASIC AGENT CONFIG
  scrapeInterval: "30s"
  scrapeTimeout: "10s"

  # üè∑Ô∏è CLUSTER LABELS
  externalLabels:
    cluster: "talos-homelab"

  # üö® DISABLE ALL AUTO-DISCOVERY - TALOS SAFE MODE
  extraArgs:
    promscrape.kubernetes.disableEndpoints: "true"
    promscrape.kubernetes.disablePods: "true"
    promscrape.kubernetes.disableServices: "true"
    promscrape.kubernetes.disableIngresses: "true"
    promscrape.maxScrapeSize: "16MB"
    memory.allowedPercent: "60"

  # üéØ ZERO AUTO-DISCOVERY - MANUAL CONTROL ONLY
  selectAllByDefault: false
  serviceScrapeNamespaceSelector:
    matchExpressions:
    - key: name
      operator: DoesNotExist  # Never match any namespace
  podScrapeNamespaceSelector:
    matchExpressions:
    - key: name
      operator: DoesNotExist  # Never match any namespace

  # üéØ TALOS-SPECIFIC MINIMAL MONITORING
  inlineScrapeConfig: |
    global:
      scrape_interval: 30s
      evaluation_interval: 30s

    scrape_configs:
      # ================================================================================
      # TIER 1: TALOS NODE MONITORING ONLY
      # ================================================================================

      # Node Exporter (System Metrics) - TALOS CRITICAL
      - job_name: 'node-exporter-talos'
        static_configs:
          - targets: ['node-exporter.monitoring.svc.cluster.local:9100']
        metrics_path: '/metrics'
        scrape_interval: 30s
        scrape_timeout: 10s

      # VictoriaMetrics Self-Monitoring - ESSENTIAL
      - job_name: 'victoriametrics-self'
        static_configs:
          - targets:
            - 'vmselect-vm-cluster.monitoring.svc.cluster.local:8481'
            - 'vminsert-vm-cluster.monitoring.svc.cluster.local:8480'
            - 'vmstorage-vm-cluster.monitoring.svc.cluster.local:8482'
        metrics_path: '/metrics'
        scrape_interval: 30s
        scrape_timeout: 10s

      # Kubernetes API Server - TALOS CORE
      - job_name: 'kubernetes-apiserver-talos'
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        static_configs:
          - targets: ['kubernetes.default.svc.cluster.local:443']
        metrics_path: '/metrics'
        scrape_interval: 60s
        scrape_timeout: 10s
