# SIMPLIFIED ALERTMANAGER CONFIG - All Alerts to #alerts
# This file is kept for reference but values.yaml is the active config
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-config
  namespace: monitoring
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m

    route:
      group_by: ['alertname', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'slack-alerts'

    inhibit_rules:
      - source_matchers:
          - severity="critical"
        target_matchers:
          - severity="warning"
        equal: ['alertname', 'namespace', 'instance']

      - source_matchers:
          - alertname="NodeDown"
        target_matchers:
          - alertname=~"Pod.*|Container.*"
        equal: ['node']

    receivers:
      - name: 'slack-alerts'
        slack_configs:
          - api_url_file: /etc/alertmanager/secrets/slack-webhook-url/url
            channel: '#alerts'
            send_resolved: true
            title: |-
              [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
            text: |-
              {{ range .Alerts }}
              *Alert:* {{ .Labels.alertname }}
              *Severity:* {{ .Labels.severity | toUpper }}
              {{ if .Labels.priority }}*Priority:* {{ .Labels.priority | toUpper }}{{ end }}
              {{ if .Labels.namespace }}*Namespace:* `{{ .Labels.namespace }}`{{ end }}
              {{ if .Labels.pod }}*Pod:* `{{ .Labels.pod }}`{{ end }}
              {{ if .Labels.container }}*Container:* `{{ .Labels.container }}`{{ end }}
              {{ if .Labels.node }}*Node:* `{{ .Labels.node }}`{{ end }}
              {{ if .Labels.job }}*Job:* `{{ .Labels.job }}`{{ end }}
              {{ if .Labels.component }}*Component:* {{ .Labels.component }}{{ end }}
              *Summary:* {{ .Annotations.summary }}
              {{ if .Annotations.description }}*Description:* {{ .Annotations.description }}{{ end }}
              {{ if .Annotations.impact }}*Impact:* {{ .Annotations.impact }}{{ end }}
              {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
              {{ end }}
            color: |-
              {{ if eq .Status "firing" }}
                {{ if eq .CommonLabels.severity "critical" }}danger{{ else if eq .CommonLabels.severity "warning" }}warning{{ else }}#439FE0{{ end }}
              {{ else }}good{{ end }}
            actions:
              - type: button
                text: 'Prometheus'
                url: '{{ (index .Alerts 0).GeneratorURL }}'
              - type: button
                text: 'Grafana'
                url: 'https://grafana.timourhomelab.org'
              - type: button
                text: 'Silence'
                url: '{{ .ExternalURL }}/#/silences/new'
