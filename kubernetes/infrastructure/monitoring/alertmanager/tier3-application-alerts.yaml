# yamllint disable rule:line-length
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: tier3-application-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus-stack
    role: alert-rules
spec:
  groups:
    # ========================================
    # ðŸŽ¯ TIER-3: APPLICATIONS & PLATFORM
    # ========================================
    # Application-level monitoring - P2/P3/P5 priority
    # SLA: P2 = 15min, P3 = 1hr, P5 = 4hr

    - name: tier3.argocd.critical
      interval: 30s
      rules:
        # ====== ARGOCD (P2/P3) ======
        - alert: ArgoCDApplicationOutOfSync
          expr: argocd_app_info{sync_status="OutOfSync"} == 1
          for: 30m
          labels:
            severity: warning
            priority: P3
            tier: "3"
            component: argocd
          annotations:
            summary: "ArgoCD application {{ $labels.name }} out of sync for 30m"
            description: |
              Application {{ $labels.name }} in namespace {{ $labels.namespace }} has been OutOfSync for 30 minutes. GitOps drift detected!
            current_value: "OutOfSync"
            threshold: "Synced state required"
            dashboard_url: "https://grafana.homelab.local/d/argocd-app/argocd-application-overview"
            runbook_url: "https://argo-cd.readthedocs.io/en/stable/user-guide/sync-options/"

        - alert: ArgoCDApplicationDegraded
          expr: argocd_app_info{health_status="Degraded"} == 1
          for: 15m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: argocd
          annotations:
            summary: "ArgoCD application {{ $labels.name }} is Degraded"
            description: |
              Application {{ $labels.name }} in namespace {{ $labels.namespace }} is in Degraded health state. Check application resources!
            current_value: "Degraded"
            threshold: "Healthy state required"
            dashboard_url: "https://grafana.homelab.local/d/argocd-app/argocd-application-overview"
            runbook_url: "https://argo-cd.readthedocs.io/en/stable/operator-manual/health/"

        - alert: ArgoCDApplicationSuspended
          expr: argocd_app_info{health_status="Suspended"} == 1
          for: 10m
          labels:
            severity: warning
            priority: P3
            tier: "3"
            component: argocd
          annotations:
            summary: "ArgoCD application {{ $labels.name }} is Suspended"
            description: |
              Application {{ $labels.name }} in namespace {{ $labels.namespace }} is Suspended. Deployment stopped!
            current_value: "Suspended"
            threshold: "Healthy state required"
            dashboard_url: "https://grafana.homelab.local/d/argocd-app/argocd-application-overview"
            runbook_url: "https://argo-cd.readthedocs.io/en/stable/operator-manual/health/"

        - alert: ArgoCDSyncFailed
          expr: increase(argocd_app_sync_total{phase="Failed"}[15m]) > 3
          for: 5m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: argocd
          annotations:
            summary: "ArgoCD application {{ $labels.name }} sync failures"
            description: |
              Application {{ $labels.name }} has {{ $value }} sync failures in 15 minutes. GitOps automation broken!
            current_value: "{{ $value }} failures"
            threshold: "3 failures per 15min"
            dashboard_url: "https://grafana.homelab.local/d/argocd-operational/argocd-operational"
            runbook_url: "https://argo-cd.readthedocs.io/en/stable/user-guide/sync-options/"

        - alert: ArgoCDServerDown
          expr: up{job="argocd-server-metrics"} == 0
          for: 5m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: argocd
          annotations:
            summary: "ArgoCD server is DOWN"
            description: "ArgoCD server is unreachable. GitOps UI and CLI unavailable!"
            current_value: "ArgoCD server unreachable"
            threshold: "100% availability required"
            dashboard_url: "https://grafana.homelab.local/d/argocd-operational/argocd-operational"
            runbook_url: "https://argo-cd.readthedocs.io/en/stable/operator-manual/disaster_recovery/"

        - alert: ArgoCDRepoServerDown
          expr: up{job="argocd-repo-server-metrics"} == 0
          for: 5m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: argocd
          annotations:
            summary: "ArgoCD repo server is DOWN"
            description: "ArgoCD repo server is unreachable. Manifest generation blocked - no syncs possible!"
            current_value: "Repo server unreachable"
            threshold: "100% availability required"
            dashboard_url: "https://grafana.homelab.local/d/argocd-operational/argocd-operational"
            runbook_url: "https://argo-cd.readthedocs.io/en/stable/operator-manual/disaster_recovery/"

    - name: tier3.n8n.critical
      interval: 30s
      rules:
        # ====== N8N WORKFLOW AUTOMATION (P2/P3) ======
        - alert: N8NServiceDown
          expr: up{job="n8n",namespace=~"n8n-prod|n8n-dev"} == 0
          for: 5m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: n8n
          annotations:
            summary: "N8N service DOWN in {{ $labels.namespace }}"
            description: "N8N service in {{ $labels.namespace }} is unreachable. Workflow automation stopped!"
            current_value: "N8N service unreachable"
            threshold: "100% availability required"
            dashboard_url: "https://grafana.homelab.local/d/n8n-prod-ultimate/n8n-production-ultimate"
            runbook_url: "https://docs.n8n.io/hosting/scaling/execution-data/"

        - alert: N8NHighEventLoopLag
          expr: n8n_nodejs_eventloop_lag_p99_seconds{namespace=~"n8n-prod|n8n-dev"} > 1
          for: 10m
          labels:
            severity: warning
            priority: P3
            tier: "3"
            component: n8n
          annotations:
            summary: "N8N {{ $labels.namespace }} event loop lag > 1s"
            description: |
              N8N instance in {{ $labels.namespace }} has {{ $value }}s event loop lag at P99. Node.js performance degradation!
            current_value: "{{ $value }}s"
            threshold: "1s P99 lag"
            dashboard_url: "https://grafana.homelab.local/d/n8n-prod-ultimate/n8n-production-ultimate"
            runbook_url: "https://docs.n8n.io/hosting/scaling/queue-mode/"

        - alert: N8NHighMemoryUsage
          expr: (container_memory_working_set_bytes{namespace=~"n8n-prod|n8n-dev",container="n8n"} / container_spec_memory_limit_bytes) * 100 > 85
          for: 10m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: n8n
          annotations:
            summary: "N8N {{ $labels.namespace }} memory > 85%"
            description: "N8N pod {{ $labels.pod }} is using {{ $value | humanize }}% of memory limit. OOM risk!"
            current_value: "{{ $value | humanize }}%"
            threshold: "85%"
            dashboard_url: "https://grafana.homelab.local/d/n8n-prod-ultimate/n8n-production-ultimate"
            runbook_url: "https://docs.n8n.io/hosting/environment-variables/"

        - alert: N8NOOMKilled
          expr: increase(container_oom_events_total{namespace=~"n8n-prod|n8n-dev",container="n8n"}[10m]) > 0
          for: 1m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: n8n
          annotations:
            summary: "N8N {{ $labels.namespace }} OOM killed"
            description: "N8N pod {{ $labels.pod }} was OOM killed. Increase memory limits immediately!"
            current_value: "OOM killed"
            threshold: "0 OOM kills"
            dashboard_url: "https://grafana.homelab.local/d/n8n-prod-ultimate/n8n-production-ultimate"
            runbook_url: "https://docs.n8n.io/hosting/scaling/execution-data/"

        - alert: N8NContainerRestartLoop
          expr: rate(kube_pod_container_status_restarts_total{namespace=~"n8n-prod|n8n-dev",container="n8n"}[15m]) > 0
          for: 10m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: n8n
          annotations:
            summary: "N8N {{ $labels.namespace }} container restarting"
            description: "N8N pod {{ $labels.pod }} is crash looping. Application failure detected!"
            current_value: "Restarting"
            threshold: "0 restarts"
            dashboard_url: "https://grafana.homelab.local/d/n8n-prod-ultimate/n8n-production-ultimate"
            runbook_url: "https://docs.n8n.io/hosting/scaling/execution-data/"

        - alert: N8NHighGCDuration
          expr: rate(n8n_nodejs_gc_duration_seconds_sum{namespace=~"n8n-prod|n8n-dev"}[5m]) * 1000 > 100
          for: 10m
          labels:
            severity: warning
            priority: P3
            tier: "3"
            component: n8n
          annotations:
            summary: "N8N {{ $labels.namespace }} high GC duration"
            description: |
              N8N instance in {{ $labels.namespace }} is spending {{ $value }}ms/s in garbage collection. Memory pressure detected!
            current_value: "{{ $value }}ms/s"
            threshold: "100ms/s"
            dashboard_url: "https://grafana.homelab.local/d/n8n-prod-ultimate/n8n-production-ultimate"
            runbook_url: "https://docs.n8n.io/hosting/scaling/execution-data/"

        - alert: N8NDatabaseConnectionFailure
          expr: up{job="n8n-postgres",namespace=~"n8n-prod|n8n-dev"} == 0
          for: 3m
          labels:
            severity: critical
            priority: P1
            tier: "3"
            component: n8n-database
          annotations:
            summary: "N8N {{ $labels.namespace }} database is DOWN"
            description: "PostgreSQL database for N8N {{ $labels.namespace }} is unreachable. All workflows stopped!"
            current_value: "Database unreachable"
            threshold: "100% availability required"
            dashboard_url: "https://grafana.homelab.local/d/cloudnativepg-cluster/cloudnativepg-cluster"
            runbook_url: "https://cloudnative-pg.io/documentation/current/troubleshooting/"

    - name: tier3.cert-manager.critical
      interval: 30s
      rules:
        # ====== CERT-MANAGER (P2/P3) ======
        - alert: CertManagerDown
          expr: up{job="cert-manager"} == 0
          for: 5m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: cert-manager
          annotations:
            summary: "Cert-Manager is DOWN"
            description: "Cert-Manager is unreachable. Certificate issuance and renewal blocked!"
            current_value: "Cert-Manager unreachable"
            threshold: "100% availability required"
            dashboard_url: "https://grafana.homelab.local/d/cert-manager/cert-manager-overview"
            runbook_url: "https://cert-manager.io/docs/troubleshooting/"

        - alert: CertificateExpiringSoon
          expr: (certmanager_certificate_expiration_timestamp_seconds - time()) / 86400 < 7
          for: 1h
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: cert-manager
          annotations:
            summary: "Certificate {{ $labels.name }} expires in < 7 days"
            description: |
              Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} expires in {{ $value }} days. Renewal required!
            current_value: "{{ $value }} days"
            threshold: "7 days"
            dashboard_url: "https://grafana.homelab.local/d/cert-manager/cert-manager-overview"
            runbook_url: "https://cert-manager.io/docs/troubleshooting/"

        - alert: CertificateRenewalFailed
          expr: certmanager_certificate_ready_status{condition="False"} == 1
          for: 15m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: cert-manager
          annotations:
            summary: "Certificate {{ $labels.name }} renewal failed"
            description: |
              Certificate {{ $labels.name }} in namespace {{ $labels.namespace }} is not ready. Renewal failure!
            current_value: "Not ready"
            threshold: "Ready status required"
            dashboard_url: "https://grafana.homelab.local/d/cert-manager/cert-manager-overview"
            runbook_url: "https://cert-manager.io/docs/troubleshooting/"

    - name: tier3.sealed-secrets.critical
      interval: 30s
      rules:
        # ====== SEALED SECRETS (P2/P3) ======
        - alert: SealedSecretsControllerDown
          expr: up{job="sealed-secrets-controller"} == 0
          for: 5m
          labels:
            severity: critical
            priority: P2
            tier: "3"
            component: sealed-secrets
          annotations:
            summary: "Sealed Secrets controller is DOWN"
            description: |
              Sealed Secrets controller is unreachable. Secret decryption blocked - new deployments will fail!
            current_value: "Controller unreachable"
            threshold: "100% availability required"
            dashboard_url: "https://grafana.homelab.local/d/sealed-secrets/sealed-secrets-controller"
            runbook_url: "https://github.com/bitnami-labs/sealed-secrets#troubleshooting"

        - alert: SealedSecretUnsealError
          expr: increase(sealed_secrets_controller_unseal_errors_total[15m]) > 5
          for: 5m
          labels:
            severity: warning
            priority: P3
            tier: "3"
            component: sealed-secrets
          annotations:
            summary: "Sealed Secrets unseal errors detected"
            description: |
              Sealed Secrets controller has {{ $value }} unseal errors in 15 minutes. Secret decryption failures!
            current_value: "{{ $value }} errors"
            threshold: "5 errors per 15min"
            dashboard_url: "https://grafana.homelab.local/d/sealed-secrets/sealed-secrets-controller"
            runbook_url: "https://github.com/bitnami-labs/sealed-secrets#troubleshooting"

    - name: tier3.monitoring.info
      interval: 30s
      rules:
        # ====== PROMETHEUS & GRAFANA (P3/P5) ======
        - alert: PrometheusTargetDown
          expr: up == 0
          for: 10m
          labels:
            severity: warning
            priority: P3
            tier: "3"
            component: monitoring
          annotations:
            summary: "Prometheus target {{ $labels.job }}/{{ $labels.instance }} is down"
            description: |
              Target {{ $labels.job }} ({{ $labels.instance }}) has been unreachable for 10 minutes. Metrics collection gap!
            current_value: "Target down"
            threshold: "All targets up"
            dashboard_url: "https://grafana.homelab.local/d/prometheus-targets/prometheus-targets"
            runbook_url: "https://runbooks.prometheus-operator.dev/runbooks/prometheus/prometheustargetsdown"

        - alert: PrometheusTSDBCompactionFailed
          expr: rate(prometheus_tsdb_compactions_failed_total[5m]) > 0
          for: 10m
          labels:
            severity: warning
            priority: P3
            tier: "3"
            component: monitoring
          annotations:
            summary: "Prometheus TSDB compaction failures"
            description: "Prometheus has {{ $value }} TSDB compaction failures/sec. Storage performance degraded!"
            current_value: "{{ $value }} failures/sec"
            threshold: "0 failures"
            dashboard_url: "https://grafana.homelab.local/d/prometheus/prometheus-overview"
            runbook_url: "https://runbooks.prometheus-operator.dev/runbooks/prometheus/prometheustsdbcompactionsfailing"

        - alert: GrafanaDown
          expr: up{job="grafana"} == 0
          for: 5m
          labels:
            severity: info
            priority: P5
            tier: "3"
            component: monitoring
          annotations:
            summary: "Grafana is DOWN"
            description: |
              Grafana is unreachable. Dashboard visualization unavailable (metrics collection continues).
            current_value: "Grafana unreachable"
            threshold: "100% availability required"
            dashboard_url: "https://grafana.homelab.local"
            runbook_url: "https://grafana.com/docs/grafana/latest/troubleshooting/"
