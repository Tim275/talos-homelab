# ğŸ¯ ELASTICSEARCH CLUSTER METRICS MONITORING
#
# ğŸš¨ CRITICAL UNDERSTANDING: Elasticsearch Service Discovery fÃ¼r Prometheus + Grafana
# =================================================================================
#
# PROBLEM: Elasticsearch exposes metrics aber die werden NICHT in Grafana angezeigt
# ROOT CAUSE: Elasticsearch Service braucht spezifische labels fÃ¼r ServiceMonitor matching
#
# GRAFANA DASHBOARD DATA FLOW:
# 1. ES Service (port 9200) â†’ 2. ServiceMonitor (selector) â†’ 3. Prometheus (discovery) â†’ 4. Grafana (query)
#
# ğŸ”§ INFRASTRUCTURE AS CODE SOLUTION:
# =================================
# 1. Diese ServiceMonitor CRD definiert WAS zu monitoren ist
# 2. Kustomize patch in elastic/kustomization.yaml fÃ¼gt LABELS zum ES Service hinzu
# 3. Prometheus Operator entdeckt automatisch ServiceMonitor mit "release: prometheus-operator"
# 4. Grafana kann jetzt elasticsearch_* metrics anzeigen
#
# ğŸ›ï¸ SERVICE LABELS REQUIREMENTS (Critical fÃ¼r Discovery):
# ========================================================
# production-cluster-es-http service MUSS haben:
# - release: prometheus-operator      â† CRITICAL: Prometheus entdeckt nur Services mit diesem label
# - app: elasticsearch               â† ServiceMonitor selector requirement
# - component: elasticsearch-master  â† ZusÃ¤tzliche kategorisierung
# - cluster: production-cluster      â† ES cluster identification
#
# ğŸ’¡ WIE ES FUNKTIONIERT:
# - ServiceMonitor.spec.selector.matchLabels sucht Services mit "app: elasticsearch"
# - ServiceMonitor selbst braucht "release: prometheus-operator" damit Prometheus es findet
# - Service braucht BEIDE labels damit matching klappt
# - Prometheus scraped dann automatisch port 9200 fÃ¼r metrics (Ã¼ber /_prometheus/metrics endpoint)
#
# ğŸš¨ ELASTICSEARCH METRICS ENDPOINT:
# - Standard ES metrics: http://es-service:9200/_prometheus/metrics
# - Cluster health: http://es-service:9200/_cluster/health
# - Node stats: http://es-service:9200/_nodes/_local/stats
#
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: elasticsearch-cluster
  namespace: monitoring
  labels:
    app.kubernetes.io/name: elasticsearch-cluster
    app.kubernetes.io/component: monitoring
    app.kubernetes.io/part-of: elasticsearch
    team: platform
    release: prometheus-operator  # ğŸ¯ CRITICAL: Prometheus ServiceMonitor discovery
spec:
  namespaceSelector:
    matchNames:
      - elastic-system
  selector:
    matchLabels:
      app: elasticsearch                    # ğŸ¯ CRITICAL: Must match service labels
      component: elasticsearch-master       # ğŸ¯ CRITICAL: Must match service labels
  endpoints:
    - port: https                          # ğŸ¯ Port name from service (9200)
      path: /_prometheus/metrics           # ğŸ¯ Elasticsearch Prometheus metrics endpoint
      interval: 30s                       # ğŸ¯ Scrape every 30 seconds
      scrapeTimeout: 10s                  # ğŸ¯ Timeout after 10 seconds
      honorLabels: true                   # ğŸ¯ Keep original metric labels
      scheme: https                       # ğŸ¯ Elasticsearch uses HTTPS
      tlsConfig:                          # ğŸ¯ TLS configuration fÃ¼r secure ES cluster
        insecureSkipVerify: true          # ğŸ¯ Skip cert verification fÃ¼r self-signed certs
