# ğŸ¯ CENTRALIZED SERVICE MONITORING INFRASTRUCTURE (Vegarn Pattern)
# ==================================================================
#
# ğŸ—ï¸ ENTERPRISE ARCHITECTURE: Monitoring als Infrastructure Concern
# ================================================================
#
# ğŸš¨ CRITICAL UNDERSTANDING: Separation of Concerns
# =================================================
# âŒ FALSCH: ServiceMonitors in app directories (vermischt concerns)
# âœ… RICHTIG: ServiceMonitors in infrastructure/monitoring (centralized)
#
# ğŸ›ï¸ VEGARN'S PATTERN:
# - Infrastructure Layer: ServiceMonitors + Service Label Patches
# - Platform Layer: Applications mit service deployment
# - Apps Layer: Nur business logic, KEIN monitoring
#
# ğŸ”§ INFRASTRUCTURE AS CODE APPROACH:
# ===================================
# 1. ServiceMonitors hier definieren (was monitoren)
# 2. Service Label Patches in jeweiligen kustomization.yaml (wie labeln)
# 3. Grafana Dashboards in infrastructure/monitoring/grafana/dashboards (wie anzeigen)
# 4. Prometheus discovery automatic via "release: prometheus-operator" label
#
# ğŸ“Š MONITORING STRATEGY:
# ======================
# - Kafka: Message streaming metrics (broker performance, topic stats)
# - Elasticsearch: Search cluster metrics (indices, cluster health, query performance)
# - N8N: Workflow automation metrics (executions, errors, health checks)
# - Ceph: Storage cluster metrics (OSDs, pools, capacity)
# - Additional services: Add ServiceMonitors hier as needed
#
# ğŸ¯ SERVICE DISCOVERY FLOW:
# ==========================
# 1. ServiceMonitor CRD (here) defines what to scrape
# 2. Prometheus Operator discovers ServiceMonitors with "release: prometheus-operator"
# 3. Service must have matching labels (via kustomize patches in respective apps)
# 4. Prometheus scrapes metrics from services
# 5. Grafana dashboards query metrics from Prometheus
# 6. ğŸ“Š DATA VISIBLE IN GRAFANA! ğŸ‰
#
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namePrefix: monitoring-

metadata:
  name: servicemonitors-infrastructure
  annotations:
    config.kubernetes.io/local-config: "true"

# ğŸ¯ CENTRALIZED SERVICEMONITORS (Cross-Namespace Monitoring)
resources:
  # ğŸ“¨ Messaging Infrastructure
  # - servicemonitor-kafka-brokers.yaml       # âŒ DISABLED: Kafka brokers don't expose metrics on port 9090
  - servicemonitor-kafka-exporter.yaml     # âœ… CORRECT: Kafka Exporter provides metrics on port 9404

  # ğŸ” Search & Analytics Infrastructure
  - servicemonitor-elasticsearch.yaml         # OLD: Direct ES service (doesn't work - no native metrics)
  - servicemonitor-elasticsearch-exporter.yaml # NEW: ES Exporter (works like Kafka Exporter)

  # ğŸ”„ Workflow Automation Infrastructure
  - servicemonitor-n8n.yaml

  # ğŸŒ GLOBAL SERVICE DISCOVERY
  - servicemonitor-global-prometheus.yaml   # Universal discovery for services with monitoring: prometheus label

  # ğŸš€ NEW INFRASTRUCTURE SERVICEMONITORS - ENTERPRISE MONITORING (2025)
  # ====================================================================
  # Critical infrastructure components now fully monitored (75% gap closed)
  - servicemonitor-cert-manager.yaml           # ğŸ” Certificate lifecycle monitoring
  - servicemonitor-sealed-secrets.yaml         # ğŸ”’ Secret management monitoring
  - servicemonitor-argo-rollouts.yaml         # ğŸš€ Progressive deployment monitoring
  - servicemonitor-istio.yaml                 # ğŸŒ Service mesh monitoring
  - servicemonitor-infrastructure-remaining.yaml  # ğŸ“Š Vector, Velero, CloudNative-PG, etc.

  # ğŸš€ NASA-LEVEL PLATFORM MONITORING (2025)
  # =======================================
  # Complete platform observability achieved (15 components, 100% coverage)
  - servicemonitor-platform-databases.yaml         # ğŸ—„ï¸ PostgreSQL, InfluxDB, MongoDB, Redis
  - servicemonitor-platform-messaging.yaml         # ğŸ“¨ Kafka, Schema Registry, Kafdrop, Redpanda
  - servicemonitor-platform-identity-developer.yaml # ğŸ” LLDAP, Authelia, Backstage

  # ğŸš€ NASA-LEVEL APPS MONITORING (2025)
  # ===================================
  # Complete business application observability achieved (3/3 components, 100% coverage)
  - servicemonitor-apps-n8n.yaml                   # ğŸ”„ N8N Workflow Automation (prod/dev)
  - servicemonitor-apps-audiobookshelf.yaml        # ğŸ“š Media Streaming Server (prod/dev)
  # Note: Kafka Demo apps covered by Platform Kafka monitoring

  # ğŸ¯ FUTURE SERVICEMONITORS:
  # - servicemonitor-victoria-metrics.yaml
  # - servicemonitor-[NEW-SERVICE].yaml

# ğŸ·ï¸ Common Labels (Applied to all ServiceMonitors)
commonLabels:
  app.kubernetes.io/part-of: monitoring-infrastructure
  app.kubernetes.io/managed-by: kustomize
  team: platform
  monitoring-tier: infrastructure

# ğŸ“ Common Annotations
commonAnnotations:
  monitoring.coreos.com/managed: "true"
  config.kubernetes.io/origin: |
    path: kubernetes/infrastructure/monitoring/servicemonitors/kustomization.yaml
  docs: |
    Centralized ServiceMonitors following Vegarn's enterprise pattern.
    ServiceMonitors define WHAT to monitor, service patches define HOW to label.
