apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: audiobookshelf-performance
  namespace: monitoring
  labels:
    app.kubernetes.io/name: grafana-enterprise
    app.kubernetes.io/component: dashboard
    app.kubernetes.io/part-of: monitoring
    enterprise.tier: applications
    enterprise.category: media
spec:
  resyncPeriod: 30s
  instanceSelector:
    matchLabels:
      dashboards: "grafana"
  json: |
    {
      "dashboard": {
        "id": null,
        "title": "Audiobookshelf - Performance Metrics",
        "tags": ["audiobookshelf", "performance", "streaming"],
        "style": "dark",
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "API Response Time Distribution",
            "type": "heatmap",
            "targets": [
              {
                "expr": "rate(http_request_duration_seconds_bucket{job=\"audiobookshelf\", namespace=~\"audiobookshelf-dev|audiobookshelf-prod\"}[5m])",
                "legendFormat": "{{namespace}} - {{le}}"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Streaming Performance",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(audiobookshelf_stream_bytes_total[5m])",
                "legendFormat": "Bytes/sec"
              },
              {
                "expr": "audiobookshelf_concurrent_streams",
                "legendFormat": "Concurrent Streams"
              }
            ],
            "yAxes": [
              {
                "label": "Bytes/sec",
                "min": 0
              },
              {
                "label": "Streams",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "Cache Hit Ratio",
            "type": "stat",
            "targets": [
              {
                "expr": "audiobookshelf_cache_hits_total / (audiobookshelf_cache_hits_total + audiobookshelf_cache_misses_total) * 100",
                "legendFormat": "Cache Hit %"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 70},
                    {"color": "green", "value": 90}
                  ]
                },
                "unit": "percent"
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Database Query Performance",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(audiobookshelf_db_query_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile"
              },
              {
                "expr": "histogram_quantile(0.50, rate(audiobookshelf_db_query_duration_seconds_bucket[5m]))",
                "legendFormat": "50th percentile"
              }
            ],
            "yAxes": [
              {
                "label": "Seconds",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 9, "x": 6, "y": 8}
          },
          {
            "id": 5,
            "title": "Error Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(http_requests_total{job=\"audiobookshelf\", namespace=~\"audiobookshelf-dev|audiobookshelf-prod\", status=~\"4..|5..\"}[5m]) / rate(http_requests_total{job=\"audiobookshelf\", namespace=~\"audiobookshelf-dev|audiobookshelf-prod\"}[5m]) * 100",
                "legendFormat": "{{namespace}} - Error Rate %"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 1},
                    {"color": "red", "value": 5}
                  ]
                },
                "unit": "percent"
              }
            },
            "gridPos": {"h": 8, "w": 9, "x": 15, "y": 8}
          },
          {
            "id": 6,
            "title": "Audio Processing Queue",
            "type": "graph",
            "targets": [
              {
                "expr": "audiobookshelf_processing_queue_size",
                "legendFormat": "Queue Size"
              },
              {
                "expr": "rate(audiobookshelf_processed_items_total[5m])",
                "legendFormat": "Processing Rate"
              }
            ],
            "yAxes": [
              {
                "label": "Items",
                "min": 0
              },
              {
                "label": "Items/sec",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16}
          },
          {
            "id": 7,
            "title": "WebSocket Connections",
            "type": "graph",
            "targets": [
              {
                "expr": "audiobookshelf_websocket_connections",
                "legendFormat": "Active WebSocket Connections"
              },
              {
                "expr": "rate(audiobookshelf_websocket_messages_total[5m])",
                "legendFormat": "Messages/sec"
              }
            ],
            "yAxes": [
              {
                "label": "Connections",
                "min": 0
              },
              {
                "label": "Messages/sec",
                "min": 0
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16}
          },
          {
            "id": 8,
            "title": "Resource Utilization",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(process_cpu_seconds_total{job=\"audiobookshelf\", namespace=~\"audiobookshelf-dev|audiobookshelf-prod\"}[5m]) * 100",
                "legendFormat": "{{namespace}} - CPU %"
              },
              {
                "expr": "process_resident_memory_bytes{job=\"audiobookshelf\", namespace=~\"audiobookshelf-dev|audiobookshelf-prod\"} / 1024 / 1024",
                "legendFormat": "{{namespace}} - Memory MB"
              },
              {
                "expr": "process_open_fds{job=\"audiobookshelf\", namespace=~\"audiobookshelf-dev|audiobookshelf-prod\"}",
                "legendFormat": "{{namespace}} - File Descriptors"
              }
            ],
            "yAxes": [
              {
                "label": "Usage",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 24}
          }
        ]
      }
    }
