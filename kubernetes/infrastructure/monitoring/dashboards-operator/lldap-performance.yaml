apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: lldap-performance
  namespace: grafana
  labels:
    app.kubernetes.io/name: lldap
    app.kubernetes.io/component: dashboard
    app.kubernetes.io/part-of: monitoring
spec:
  resyncPeriod: 30s
  instanceSelector:
    matchLabels:
      app: "grafana"
  json: |
    {
      "dashboard": {
        "id": null,
        "title": "LLDAP - Performance Metrics",
        "tags": ["lldap", "performance", "ldap"],
        "style": "dark",
        "timezone": "browser",
        "refresh": "30s",
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "panels": [
          {
            "id": 1,
            "title": "LDAP Response Time",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(lldap_request_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile"
              },
              {
                "expr": "histogram_quantile(0.50, rate(lldap_request_duration_seconds_bucket[5m]))",
                "legendFormat": "50th percentile"
              },
              {
                "expr": "histogram_quantile(0.99, rate(lldap_request_duration_seconds_bucket[5m]))",
                "legendFormat": "99th percentile"
              }
            ],
            "yAxes": [
              {
                "label": "Seconds",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Request Rate",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(lldap_requests_total[5m])",
                "legendFormat": "{{method}} {{endpoint}}"
              }
            ],
            "yAxes": [
              {
                "label": "Requests/sec",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "Database Query Performance",
            "type": "graph",
            "targets": [
              {
                "expr": "histogram_quantile(0.95, rate(lldap_db_query_duration_seconds_bucket[5m]))",
                "legendFormat": "DB Query 95th percentile"
              },
              {
                "expr": "histogram_quantile(0.50, rate(lldap_db_query_duration_seconds_bucket[5m]))",
                "legendFormat": "DB Query 50th percentile"
              }
            ],
            "yAxes": [
              {
                "label": "Seconds",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Memory Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "process_resident_memory_bytes{job=\"lldap\"}",
                "legendFormat": "Resident Memory"
              },
              {
                "expr": "process_virtual_memory_bytes{job=\"lldap\"}",
                "legendFormat": "Virtual Memory"
              }
            ],
            "yAxes": [
              {
                "label": "Bytes",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8}
          },
          {
            "id": 5,
            "title": "CPU Usage",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(process_cpu_seconds_total{job=\"lldap\"}[5m]) * 100",
                "legendFormat": "CPU Usage %"
              }
            ],
            "yAxes": [
              {
                "label": "Percent",
                "min": 0,
                "max": 100
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16}
          },
          {
            "id": 6,
            "title": "Connection Pool Performance",
            "type": "graph",
            "targets": [
              {
                "expr": "lldap_db_connections_active",
                "legendFormat": "Active DB Connections"
              },
              {
                "expr": "lldap_db_connections_idle",
                "legendFormat": "Idle DB Connections"
              },
              {
                "expr": "lldap_ldap_connections_active",
                "legendFormat": "Active LDAP Connections"
              }
            ],
            "yAxes": [
              {
                "label": "Connections",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16}
          },
          {
            "id": 7,
            "title": "Cache Performance",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(lldap_cache_hits_total[5m])",
                "legendFormat": "Cache Hits/sec"
              },
              {
                "expr": "rate(lldap_cache_misses_total[5m])",
                "legendFormat": "Cache Misses/sec"
              }
            ],
            "yAxes": [
              {
                "label": "Cache Operations/sec",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24}
          },
          {
            "id": 8,
            "title": "Cache Hit Ratio",
            "type": "stat",
            "targets": [
              {
                "expr": "lldap_cache_hits_total / (lldap_cache_hits_total + lldap_cache_misses_total) * 100",
                "legendFormat": "Hit Ratio"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 70},
                    {"color": "green", "value": 90}
                  ]
                },
                "unit": "percent"
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 12, "y": 24}
          },
          {
            "id": 9,
            "title": "Error Rate",
            "type": "stat",
            "targets": [
              {
                "expr": "rate(lldap_requests_total{status=~\"4..|5..\"}[5m]) / rate(lldap_requests_total[5m]) * 100",
                "legendFormat": "Error Rate"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "color": {
                  "mode": "thresholds"
                },
                "thresholds": {
                  "steps": [
                    {"color": "green", "value": 0},
                    {"color": "yellow", "value": 1},
                    {"color": "red", "value": 5}
                  ]
                },
                "unit": "percent"
              }
            },
            "gridPos": {"h": 8, "w": 6, "x": 18, "y": 24}
          },
          {
            "id": 10,
            "title": "Garbage Collection",
            "type": "graph",
            "targets": [
              {
                "expr": "rate(process_gc_duration_seconds_sum{job=\"lldap\"}[5m])",
                "legendFormat": "GC Duration"
              },
              {
                "expr": "rate(process_gc_cycles_total{job=\"lldap\"}[5m])",
                "legendFormat": "GC Cycles"
              }
            ],
            "yAxes": [
              {
                "label": "Duration (s) / Cycles",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32}
          },
          {
            "id": 11,
            "title": "File Descriptors",
            "type": "graph",
            "targets": [
              {
                "expr": "process_open_fds{job=\"lldap\"}",
                "legendFormat": "Open File Descriptors"
              },
              {
                "expr": "process_max_fds{job=\"lldap\"}",
                "legendFormat": "Max File Descriptors"
              }
            ],
            "yAxes": [
              {
                "label": "File Descriptors",
                "min": 0
              },
              {
                "show": false
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32}
          }
        ]
      }
    }
