---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: jaeger-es-index-cleaner-custom
  namespace: jaeger
spec:
  schedule: "0 2 * * *"  # 02:00 Uhr jeden Tag
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: jaeger-es-index-cleaner-custom
        spec:
          serviceAccountName: jaeger
          restartPolicy: OnFailure
          containers:
          - name: jaeger-es-index-cleaner
            image: jaegertracing/jaeger-es-index-cleaner:1.65.0
            imagePullPolicy: IfNotPresent

            # Korrekte Args mit allen Flags
            args:
            - "7"  # Lösche Indices älter als 7 Tage
            - "https://production-cluster-es-http.elastic-system.svc:9200"
            - "--index-prefix=jaeger"
            - "--es.username=elastic"
            - "--es.password=$(ES_PASSWORD)"
            - "--es.tls.enabled=true"
            - "--es.tls.ca=/etc/ssl/elasticsearch/tls.crt"
            - "--es.tls.skip-host-verify=true"

            env:
            - name: ES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: jaeger-elasticsearch
                  key: elastic

            volumeMounts:
            - name: elasticsearch-ca
              mountPath: /etc/ssl/elasticsearch
              readOnly: true

            resources:
              requests:
                memory: 64Mi
                cpu: 50m
              limits:
                memory: 128Mi
                cpu: 100m

          volumes:
          - name: elasticsearch-ca
            secret:
              secretName: production-cluster-es-http-certs-public
