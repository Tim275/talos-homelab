# yamllint disable rule:line-length
# Robusta Helm Values - Enterprise Alerting Platform
# https://docs.robusta.dev

# ========================================
# üîê SECRET MANAGEMENT (SealedSecrets)
# ========================================
# Slack webhook is stored in Kubernetes Secret (sealed)
# Reference: kubernetes/infrastructure/monitoring/robusta/slack-webhook-sealed-secret.yaml

runner:
  # üöÄ Resource allocation (homelab optimized)
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # üîê CRITICAL: Pull Slack webhook from Kubernetes Secret
  # This pattern is 100% compatible with SealedSecrets!
  additional_env_vars:
    - name: SLACK_WEBHOOK
      valueFrom:
        secretKeyRef:
          name: robusta-slack-webhook  # ‚Üê References the SealedSecret
          key: webhook_url

# ========================================
# üéØ SINK CONFIGURATION (Slack)
# ========================================
sinksConfig:
  - slack_sink:
      name: homelab_slack
      # üîê Use environment variable from secret
      api_key: "{{ env.SLACK_WEBHOOK }}"
      slack_channel: "#homelab-alerts"
      max_log_file_limit_kb: 1000

# ========================================
# üåç GLOBAL CONFIGURATION
# ========================================
globalConfig:
  # Cluster identifier (REQUIRED by Robusta!)
  clusterName: "timour-homelab-talos"

  # üîó Prometheus integration
  prometheus_url: "http://kube-prometheus-stack-prometheus.monitoring.svc:9090"
  alertmanager_url: "http://kube-prometheus-stack-alertmanager.monitoring.svc:9093"

  # üîê Grafana integration (optional - for investigate links)
  grafana_url: "https://grafana.timourhomelab.org"

# ========================================
# üìã BUILT-IN PLAYBOOKS (Enterprise Features)
# ========================================
enablePrometheusStack: true  # Alert enrichment for Prometheus alerts
enablePlatformPlaybooks: true  # Built-in alert handlers

# Playbook configuration
playbooksPersistentVolumeSize: 1Gi
playbooksStorageClass: rook-ceph-block-enterprise

# ========================================
# üé® CUSTOM ALERT ENRICHMENT PLAYBOOKS
# ========================================
customPlaybooks:
  # Alert enrichment: Add pod logs to Prometheus alerts
  - triggers:
      - on_prometheus_alert:
          alert_name: KubePodCrashLooping
    actions:
      - logs_enricher:
          show_logs_of_previous_pod: true

  # Alert enrichment: Add node info to Prometheus alerts
  - triggers:
      - on_prometheus_alert:
          alert_name: KubeNodeNotReady
    actions:
      - node_enricher: {}

  # Alert enrichment: Add cluster status to critical alerts
  - triggers:
      - on_prometheus_alert:
          alert_name: KubeClusterCritical
    actions:
      - cluster_status_enricher: {}

# ========================================
# üîç MONITORING & OBSERVABILITY
# ========================================
kubewatch:
  enabled: true  # Watch Kubernetes events for enrichment

serviceAccount:
  create: true
  name: robusta

# ServiceMonitor for Prometheus scraping
enableServiceMonitors: true

# ========================================
# üè∑Ô∏è LABELS & ANNOTATIONS
# ========================================
commonLabels:
  app.kubernetes.io/name: robusta
  app.kubernetes.io/instance: homelab
  app.kubernetes.io/component: alerting
  environment: production
