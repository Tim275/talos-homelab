apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'discord-homelab'
      routes:
      - match:
          severity: critical
        receiver: 'discord-critical'
        repeat_interval: 15m
      - match:
          severity: warning
        receiver: 'discord-warning'
        repeat_interval: 2h
      - match:
          severity: info
        receiver: 'discord-info'
        repeat_interval: 6h

    receivers:
    - name: 'discord-homelab'
      webhook_configs:
      - url_file: '/etc/alertmanager/secrets/discord-webhook/url'
        send_resolved: true
        http_config:
          follow_redirects: true
        title: 'üîî Homelab Alert'
        message: |
          **Alert:** {{ .GroupLabels.alertname }}
          **Severity:** {{ .CommonLabels.severity }}
          **Instance:** {{ .CommonLabels.instance }}
          **Namespace:** {{ .CommonLabels.namespace }}

          **Description:** {{ .CommonAnnotations.summary }}

          **Details:** {{ .CommonAnnotations.description }}

    - name: 'discord-critical'
      webhook_configs:
      - url_file: '/etc/alertmanager/secrets/discord-webhook/url'
        send_resolved: true
        http_config:
          follow_redirects: true
        title: 'üö® CRITICAL ALERT üö®'
        message: |
          @everyone **CRITICAL SYSTEM ALERT**

          **Alert:** {{ .GroupLabels.alertname }}
          **Instance:** {{ .CommonLabels.instance }}
          **Namespace:** {{ .CommonLabels.namespace }}

          **Problem:** {{ .CommonAnnotations.summary }}
          **Details:** {{ .CommonAnnotations.description }}

          **‚ö†Ô∏è  IMMEDIATE ACTION REQUIRED ‚ö†Ô∏è**

    - name: 'discord-warning'
      webhook_configs:
      - url_file: '/etc/alertmanager/secrets/discord-webhook/url'
        send_resolved: true
        http_config:
          follow_redirects: true
        title: '‚ö†Ô∏è  Warning'
        message: |
          **Warning Alert**

          **Alert:** {{ .GroupLabels.alertname }}
          **Instance:** {{ .CommonLabels.instance }}
          **Severity:** warning

          **Issue:** {{ .CommonAnnotations.summary }}

    - name: 'discord-info'
      webhook_configs:
      - url_file: '/etc/alertmanager/secrets/discord-webhook/url'
        send_resolved: true
        http_config:
          follow_redirects: true
        title: '‚ÑπÔ∏è Info'
        message: |
          **Information**

          **Alert:** {{ .GroupLabels.alertname }}
          **Details:** {{ .CommonAnnotations.summary }}

    inhibit_rules:
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'instance']
    - source_match:
        severity: 'warning'
      target_match:
        severity: 'info'
      equal: ['alertname']