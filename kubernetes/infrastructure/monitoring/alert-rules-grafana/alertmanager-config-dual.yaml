apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: monitoring
  labels:
    app.kubernetes.io/managed-by: argocd
    app.kubernetes.io/part-of: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      # SMTP Configuration for Email Alerts
      smtp_smarthost: 'smtp-mail.outlook.com:587'
      smtp_from: 'timour@hotmail.de'
      smtp_auth_username: 'timour@hotmail.de'
      smtp_auth_password: 'kqzqrxxvcxzyjjrv'  # TODO: Move to Secret
      smtp_require_tls: true

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'dual-notification'  # Default: Both Email + Discord
      routes:
      - match:
          severity: critical
        receiver: 'critical-dual'
        repeat_interval: 15m
      - match:
          severity: warning
        receiver: 'warning-dual'
        repeat_interval: 2h
      - match:
          severity: info
        receiver: 'info-dual'
        repeat_interval: 6h

    receivers:
    # DEFAULT: Email + Discord
    - name: 'dual-notification'
      email_configs:
      - to: 'timour@hotmail.de'
        subject: 'üîî Homelab Alert: {{ .GroupLabels.alertname }}'
        headers:
          From: 'Talos Homelab <timour@hotmail.de>'
          To: 'Homelab Admin <timour@hotmail.de>'
        body: |
          Alert Details:

          Alert Name: {{ .GroupLabels.alertname }}
          Severity: {{ .CommonLabels.severity }}
          Instance: {{ .CommonLabels.instance }}
          Namespace: {{ .CommonLabels.namespace }}

          Description: {{ .CommonAnnotations.summary }}

          Time: {{ .CommonAnnotations.timestamp }}

          ---
          Talos Homelab Monitoring System
      webhook_configs:
      - url_file: '/etc/alertmanager/secrets/discord-webhook/url'
        send_resolved: true
        http_config:
          follow_redirects: true

    # CRITICAL: Email + Discord with @everyone
    - name: 'critical-dual'
      email_configs:
      - to: 'timour@hotmail.de'
        subject: 'üö® CRITICAL ALERT: {{ .GroupLabels.alertname }}'
        headers:
          From: 'Talos Homelab CRITICAL <timour@hotmail.de>'
          To: 'Homelab Admin <timour@hotmail.de>'
          Priority: 'high'
        body: |
          ‚ö†Ô∏è  CRITICAL ALERT - IMMEDIATE ACTION REQUIRED ‚ö†Ô∏è

          Alert: {{ .GroupLabels.alertname }}
          Instance: {{ .CommonLabels.instance }}
          Namespace: {{ .CommonLabels.namespace }}

          Problem: {{ .CommonAnnotations.summary }}
          Description: {{ .CommonAnnotations.description }}

          Timestamp: {{ .CommonAnnotations.timestamp }}

          This is a critical system alert requiring immediate attention!

          ---
          Talos Homelab Critical Monitoring
      webhook_configs:
      - url_file: '/etc/alertmanager/secrets/discord-webhook/url'
        send_resolved: true
        http_config:
          follow_redirects: true
        title: 'üö® CRITICAL ALERT üö®'
        message: |
          @everyone **CRITICAL SYSTEM ALERT**

          **Alert:** {{ .GroupLabels.alertname }}
          **Instance:** {{ .CommonLabels.instance }}
          **Namespace:** {{ .CommonLabels.namespace }}

          **Problem:** {{ .CommonAnnotations.summary }}
          **Details:** {{ .CommonAnnotations.description }}

          **‚ö†Ô∏è  IMMEDIATE ACTION REQUIRED ‚ö†Ô∏è**

    # WARNING: Email + Discord
    - name: 'warning-dual'
      email_configs:
      - to: 'timour@hotmail.de'
        subject: '‚ö†Ô∏è  Warning: {{ .GroupLabels.alertname }}'
        headers:
          From: 'Talos Homelab Warning <timour@hotmail.de>'
          To: 'Homelab Admin <timour@hotmail.de>'
        body: |
          Warning Alert:

          Alert: {{ .GroupLabels.alertname }}
          Instance: {{ .CommonLabels.instance }}
          Severity: {{ .CommonLabels.severity }}

          Issue: {{ .CommonAnnotations.summary }}

          Time: {{ .CommonAnnotations.timestamp }}

          Please investigate when convenient.

          ---
          Talos Homelab Monitoring
      webhook_configs:
      - url_file: '/etc/alertmanager/secrets/discord-webhook/url'
        send_resolved: true
        http_config:
          follow_redirects: true
        title: '‚ö†Ô∏è  Warning'
        message: |
          **Warning Alert**

          **Alert:** {{ .GroupLabels.alertname }}
          **Instance:** {{ .CommonLabels.instance }}
          **Severity:** warning

          **Issue:** {{ .CommonAnnotations.summary }}

    # INFO: Email + Discord (less intrusive)
    - name: 'info-dual'
      email_configs:
      - to: 'timour@hotmail.de'
        subject: '‚ÑπÔ∏è Info: {{ .GroupLabels.alertname }}'
        headers:
          From: 'Talos Homelab Info <timour@hotmail.de>'
          To: 'Homelab Admin <timour@hotmail.de>'
        body: |
          Information Alert:

          Alert: {{ .GroupLabels.alertname }}
          Details: {{ .CommonAnnotations.summary }}

          Time: {{ .CommonAnnotations.timestamp }}

          ---
          Talos Homelab Monitoring
      webhook_configs:
      - url_file: '/etc/alertmanager/secrets/discord-webhook/url'
        send_resolved: true
        http_config:
          follow_redirects: true
        title: '‚ÑπÔ∏è Info'
        message: |
          **Information**

          **Alert:** {{ .GroupLabels.alertname }}
          **Details:** {{ .CommonAnnotations.summary }}

    inhibit_rules:
    - source_match:
        severity: 'critical'
      target_match:
        severity: 'warning'
      equal: ['alertname', 'instance']
    - source_match:
        severity: 'warning'
      target_match:
        severity: 'info'
      equal: ['alertname']