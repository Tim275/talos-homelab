apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaDashboard
metadata:
  name: elasticsearch-cluster-health
  namespace: grafana
  labels:
    app.kubernetes.io/part-of: monitoring-stack
    tier: platform
spec:
  allowCrossNamespaceImport: true
  json: |
    {
      "id": null,
      "title": "üîç Elasticsearch Cluster Health",
      "tags": ["elasticsearch", "search", "cluster", "health"],
      "timezone": "browser",
      "panels": [
        {
          "id": 1,
          "title": "Cluster Status",
          "type": "stat",
          "targets": [
            {
              "expr": "elasticsearch_cluster_health_status",
              "legendFormat": "Health Status"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "mappings": [
                {"options": {"0": {"text": "Red", "color": "red"}}, "type": "value"},
                {"options": {"1": {"text": "Yellow", "color": "yellow"}}, "type": "value"},
                {"options": {"2": {"text": "Green", "color": "green"}}, "type": "value"}
              ]
            }
          },
          "gridPos": {"h": 6, "w": 4, "x": 0, "y": 0}
        },
        {
          "id": 2,
          "title": "Node Count",
          "type": "stat",
          "targets": [
            {
              "expr": "elasticsearch_cluster_health_number_of_nodes",
              "legendFormat": "Total Nodes"
            },
            {
              "expr": "elasticsearch_cluster_health_number_of_data_nodes",
              "legendFormat": "Data Nodes"
            }
          ],
          "gridPos": {"h": 6, "w": 4, "x": 4, "y": 0}
        },
        {
          "id": 3,
          "title": "Shards Status",
          "type": "stat",
          "targets": [
            {
              "expr": "elasticsearch_cluster_health_active_shards",
              "legendFormat": "Active"
            },
            {
              "expr": "elasticsearch_cluster_health_active_primary_shards",
              "legendFormat": "Primary"
            },
            {
              "expr": "elasticsearch_cluster_health_unassigned_shards",
              "legendFormat": "Unassigned"
            }
          ],
          "gridPos": {"h": 6, "w": 8, "x": 8, "y": 0}
        },
        {
          "id": 4,
          "title": "Pending Tasks",
          "type": "stat",
          "targets": [
            {
              "expr": "elasticsearch_cluster_health_number_of_pending_tasks",
              "legendFormat": "Pending Tasks"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "thresholds": {
                "steps": [
                  {"color": "green", "value": 0},
                  {"color": "yellow", "value": 5},
                  {"color": "red", "value": 20}
                ]
              }
            }
          },
          "gridPos": {"h": 6, "w": 8, "x": 16, "y": 0}
        },
        {
          "id": 5,
          "title": "JVM Memory Usage by Node",
          "type": "graph",
          "targets": [
            {
              "expr": "elasticsearch_jvm_memory_used_bytes{area=\"heap\"}",
              "legendFormat": "{{name}} Heap Used"
            },
            {
              "expr": "elasticsearch_jvm_memory_max_bytes{area=\"heap\"}",
              "legendFormat": "{{name}} Heap Max"
            }
          ],
          "yAxes": [
            {"label": "Bytes", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 6}
        },
        {
          "id": 6,
          "title": "CPU Usage by Node",
          "type": "graph",
          "targets": [
            {
              "expr": "rate(elasticsearch_process_cpu_seconds_total[5m]) * 100",
              "legendFormat": "{{name}} CPU %"
            }
          ],
          "yAxes": [
            {"label": "Percent", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 6}
        },
        {
          "id": 7,
          "title": "Index Operations Rate",
          "type": "graph",
          "targets": [
            {
              "expr": "rate(elasticsearch_indices_indexing_index_total[5m])",
              "legendFormat": "{{name}} Indexing"
            },
            {
              "expr": "rate(elasticsearch_indices_search_query_total[5m])",
              "legendFormat": "{{name}} Search"
            },
            {
              "expr": "rate(elasticsearch_indices_get_total[5m])",
              "legendFormat": "{{name}} Get"
            }
          ],
          "yAxes": [
            {"label": "Operations/sec", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 14}
        },
        {
          "id": 8,
          "title": "Index Size & Document Count",
          "type": "graph",
          "targets": [
            {
              "expr": "elasticsearch_indices_store_size_bytes",
              "legendFormat": "{{index}} Size"
            },
            {
              "expr": "elasticsearch_indices_docs",
              "legendFormat": "{{index}} Docs"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 14}
        },
        {
          "id": 9,
          "title": "Search Performance",
          "type": "graph",
          "targets": [
            {
              "expr": "elasticsearch_indices_search_query_time_seconds",
              "legendFormat": "{{name}} Query Time"
            },
            {
              "expr": "elasticsearch_indices_search_fetch_time_seconds",
              "legendFormat": "{{name}} Fetch Time"
            }
          ],
          "yAxes": [
            {"label": "Seconds", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 22}
        },
        {
          "id": 10,
          "title": "Disk Usage by Node",
          "type": "graph",
          "targets": [
            {
              "expr": "elasticsearch_filesystem_data_size_bytes - elasticsearch_filesystem_data_free_bytes",
              "legendFormat": "{{name}} Used"
            },
            {
              "expr": "elasticsearch_filesystem_data_size_bytes",
              "legendFormat": "{{name}} Total"
            }
          ],
          "yAxes": [
            {"label": "Bytes", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 22}
        },
        {
          "id": 11,
          "title": "Thread Pool Status",
          "type": "graph",
          "targets": [
            {
              "expr": "elasticsearch_thread_pool_active_count",
              "legendFormat": "{{name}} {{type} Active"
            },
            {
              "expr": "elasticsearch_thread_pool_queue_count",
              "legendFormat": "{{name}} {{type}} Queue"
            },
            {
              "expr": "elasticsearch_thread_pool_rejected_count",
              "legendFormat": "{{name}} {{type}} Rejected"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 30}
        },
        {
          "id": 12,
          "title": "GC Activity",
          "type": "graph",
          "targets": [
            {
              "expr": "rate(elasticsearch_jvm_gc_collection_seconds_total[5m])",
              "legendFormat": "{{name}} {{gc}} GC Time"
            },
            {
              "expr": "rate(elasticsearch_jvm_gc_collection_count_total[5m])",
              "legendFormat": "{{name}} {{gc}} GC Rate"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 30}
        },
        {
          "id": 13,
          "title": "Network Activity",
          "type": "graph",
          "targets": [
            {
              "expr": "rate(elasticsearch_transport_rx_size_bytes_total[5m])",
              "legendFormat": "{{name}} RX"
            },
            {
              "expr": "rate(elasticsearch_transport_tx_size_bytes_total[5m])",
              "legendFormat": "{{name}} TX"
            }
          ],
          "yAxes": [
            {"label": "Bytes/sec", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 24, "x": 0, "y": 38}
        }
      ],
      "time": {"from": "now-1h", "to": "now"},
      "refresh": "30s"
    }
  folder: Elasticsearch
  instanceSelector:
    matchLabels:
      app: grafana
  resyncPeriod: 10m
