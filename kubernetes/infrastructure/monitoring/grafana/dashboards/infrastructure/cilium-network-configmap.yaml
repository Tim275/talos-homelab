apiVersion: v1
kind: ConfigMap
metadata:
  name: cilium-network-dashboard
  namespace: grafana
  labels:
    app.kubernetes.io/part-of: monitoring-stack
    tier: infrastructure
data:
  dashboard.json: |
    {
      "id": null,
      "title": "üï∑Ô∏è Cilium Network Infrastructure",
      "tags": ["cilium", "network", "cni", "ebpf"],
      "timezone": "browser",
      "panels": [
        {
          "id": 1,
          "title": "Agent Status",
          "type": "stat",
          "targets": [
            {
              "expr": "cilium_agent_api_process_time_seconds_count",
              "legendFormat": "Agents Running"
            },
            {
              "expr": "cilium_version",
              "legendFormat": "Version {{version}}"
            }
          ],
          "gridPos": {"h": 6, "w": 8, "x": 0, "y": 0}
        },
        {
          "id": 2,
          "title": "Endpoint Count",
          "type": "stat",
          "targets": [
            {
              "expr": "cilium_endpoint_count",
              "legendFormat": "Total Endpoints"
            },
            {
              "expr": "cilium_endpoint_state{state=\"ready\"}",
              "legendFormat": "Ready Endpoints"
            }
          ],
          "gridPos": {"h": 6, "w": 8, "x": 8, "y": 0}
        },
        {
          "id": 3,
          "title": "Policy Status",
          "type": "stat",
          "targets": [
            {
              "expr": "cilium_policy_count",
              "legendFormat": "Active Policies"
            },
            {
              "expr": "cilium_policy_enforcement_status",
              "legendFormat": "Enforcement {{status}}"
            }
          ],
          "gridPos": {"h": 6, "w": 8, "x": 16, "y": 0}
        },
        {
          "id": 4,
          "title": "Network Throughput",
          "type": "graph",
          "targets": [
            {
              "expr": "rate(cilium_forward_count_total[5m])",
              "legendFormat": "Forward {{direction}} {{node}}"
            }
          ],
          "yAxes": [
            {"label": "Packets/sec", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 6}
        },
        {
          "id": 5,
          "title": "Drop Count by Reason",
          "type": "graph",
          "targets": [
            {
              "expr": "rate(cilium_drop_count_total[5m])",
              "legendFormat": "Drops {{reason}} {{node}}"
            }
          ],
          "yAxes": [
            {"label": "Drops/sec", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 6}
        },
        {
          "id": 6,
          "title": "Policy Enforcement",
          "type": "graph",
          "targets": [
            {
              "expr": "rate(cilium_policy_l3_l4_count_total[5m])",
              "legendFormat": "L3/L4 Policy {{action}} {{node}}"
            },
            {
              "expr": "rate(cilium_policy_l7_count_total[5m])",
              "legendFormat": "L7 Policy {{action}} {{node}}"
            }
          ],
          "yAxes": [
            {"label": "Policy Actions/sec", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 14}
        },
        {
          "id": 7,
          "title": "Identity Management",
          "type": "graph",
          "targets": [
            {
              "expr": "cilium_identity_count",
              "legendFormat": "Identities {{node}}"
            }
          ],
          "yAxes": [
            {"label": "Count", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 14}
        },
        {
          "id": 8,
          "title": "BPF Map Operations",
          "type": "graph",
          "targets": [
            {
              "expr": "rate(cilium_bpf_map_ops_total[5m])",
              "legendFormat": "{{mapName}} {{operation}} {{node}}"
            }
          ],
          "yAxes": [
            {"label": "Operations/sec", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 22}
        },
        {
          "id": 9,
          "title": "Service Load Balancing",
          "type": "graph",
          "targets": [
            {
              "expr": "cilium_services_events_total",
              "legendFormat": "Service Events {{action}} {{node}}"
            }
          ],
          "yAxes": [
            {"label": "Events", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 22}
        },
        {
          "id": 10,
          "title": "Agent API Latency",
          "type": "graph",
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(cilium_agent_api_process_time_seconds_bucket[5m])) by (method, le))",
              "legendFormat": "95th percentile {{method}}"
            },
            {
              "expr": "histogram_quantile(0.50, sum(rate(cilium_agent_api_process_time_seconds_bucket[5m])) by (method, le))",
              "legendFormat": "50th percentile {{method}}"
            }
          ],
          "yAxes": [
            {"label": "Seconds", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 30}
        },
        {
          "id": 11,
          "title": "IPAM Allocation",
          "type": "graph",
          "targets": [
            {
              "expr": "cilium_ipam_ips{type=\"available\"}",
              "legendFormat": "Available IPs {{node}}"
            },
            {
              "expr": "cilium_ipam_ips{type=\"allocated\"}",
              "legendFormat": "Allocated IPs {{node}}"
            }
          ],
          "yAxes": [
            {"label": "IP Count", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 30}
        },
        {
          "id": 12,
          "title": "Datapath Errors",
          "type": "table",
          "targets": [
            {
              "expr": "increase(cilium_datapath_errors_total[5m])",
              "legendFormat": "{{area}} {{name}} {{family}}"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 38}
        },
        {
          "id": 13,
          "title": "Controller Status",
          "type": "table",
          "targets": [
            {
              "expr": "cilium_controllers_runs_duration_seconds_count",
              "legendFormat": "{{name}} runs"
            },
            {
              "expr": "cilium_controllers_runs_duration_seconds_sum / cilium_controllers_runs_duration_seconds_count",
              "legendFormat": "{{name}} avg duration"
            }
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 38}
        },
        {
          "id": 14,
          "title": "Memory Usage",
          "type": "graph",
          "targets": [
            {
              "expr": "process_resident_memory_bytes{job=\"cilium-agent\"}",
              "legendFormat": "RSS {{instance}}"
            },
            {
              "expr": "process_virtual_memory_bytes{job=\"cilium-agent\"}",
              "legendFormat": "Virtual {{instance}}"
            }
          ],
          "yAxes": [
            {"label": "Bytes", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 46}
        },
        {
          "id": 15,
          "title": "File Descriptors",
          "type": "graph",
          "targets": [
            {
              "expr": "process_open_fds{job=\"cilium-agent\"}",
              "legendFormat": "Open FDs {{instance}}"
            },
            {
              "expr": "process_max_fds{job=\"cilium-agent\"}",
              "legendFormat": "Max FDs {{instance}}"
            }
          ],
          "yAxes": [
            {"label": "Count", "show": true},
            {"show": false}
          ],
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 46}
        }
      ],
      "time": {"from": "now-1h", "to": "now"},
      "refresh": "30s"
    }
