apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# ðŸŒŠ Sync Wave 10: Database Operators (After Infrastructure)
commonAnnotations:
  argocd.argoproj.io/sync-wave: "10"

# CloudNative-PG PostgreSQL Operator
resources:
  - application.yaml           # âœ… Child Application for App-of-Apps pattern
  - https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.23/releases/cnpg-1.23.1.yaml

labels:
  - pairs:
      app.kubernetes.io/part-of: database-platform
      app.kubernetes.io/component: postgresql-operator

# Fix CloudNative PG operator metrics for Prometheus
patches:
  - target:
      kind: Deployment
      name: cnpg-controller-manager
    patch: |-
      - op: add
        path: /spec/template/metadata/annotations
        value:
          prometheus.io/scrape: "true"
          prometheus.io/port: "8080"
          prometheus.io/path: "/metrics"
          prometheus.io/scheme: "https"
