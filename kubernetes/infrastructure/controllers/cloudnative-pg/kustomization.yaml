apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization


# ðŸŒŠ Sync Wave 10: Database Operators (After Infrastructure)
commonAnnotations:
  argocd.argoproj.io/sync-wave: "10"

# CloudNative-PG PostgreSQL Operator
resources:
  - https://raw.githubusercontent.com/cloudnative-pg/cloudnative-pg/release-1.23/releases/cnpg-1.23.1.yaml

labels:
  - pairs:
      app.kubernetes.io/part-of: database-platform
      app.kubernetes.io/component: postgresql-operator

# Fix CloudNative PG operator metrics for Prometheus + increase resources to prevent crashloop
patches:
  - target:
      kind: Deployment
      name: cnpg-controller-manager
    patch: |-
      - op: add
        path: /spec/template/metadata/annotations
        value:
          prometheus.io/scrape: "true"
          prometheus.io/port: "8080"
          prometheus.io/path: "/metrics"
          prometheus.io/scheme: "https"
      # Increase CPU resources to prevent crashloop (was 100m, now 500m)
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: "500m"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: "200m"
      # Increase memory to handle 4+ PostgreSQL clusters
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/memory
        value: "512Mi"
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: "256Mi"
      # Increase probe timeout to prevent false-positive failures
      - op: replace
        path: /spec/template/spec/containers/0/livenessProbe/timeoutSeconds
        value: 5
      - op: replace
        path: /spec/template/spec/containers/0/readinessProbe/timeoutSeconds
        value: 5
      # Increase initial delay to give webhook time to start
      - op: add
        path: /spec/template/spec/containers/0/livenessProbe/initialDelaySeconds
        value: 30
      - op: add
        path: /spec/template/spec/containers/0/readinessProbe/initialDelaySeconds
        value: 10
