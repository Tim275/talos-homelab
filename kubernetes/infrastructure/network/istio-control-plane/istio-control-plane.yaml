# Istio Control Plane managed by Sail Operator
# This replaces the traditional IstioOperator CR
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default
  namespace: istio-system
spec:
  # REQUIRED: Target namespace for Istio installation
  namespace: istio-system

  # Istio Version to deploy
  version: v1.26.4

  # Update Strategy - RevisionBased for zero-downtime updates
  updateStrategy:
    type: RevisionBased

  # Istio Configuration (Helm values)
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: homelab-cluster
      network: network1

      # Proxy configuration
      proxy:
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 40Mi

        # Security context - Both fields not supported in Sail Operator schema
        # runAsUser: 1337               # ❌ DISABLED - Field not declared in schema
        # runAsGroup: 1337              # ❌ DISABLED - Field not declared in schema

    pilot:
      # Resource configuration for Istiod
      resources:
        limits:
          cpu: 500m
          memory: 2048Mi
        requests:
          cpu: 100m
          memory: 128Mi

      # High Availability
      replicaCount: 1

      # Environment-specific settings
      env:
        PILOT_TRACE_SAMPLING: "1.0"      # ❌ FIX - Must be string, not float
        PILOT_ENABLE_AMBIENT: "true"     # ❌ FIX - Must be string, not bool
        PILOT_ENABLE_CROSS_CLUSTER_WORKLOAD_ENTRY: "true"  # ❌ FIX - Must be string

    # Security settings
    meshConfig:
      defaultConfig:
        proxyStatsMatcher:
          inclusionRegexps:
          - ".*circuit_breakers.*"
          - ".*upstream_rq_retry.*"
          - ".*_cx_.*"
        # proxyStatsMatcher:             # ❌ DISABLED - Field not declared in schema
        #   inclusionRegexps:
        #   - ".*circuit_breakers.*"
        #   - ".*upstream_rq_retry.*"
        #   - ".*_cx_.*"
        #   exclusionRegexps:
        #   - ".*osconfig.*"
