# Istio Control Plane managed by Sail Operator
# This replaces the traditional IstioOperator CR
apiVersion: sailoperator.io/v1
kind: Istio
metadata:
  name: default
  namespace: istio-system
spec:
  # REQUIRED: Target namespace for Istio installation
  namespace: istio-system

  # Istio Version to deploy
  version: v1.26.1

  # Update Strategy - RevisionBased for zero-downtime updates
  updateStrategy:
    type: RevisionBased

  # Istio Configuration (Helm values)
  values:
    global:
      meshID: mesh1
      multiCluster:
        clusterName: homelab-cluster
      network: network1

      # Proxy configuration
      proxy:
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 40Mi

        # Security context
        runAsUser: 1337
        runAsGroup: 1337

    pilot:
      # Resource configuration for Istiod
      resources:
        limits:
          cpu: 500m
          memory: 2048Mi
        requests:
          cpu: 100m
          memory: 128Mi

      # High Availability
      replicaCount: 1

      # Environment-specific settings
      env:
        PILOT_TRACE_SAMPLING: 1.0
        PILOT_ENABLE_AMBIENT: true
        PILOT_ENABLE_CROSS_CLUSTER_WORKLOAD_ENTRY: true

    # Security settings
    meshConfig:
      defaultConfig:
        proxyStatsMatcher:
          inclusionRegexps:
          - ".*circuit_breakers.*"
          - ".*upstream_rq_retry.*"
          - ".*_cx_.*"
          exclusionRegexps:
          - ".*osconfig.*"