# üî• ENTERPRISE L7 VISIBILITY - GLOBAL HTTP/DNS INSPECTION
# ===========================================================
# CiliumClusterwideNetworkPolicy to enable L7 (HTTP/DNS) visibility
# for ALL pods across ALL namespaces.
#
# üéØ WHY THIS IS CRITICAL:
# - Cilium's httpV2 metric only works when L7 visibility is enabled
# - Without this policy, Hubble only sees L4 (TCP/UDP) flows
# - With this policy, Hubble captures HTTP methods, status codes, latency, DNS queries
#
# üìä METRICS ENABLED:
# - hubble_flows_processed_total{http_method="GET|POST|..."}
# - hubble_flows_processed_total{http_status="200|404|500|..."}
# - hubble_flows_processed_total{dns_query="example.com"}
# - Full L7 visibility in Hubble UI
#
# üîí SECURITY IMPACT:
# - This policy is ALLOW-ALL (does NOT block traffic)
# - Only enables Envoy proxy visibility for specified ports
# - No impact on existing NetworkPolicies
# - Minimal performance overhead (Envoy is highly optimized)
#
# üåê PORTS MONITORED:
# - 80/TCP, 8080/TCP, 443/TCP: HTTP/HTTPS traffic
# - 3000/TCP: Common app port (Grafana, Node apps)
# - 9090-9999/TCP: Metrics/observability ports
# - 53/UDP: DNS queries (both ingress and egress)
---
apiVersion: cilium.io/v2
kind: CiliumClusterwideNetworkPolicy
metadata:
  name: global-l7-visibility
spec:
  description: "Enable L7 HTTP/DNS visibility for all pods globally (required for Hubble httpV2 metrics)"

  # Apply to ALL pods in ALL namespaces
  endpointSelector: {}

  # Ingress rules - HTTP traffic TO pods
  ingress:
    - fromEntities:
        - all
      toPorts:
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
            - port: "3000"
              protocol: TCP
            - port: "8080"
              protocol: TCP
            - port: "9090"
              protocol: TCP
            - port: "9091"
              protocol: TCP
            - port: "9093"
              protocol: TCP
            - port: "9100"
              protocol: TCP
            - port: "9115"
              protocol: TCP
          rules:
            http:
              - method: "GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS"

        # DNS ingress (less common, but included for completeness)
        - ports:
            - port: "53"
              protocol: UDP
          rules:
            dns:
              - matchPattern: "*"

  # Egress rules - HTTP/DNS traffic FROM pods
  egress:
    - toEntities:
        - all
      toPorts:
        # HTTP/HTTPS egress
        - ports:
            - port: "80"
              protocol: TCP
            - port: "443"
              protocol: TCP
            - port: "3000"
              protocol: TCP
            - port: "8080"
              protocol: TCP
            - port: "9090"
              protocol: TCP
            - port: "9091"
              protocol: TCP
            - port: "9093"
              protocol: TCP
            - port: "9100"
              protocol: TCP
            - port: "9115"
              protocol: TCP
          rules:
            http:
              - method: "GET|POST|PUT|DELETE|PATCH|HEAD|OPTIONS"

        # DNS egress (most common - pods querying DNS)
        - ports:
            - port: "53"
              protocol: UDP
          rules:
            dns:
              - matchPattern: "*"
