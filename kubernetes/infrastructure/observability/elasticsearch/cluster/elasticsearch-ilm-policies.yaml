# üîÑ ELASTICSEARCH ILM POLICIES - 2025 BEST PRACTICES
# ====================================================
# Index Lifecycle Management for automated retention and cost optimization
# Reference: Elastic official docs, Netflix/Uber logging patterns
#
# POLICY DESIGN PRINCIPLES:
# 1. HOT phase: Active writing + querying (recent logs, high IOPS)
# 2. WARM phase: Read-only, optimized for query performance
# 3. COLD phase: Rarely accessed, compressed storage
# 4. DELETE phase: Automatic cleanup after retention period
#
# ROLLOVER TRIGGERS: Size (30-50GB) OR Age (7d) OR Docs (whichever comes first)
# RETENTION PERIODS: Based on log criticality and compliance requirements

---
# üìä POLICY 1: VECTOR KUBERNETES LOGS (HOT ‚Üí DELETE)
# For: Application logs from Kubernetes pods via Vector
# Retention: 30 days (standard homelab retention)
# Rollover: 30GB or 7 days (whichever comes first)
apiVersion: v1
kind: ConfigMap
metadata:
  name: ilm-vector-logs
  namespace: elastic-system
  labels:
    app.kubernetes.io/component: ilm-policy
    ilm.policy.type: logs
data:
  policy.json: |
    {
      "policy": {
        "phases": {
          "hot": {
            "min_age": "0ms",
            "actions": {
              "rollover": {
                "max_primary_shard_size": "30GB",
                "max_age": "7d"
              },
              "set_priority": {
                "priority": 100
              }
            }
          },
          "warm": {
            "min_age": "7d",
            "actions": {
              "set_priority": {
                "priority": 50
              },
              "forcemerge": {
                "max_num_segments": 1
              },
              "shrink": {
                "number_of_shards": 1
              }
            }
          },
          "delete": {
            "min_age": "30d",
            "actions": {
              "delete": {}
            }
          }
        }
      }
    }

---
# üö® POLICY 2: ERROR LOGS (HOT ‚Üí WARM ‚Üí DELETE)
# For: Critical error logs requiring longer retention
# Retention: 90 days (compliance requirement)
# Rollover: 50GB or 7 days (larger indices for errors)
apiVersion: v1
kind: ConfigMap
metadata:
  name: ilm-error-logs
  namespace: elastic-system
  labels:
    app.kubernetes.io/component: ilm-policy
    ilm.policy.type: error-logs
data:
  policy.json: |
    {
      "policy": {
        "phases": {
          "hot": {
            "min_age": "0ms",
            "actions": {
              "rollover": {
                "max_primary_shard_size": "50GB",
                "max_age": "7d"
              },
              "set_priority": {
                "priority": 100
              }
            }
          },
          "warm": {
            "min_age": "7d",
            "actions": {
              "set_priority": {
                "priority": 50
              },
              "forcemerge": {
                "max_num_segments": 1
              },
              "readonly": {}
            }
          },
          "cold": {
            "min_age": "30d",
            "actions": {
              "set_priority": {
                "priority": 0
              },
              "searchable_snapshot": {
                "snapshot_repository": "backup-repo"
              }
            }
          },
          "delete": {
            "min_age": "90d",
            "actions": {
              "delete": {}
            }
          }
        }
      }
    }

---
# ‚ö° POLICY 3: DEBUG LOGS (HOT ‚Üí DELETE)
# For: Verbose debug/trace logs (short retention)
# Retention: 7 days (temporary debugging data)
# Rollover: 20GB or 1 day (fast rollover for high volume)
apiVersion: v1
kind: ConfigMap
metadata:
  name: ilm-debug-logs
  namespace: elastic-system
  labels:
    app.kubernetes.io/component: ilm-policy
    ilm.policy.type: debug-logs
data:
  policy.json: |
    {
      "policy": {
        "phases": {
          "hot": {
            "min_age": "0ms",
            "actions": {
              "rollover": {
                "max_primary_shard_size": "20GB",
                "max_age": "1d"
              },
              "set_priority": {
                "priority": 100
              }
            }
          },
          "delete": {
            "min_age": "7d",
            "actions": {
              "delete": {}
            }
          }
        }
      }
    }

---
# üîç POLICY 4: AUDIT LOGS (HOT ‚Üí WARM ‚Üí COLD ‚Üí DELETE)
# For: Security/compliance audit logs
# Retention: 365 days (1 year compliance requirement)
# Rollover: 50GB or 30 days (monthly indices)
apiVersion: v1
kind: ConfigMap
metadata:
  name: ilm-audit-logs
  namespace: elastic-system
  labels:
    app.kubernetes.io/component: ilm-policy
    ilm.policy.type: audit-logs
data:
  policy.json: |
    {
      "policy": {
        "phases": {
          "hot": {
            "min_age": "0ms",
            "actions": {
              "rollover": {
                "max_primary_shard_size": "50GB",
                "max_age": "30d"
              },
              "set_priority": {
                "priority": 100
              }
            }
          },
          "warm": {
            "min_age": "30d",
            "actions": {
              "set_priority": {
                "priority": 50
              },
              "forcemerge": {
                "max_num_segments": 1
              },
              "readonly": {}
            }
          },
          "cold": {
            "min_age": "90d",
            "actions": {
              "set_priority": {
                "priority": 0
              }
            }
          },
          "delete": {
            "min_age": "365d",
            "actions": {
              "delete": {}
            }
          }
        }
      }
    }

---
# üìã POLICY 5: METRICS LOGS (HOT ‚Üí DELETE)
# For: Performance/metrics logs from applications
# Retention: 14 days (short-term metrics correlation)
# Rollover: 30GB or 1 day (daily rollover for time-series data)
apiVersion: v1
kind: ConfigMap
metadata:
  name: ilm-metrics-logs
  namespace: elastic-system
  labels:
    app.kubernetes.io/component: ilm-policy
    ilm.policy.type: metrics-logs
data:
  policy.json: |
    {
      "policy": {
        "phases": {
          "hot": {
            "min_age": "0ms",
            "actions": {
              "rollover": {
                "max_primary_shard_size": "30GB",
                "max_age": "1d"
              },
              "set_priority": {
                "priority": 100
              }
            }
          },
          "delete": {
            "min_age": "14d",
            "actions": {
              "delete": {}
            }
          }
        }
      }
    }

---
# üéØ ILM POLICY BOOTSTRAP JOB
# Job that applies ILM policies to Elasticsearch via REST API
# Runs once after Elasticsearch cluster is ready
apiVersion: batch/v1
kind: Job
metadata:
  name: ilm-policy-bootstrap
  namespace: elastic-system
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
  labels:
    app.kubernetes.io/component: ilm-bootstrap
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: apply-ilm-policies
        image: curlimages/curl:8.11.0
        command:
        - /bin/sh
        - -c
        - |
          set -e

          ES_URL="https://production-cluster-es-http.elastic-system.svc.cluster.local:9200"

          # Wait for Elasticsearch to be ready
          until curl -k -s -u "elastic:${ES_PASSWORD}" "${ES_URL}/_cluster/health" | grep -q '"status":"green\|yellow"'; do
            echo "Waiting for Elasticsearch cluster..."
            sleep 10
          done

          echo "Elasticsearch is ready. Applying ILM policies..."

          # Apply vector-logs policy (30d retention)
          curl -k -X PUT -u "elastic:${ES_PASSWORD}" \
            "${ES_URL}/_ilm/policy/vector-logs-30d" \
            -H 'Content-Type: application/json' \
            -d @/policies/ilm-vector-logs.json

          # Apply error-logs policy (90d retention)
          curl -k -X PUT -u "elastic:${ES_PASSWORD}" \
            "${ES_URL}/_ilm/policy/error-logs-90d" \
            -H 'Content-Type: application/json' \
            -d @/policies/ilm-error-logs.json

          # Apply debug-logs policy (7d retention)
          curl -k -X PUT -u "elastic:${ES_PASSWORD}" \
            "${ES_URL}/_ilm/policy/debug-logs-7d" \
            -H 'Content-Type: application/json' \
            -d @/policies/ilm-debug-logs.json

          # Apply audit-logs policy (365d retention)
          curl -k -X PUT -u "elastic:${ES_PASSWORD}" \
            "${ES_URL}/_ilm/policy/audit-logs-365d" \
            -H 'Content-Type: application/json' \
            -d @/policies/ilm-audit-logs.json

          # Apply metrics-logs policy (14d retention)
          curl -k -X PUT -u "elastic:${ES_PASSWORD}" \
            "${ES_URL}/_ilm/policy/metrics-logs-14d" \
            -H 'Content-Type: application/json' \
            -d @/policies/ilm-metrics-logs.json

          echo "‚úÖ All ILM policies applied successfully!"

          # Apply default ILM policy to vector-* index template
          curl -k -X PUT -u "elastic:${ES_PASSWORD}" \
            "${ES_URL}/_index_template/vector-logs-template" \
            -H 'Content-Type: application/json' \
            -d '{
              "index_patterns": ["vector-*"],
              "template": {
                "settings": {
                  "index.lifecycle.name": "vector-logs-30d",
                  "index.lifecycle.rollover_alias": "vector-logs"
                }
              }
            }'

          echo "‚úÖ Index template configured with ILM policy!"
        env:
        - name: ES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: production-cluster-es-elastic-user
              key: elastic
        volumeMounts:
        - name: ilm-policies
          mountPath: /policies
      volumes:
      - name: ilm-policies
        projected:
          sources:
          - configMap:
              name: ilm-vector-logs
              items:
              - key: policy.json
                path: ilm-vector-logs.json
          - configMap:
              name: ilm-error-logs
              items:
              - key: policy.json
                path: ilm-error-logs.json
          - configMap:
              name: ilm-debug-logs
              items:
              - key: policy.json
                path: ilm-debug-logs.json
          - configMap:
              name: ilm-audit-logs
              items:
              - key: policy.json
                path: ilm-audit-logs.json
          - configMap:
              name: ilm-metrics-logs
              items:
              - key: policy.json
                path: ilm-metrics-logs.json
