## Jaeger ILM Policy - Replaces esIndexCleaner CronJob with native Elasticsearch lifecycle management
## Retention: 7 days, Rollover: Daily OR 50GB
apiVersion: batch/v1
kind: Job
metadata:
  name: create-jaeger-ilm-policy
  namespace: elastic-system
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
  labels:
    app.kubernetes.io/component: jaeger-ilm
    app.kubernetes.io/part-of: observability-stack
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: create-jaeger-ilm
          image: curlimages/curl:8.11.0
          command:
            - sh
            - -c
            - |
              set -e

              ES_HOST="https://production-cluster-es-http.elastic-system.svc.cluster.local:9200"
              ES_USER="elastic"
              ES_PASS="${ELASTICSEARCH_PASSWORD}"

              echo "üîç Creating Jaeger ILM Policy (7d retention, daily rollover)"

              until curl -sk -u "${ES_USER}:${ES_PASS}" "${ES_HOST}/_cluster/health" | grep -q '"status":"green\|yellow"'; do
                sleep 5
              done

              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_ilm/policy/jaeger-traces-7d" \
              -H 'Content-Type: application/json' \
              -d '{
                "policy": {
                  "phases": {
                    "hot": {
                      "min_age": "0ms",
                      "actions": {
                        "rollover": {
                          "max_age": "1d",
                          "max_primary_shard_size": "50gb"
                        },
                        "set_priority": {
                          "priority": 100
                        }
                      }
                    },
                    "delete": {
                      "min_age": "7d",
                      "actions": {
                        "delete": {}
                      }
                    }
                  }
                }
              }'


              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_index_template/jaeger-span-template" \
              -H 'Content-Type: application/json' \
              -d '{
                "index_patterns": ["jaeger-span-*"],
                "template": {
                  "settings": {
                    "index.lifecycle.name": "jaeger-traces-7d",
                    "index.lifecycle.rollover_alias": "jaeger-span-write",
                    "number_of_shards": 3,
                    "number_of_replicas": 1,
                    "refresh_interval": "5s"
                  },
                  "mappings": {
                    "dynamic": "true",
                    "properties": {
                      "traceID": { "type": "keyword" },
                      "spanID": { "type": "keyword" },
                      "operationName": { "type": "keyword" },
                      "startTime": { "type": "long" },
                      "duration": { "type": "long" },
                      "tags": { "type": "nested" },
                      "process": { "type": "object" }
                    }
                  }
                },
                "priority": 200,
                "composed_of": [],
                "version": 1,
                "_meta": {
                  "description": "Jaeger span indices with 7-day ILM retention"
                }
              }'


              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_index_template/jaeger-service-template" \
              -H 'Content-Type: application/json' \
              -d '{
                "index_patterns": ["jaeger-service-*"],
                "template": {
                  "settings": {
                    "index.lifecycle.name": "jaeger-traces-7d",
                    "index.lifecycle.rollover_alias": "jaeger-service-write",
                    "number_of_shards": 1,
                    "number_of_replicas": 1
                  }
                },
                "priority": 200
              }'


              if ! curl -sk -u "${ES_USER}:${ES_PASS}" "${ES_HOST}/_alias/jaeger-span-write" | grep -q "jaeger-span"; then
                curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
                "${ES_HOST}/jaeger-span-000001" \
                -H 'Content-Type: application/json' \
                -d '{
                  "aliases": {
                    "jaeger-span-write": {
                      "is_write_index": true
                    }
                  }
                }'
              fi

              if ! curl -sk -u "${ES_USER}:${ES_PASS}" "${ES_HOST}/_alias/jaeger-service-write" | grep -q "jaeger-service"; then
                curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
                "${ES_HOST}/jaeger-service-000001" \
                -H 'Content-Type: application/json' \
                -d '{
                  "aliases": {
                    "jaeger-service-write": {
                      "is_write_index": true
                    }
                  }
                }'
              fi

              echo "‚úÖ Jaeger ILM policy created - 7d retention, daily rollover"
          env:
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: production-cluster-es-elastic-user
                  key: elastic
