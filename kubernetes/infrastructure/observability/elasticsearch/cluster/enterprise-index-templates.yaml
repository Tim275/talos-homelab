# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
# ENTERPRISE INDEX TEMPLATES - Data Streams + ECS + Compression
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# Creates component templates + index templates for:
# 1. Data Streams (automatic rollover)
# 2. ECS-compliant field mappings
# 3. Best compression (30-50% disk savings)
# 4. Index sorting by @timestamp (faster queries)
#
# Pattern: logs-{service}-{severity}
# Rollover: Monthly (2025.10, 2025.11, etc.)
#
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
apiVersion: batch/v1
kind: Job
metadata:
  name: create-enterprise-index-templates
  namespace: elastic-system
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: create-templates
          image: curlimages/curl:8.11.0
          command:
            - sh
            - -c
            - |
              set -e

              ES_HOST="https://production-cluster-es-http.elastic-system.svc.cluster.local:9200"
              ES_USER="elastic"
              ES_PASS="${ELASTICSEARCH_PASSWORD}"

              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "🏗️  ENTERPRISE INDEX TEMPLATES CREATION"
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

              # ─────────────────────────────────────────────────────────
              # COMPONENT TEMPLATE 1: ECS Settings (Compression + Sorting)
              # ─────────────────────────────────────────────────────────
              echo ""
              echo "📦 Creating component template: logs-settings@custom"
              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_component_template/logs-settings@custom" \
              -H 'Content-Type: application/json' \
              -d '{
                "template": {
                  "settings": {
                    "index.codec": "best_compression",
                    "index.number_of_shards": 1,
                    "index.number_of_replicas": 1,
                    "index.refresh_interval": "30s",
                    "index.query.default_field": ["message"],
                    "index.sort.field": ["@timestamp"],
                    "index.sort.order": ["desc"]
                  }
                },
                "_meta": {
                  "description": "Enterprise compression + sorting settings",
                  "created_by": "talos-homelab-enterprise-logging"
                }
              }'

              # ─────────────────────────────────────────────────────────
              # COMPONENT TEMPLATE 2: ECS Field Mappings
              # ─────────────────────────────────────────────────────────
              echo ""
              echo "🗺️  Creating component template: logs-mappings@custom"
              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_component_template/logs-mappings@custom" \
              -H 'Content-Type: application/json' \
              -d '{
                "template": {
                  "mappings": {
                    "properties": {
                      "@timestamp": {
                        "type": "date",
                        "format": "strict_date_optional_time||epoch_millis"
                      },
                      "ecs": {
                        "properties": {
                          "version": { "type": "keyword" }
                        }
                      },
                      "message": {
                        "type": "text",
                        "fields": {
                          "keyword": { "type": "keyword", "ignore_above": 1024 }
                        }
                      },
                      "log": {
                        "properties": {
                          "level": { "type": "keyword" },
                          "logger": { "type": "keyword" }
                        }
                      },
                      "service": {
                        "properties": {
                          "name": { "type": "keyword" },
                          "version": { "type": "keyword" },
                          "environment": { "type": "keyword" }
                        }
                      },
                      "trace": {
                        "properties": {
                          "id": { "type": "keyword" }
                        }
                      },
                      "transaction": {
                        "properties": {
                          "id": { "type": "keyword" }
                        }
                      },
                      "span": {
                        "properties": {
                          "id": { "type": "keyword" }
                        }
                      },
                      "kubernetes": {
                        "properties": {
                          "namespace": { "type": "keyword" },
                          "pod_name": { "type": "keyword" },
                          "container_name": { "type": "keyword" },
                          "node_name": { "type": "keyword" }
                        }
                      },
                      "cluster": { "type": "keyword" },
                      "datacenter": { "type": "keyword" },
                      "environment": { "type": "keyword" },
                      "severity": { "type": "keyword" },
                      "namespace": { "type": "keyword" }
                    }
                  }
                },
                "_meta": {
                  "description": "ECS-compliant field mappings + custom fields",
                  "ecs_version": "8.17"
                }
              }'

              # ─────────────────────────────────────────────────────────
              # INDEX TEMPLATE: logs-* (Data Streams)
              # ─────────────────────────────────────────────────────────
              echo ""
              echo "📋 Creating index template: logs"
              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_index_template/logs" \
              -H 'Content-Type: application/json' \
              -d '{
                "index_patterns": ["logs-*"],
                "data_stream": {},
                "composed_of": [
                  "logs-settings@custom",
                  "logs-mappings@custom"
                ],
                "priority": 500,
                "_meta": {
                  "description": "Enterprise data streams for service-based logging",
                  "managed_by": "talos-homelab"
                }
              }'

              echo ""
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo "✅ ENTERPRISE INDEX TEMPLATES CREATED SUCCESSFULLY!"
              echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
              echo ""
              echo "📊 Templates created:"
              echo "  - logs-settings@custom (compression + sorting)"
              echo "  - logs-mappings@custom (ECS + custom fields)"
              echo "  - logs (index template for data streams)"
              echo ""
              echo "🎯 Features enabled:"
              echo "  ✅ Data Streams (automatic rollover)"
              echo "  ✅ Best compression (30-50% disk savings)"
              echo "  ✅ Index sorting by @timestamp (faster queries)"
              echo "  ✅ ECS-compliant field mappings"
              echo "  ✅ Tracing fields (trace.id, transaction.id, span.id)"
              echo ""
          env:
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: production-cluster-es-elastic-user
                  key: elastic
