# OMS (Order Management System) Logs ILM Policy
# For Vector-generated logs from OMS services (gateway, orders, payments, stock, kitchen)
# Data Stream Pattern: logs-oms-*
# Retention: 30 days (standard application logs)
# Rollover: 20GB or 7 days (whichever comes first)
---
apiVersion: batch/v1
kind: Job
metadata:
  name: create-oms-logs-ilm-policy
  namespace: elastic-system
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
  labels:
    app.kubernetes.io/component: oms-ilm
    app.kubernetes.io/part-of: observability-stack
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: create-oms-ilm
          image: curlimages/curl:8.11.0
          command:
            - sh
            - -c
            - |
              set -e

              ES_HOST="https://production-cluster-es-http.elastic-system.svc.cluster.local:9200"
              ES_USER="elastic"
              ES_PASS="${ELASTICSEARCH_PASSWORD}"

              echo "Waiting for Elasticsearch to be ready..."
              until curl -sk -u "${ES_USER}:${ES_PASS}" "${ES_HOST}/_cluster/health" | grep -q '"status":"green\|yellow"'; do
                sleep 5
              done

              echo "Creating OMS Logs ILM Policy (30d retention)..."

              # Create ILM Policy for OMS logs
              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_ilm/policy/oms-logs-30d" \
              -H 'Content-Type: application/json' \
              -d '{
                "policy": {
                  "phases": {
                    "hot": {
                      "min_age": "0ms",
                      "actions": {
                        "rollover": {
                          "max_primary_shard_size": "20gb",
                          "max_age": "7d"
                        },
                        "set_priority": {
                          "priority": 100
                        }
                      }
                    },
                    "warm": {
                      "min_age": "7d",
                      "actions": {
                        "set_priority": {
                          "priority": 50
                        },
                        "forcemerge": {
                          "max_num_segments": 1
                        },
                        "shrink": {
                          "number_of_shards": 1
                        }
                      }
                    },
                    "delete": {
                      "min_age": "30d",
                      "actions": {
                        "delete": {}
                      }
                    }
                  }
                }
              }'

              echo ""
              echo "Creating OMS Logs Component Template..."

              # Create component template with ILM settings
              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_component_template/oms-logs-settings" \
              -H 'Content-Type: application/json' \
              -d '{
                "template": {
                  "settings": {
                    "index.lifecycle.name": "oms-logs-30d",
                    "number_of_shards": 1,
                    "number_of_replicas": 1,
                    "refresh_interval": "5s"
                  }
                },
                "_meta": {
                  "description": "Settings for OMS logs with 30-day ILM retention"
                }
              }'

              echo ""
              echo "Creating OMS Logs Index Template..."

              # Create index template that applies to all logs-oms-* data streams
              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_index_template/logs-oms" \
              -H 'Content-Type: application/json' \
              -d '{
                "index_patterns": ["logs-oms-*"],
                "data_stream": {},
                "composed_of": ["oms-logs-settings", "logs-mappings", "logs@custom"],
                "priority": 500,
                "_meta": {
                  "description": "Template for OMS application logs with 30-day ILM retention",
                  "managed": true
                },
                "ignore_missing_component_templates": ["logs-mappings", "logs@custom"]
              }'

              echo ""
              echo "Creating ILM Policy for OMS Error Logs (90d retention)..."

              # Create separate ILM policy for critical/error logs (longer retention)
              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_ilm/policy/oms-errors-90d" \
              -H 'Content-Type: application/json' \
              -d '{
                "policy": {
                  "phases": {
                    "hot": {
                      "min_age": "0ms",
                      "actions": {
                        "rollover": {
                          "max_primary_shard_size": "30gb",
                          "max_age": "7d"
                        },
                        "set_priority": {
                          "priority": 100
                        }
                      }
                    },
                    "warm": {
                      "min_age": "14d",
                      "actions": {
                        "set_priority": {
                          "priority": 50
                        },
                        "forcemerge": {
                          "max_num_segments": 1
                        },
                        "readonly": {}
                      }
                    },
                    "cold": {
                      "min_age": "30d",
                      "actions": {
                        "set_priority": {
                          "priority": 0
                        }
                      }
                    },
                    "delete": {
                      "min_age": "90d",
                      "actions": {
                        "delete": {}
                      }
                    }
                  }
                }
              }'

              echo ""
              echo "Creating OMS Errors Index Template..."

              # Create index template for critical logs (logs-oms-*.critical-*)
              curl -sk -X PUT -u "${ES_USER}:${ES_PASS}" \
              "${ES_HOST}/_index_template/logs-oms-critical" \
              -H 'Content-Type: application/json' \
              -d '{
                "index_patterns": ["logs-oms-*.critical-*"],
                "data_stream": {},
                "template": {
                  "settings": {
                    "index.lifecycle.name": "oms-errors-90d",
                    "number_of_shards": 1,
                    "number_of_replicas": 1
                  }
                },
                "priority": 600,
                "_meta": {
                  "description": "Template for OMS critical/error logs with 90-day ILM retention"
                }
              }'

              echo ""
              echo "Verifying ILM Policies..."
              curl -sk -u "${ES_USER}:${ES_PASS}" "${ES_HOST}/_ilm/policy/oms-*" | head -c 500

              echo ""
              echo "OMS ILM policies created successfully!"
              echo "  - oms-logs-30d: Standard application logs (30 days)"
              echo "  - oms-errors-90d: Critical/error logs (90 days)"
          env:
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: production-cluster-es-elastic-user
                  key: elastic
