# Job: Enable Searchable Snapshots for Cold Tier
# This job updates ILM policies to use searchable snapshots instead of local storage
# Benefit: 90% storage reduction for cold tier data
---
apiVersion: batch/v1
kind: Job
metadata:
  name: elasticsearch-enable-searchable-snapshots
  namespace: elastic-system
  labels:
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/component: ilm-policy-update
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: elasticsearch
        app.kubernetes.io/component: ilm-policy-update
    spec:
      restartPolicy: OnFailure
      containers:
        - name: update-policies
          image: curlimages/curl:8.11.1
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "üîÑ Updating ILM Policies with Searchable Snapshots"
              echo "=================================================="

              # Wait for Elasticsearch to be ready
              echo "‚è≥ Waiting for Elasticsearch..."
              until curl -sk -u "elastic:$ELASTIC_PASSWORD" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_cluster/health" \
                | grep -q '"status":"green\|yellow"'; do
                sleep 5
              done
              echo "‚úÖ Elasticsearch is ready"

              # Update logs-critical-policy
              echo ""
              echo "üìù Updating logs-critical-policy..."
              curl -sk -X PUT -u "elastic:$ELASTIC_PASSWORD" \
                -H "Content-Type: application/json" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-critical-policy" \
                -d '{
                  "policy": {
                    "phases": {
                      "hot": {
                        "min_age": "0ms",
                        "actions": {
                          "set_priority": {"priority": 100},
                          "rollover": {
                            "max_age": "7d",
                            "max_primary_shard_size": "50gb"
                          }
                        }
                      },
                      "warm": {
                        "min_age": "7d",
                        "actions": {
                          "forcemerge": {"max_num_segments": 1},
                          "shrink": {
                            "number_of_shards": 1,
                            "allow_write_after_shrink": false
                          },
                          "set_priority": {"priority": 50}
                        }
                      },
                      "cold": {
                        "min_age": "30d",
                        "actions": {
                          "searchable_snapshot": {
                            "snapshot_repository": "ceph-s3-snapshots"
                          },
                          "set_priority": {"priority": 0}
                        }
                      },
                      "delete": {
                        "min_age": "90d",
                        "actions": {
                          "delete": {"delete_searchable_snapshot": true}
                        }
                      }
                    }
                  }
                }'
              echo ""
              echo "‚úÖ logs-critical-policy updated"

              # Update logs-warn-policy
              echo ""
              echo "üìù Updating logs-warn-policy..."
              curl -sk -X PUT -u "elastic:$ELASTIC_PASSWORD" \
                -H "Content-Type: application/json" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-warn-policy" \
                -d '{
                  "policy": {
                    "phases": {
                      "hot": {
                        "min_age": "0ms",
                        "actions": {
                          "set_priority": {"priority": 100},
                          "rollover": {
                            "max_age": "7d",
                            "max_primary_shard_size": "50gb"
                          }
                        }
                      },
                      "warm": {
                        "min_age": "7d",
                        "actions": {
                          "forcemerge": {"max_num_segments": 1},
                          "shrink": {
                            "number_of_shards": 1,
                            "allow_write_after_shrink": false
                          },
                          "set_priority": {"priority": 50}
                        }
                      },
                      "cold": {
                        "min_age": "30d",
                        "actions": {
                          "searchable_snapshot": {
                            "snapshot_repository": "ceph-s3-snapshots"
                          },
                          "set_priority": {"priority": 0}
                        }
                      },
                      "delete": {
                        "min_age": "60d",
                        "actions": {
                          "delete": {"delete_searchable_snapshot": true}
                        }
                      }
                    }
                  }
                }'
              echo ""
              echo "‚úÖ logs-warn-policy updated"

              # Update logs-info-policy
              echo ""
              echo "üìù Updating logs-info-policy..."
              curl -sk -X PUT -u "elastic:$ELASTIC_PASSWORD" \
                -H "Content-Type: application/json" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-info-policy" \
                -d '{
                  "policy": {
                    "phases": {
                      "hot": {
                        "min_age": "0ms",
                        "actions": {
                          "set_priority": {"priority": 100},
                          "rollover": {
                            "max_age": "7d",
                            "max_primary_shard_size": "50gb"
                          }
                        }
                      },
                      "warm": {
                        "min_age": "7d",
                        "actions": {
                          "forcemerge": {"max_num_segments": 1},
                          "shrink": {
                            "number_of_shards": 1,
                            "allow_write_after_shrink": false
                          },
                          "set_priority": {"priority": 50}
                        }
                      },
                      "delete": {
                        "min_age": "30d",
                        "actions": {
                          "delete": {"delete_searchable_snapshot": true}
                        }
                      }
                    }
                  }
                }'
              echo ""
              echo "‚úÖ logs-info-policy updated"

              # Verify updates
              echo ""
              echo "üîç Verifying policy updates..."

              CRITICAL=$(curl -sk -u "elastic:$ELASTIC_PASSWORD" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-critical-policy" \
                | grep -o '"searchable_snapshot"' | wc -l)

              WARN=$(curl -sk -u "elastic:$ELASTIC_PASSWORD" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-warn-policy" \
                | grep -o '"searchable_snapshot"' | wc -l)

              INFO=$(curl -sk -u "elastic:$ELASTIC_PASSWORD" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-info-policy" \
                | grep -o '"searchable_snapshot"' | wc -l)

              echo ""
              echo "üìä Verification Results:"
              echo "  logs-critical-policy: $CRITICAL searchable_snapshot actions"
              echo "  logs-warn-policy:     $WARN searchable_snapshot actions"
              echo "  logs-info-policy:     $INFO searchable_snapshot actions (note: no cold phase, only delete)"

              echo ""
              echo "üéâ Searchable Snapshots Enabled Successfully!"
              echo ""
              echo "üìà Expected Storage Savings:"
              echo "  - Cold tier data: ~90% reduction"
              echo "  - Migrates to S3 (Ceph RGW) after 30 days"
              echo "  - Queries still work (slightly slower)"
              echo ""
              echo "‚è∞ Timeline:"
              echo "  Day 0-7:   Hot tier (local SSD)"
              echo "  Day 7-30:  Warm tier (local SSD, optimized)"
              echo "  Day 30+:   Cold tier (S3 searchable snapshot) ‚Üê 90% savings!"
              echo "  Day 60/90: Deleted"
          env:
            - name: ELASTIC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: production-cluster-es-elastic-user
                  key: elastic
