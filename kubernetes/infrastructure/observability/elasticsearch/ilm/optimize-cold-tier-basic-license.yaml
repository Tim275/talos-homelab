# Job: Optimize Cold Tier for Basic License
# This job updates ILM policies to use Basic-compatible cold tier optimizations
# Benefit: 40-50% storage reduction WITHOUT requiring paid license
---
apiVersion: batch/v1
kind: Job
metadata:
  name: elasticsearch-optimize-cold-tier-basic
  namespace: elastic-system
  labels:
    app.kubernetes.io/name: elasticsearch
    app.kubernetes.io/component: ilm-policy-update
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: elasticsearch
        app.kubernetes.io/component: ilm-policy-update
    spec:
      restartPolicy: OnFailure
      containers:
        - name: update-policies
          image: curlimages/curl:8.11.1
          command:
            - /bin/sh
            - -c
            - |
              set -e

              echo "üîÑ Optimizing ILM Policies for Basic License"
              echo "=============================================="
              echo ""
              echo "License: BASIC (Free)"
              echo "Strategy: readonly + 0 replicas in cold tier"
              echo "Expected savings: 40-50%"
              echo ""

              # Wait for Elasticsearch to be ready
              echo "‚è≥ Waiting for Elasticsearch..."
              until curl -sk -u "elastic:$ELASTIC_PASSWORD" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_cluster/health" \
                | grep -q '"status":"green\|yellow"'; do
                sleep 5
              done
              echo "‚úÖ Elasticsearch is ready"

              # Update logs-critical-policy
              echo ""
              echo "üìù Updating logs-critical-policy..."
              # yamllint disable-line rule:line-length
              curl -sk -X PUT -u "elastic:$ELASTIC_PASSWORD" \
                -H "Content-Type: application/json" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-critical-policy" \
                -d '{
                  "policy": {
                    "phases": {
                      "hot": {
                        "min_age": "0ms",
                        "actions": {
                          "set_priority": {"priority": 100},
                          "rollover": {
                            "max_age": "7d",
                            "max_primary_shard_size": "50gb"
                          }
                        }
                      },
                      "warm": {
                        "min_age": "7d",
                        "actions": {
                          "forcemerge": {"max_num_segments": 1},
                          "shrink": {
                            "number_of_shards": 1,
                            "allow_write_after_shrink": false
                          },
                          "set_priority": {"priority": 50}
                        }
                      },
                      "cold": {
                        "min_age": "30d",
                        "actions": {
                          "readonly": {},
                          "allocate": {
                            "number_of_replicas": 0
                          },
                          "set_priority": {"priority": 0}
                        }
                      },
                      "delete": {
                        "min_age": "90d",
                        "actions": {
                          "delete": {"delete_searchable_snapshot": true}
                        }
                      }
                    }
                  }
                }'
              echo ""
              echo "‚úÖ logs-critical-policy updated (0 replicas in cold)"

              # Update logs-warn-policy
              echo ""
              echo "üìù Updating logs-warn-policy..."
              # yamllint disable-line rule:line-length
              curl -sk -X PUT -u "elastic:$ELASTIC_PASSWORD" \
                -H "Content-Type: application/json" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-warn-policy" \
                -d '{
                  "policy": {
                    "phases": {
                      "hot": {
                        "min_age": "0ms",
                        "actions": {
                          "set_priority": {"priority": 100},
                          "rollover": {
                            "max_age": "7d",
                            "max_primary_shard_size": "50gb"
                          }
                        }
                      },
                      "warm": {
                        "min_age": "7d",
                        "actions": {
                          "forcemerge": {"max_num_segments": 1},
                          "shrink": {
                            "number_of_shards": 1,
                            "allow_write_after_shrink": false
                          },
                          "set_priority": {"priority": 50}
                        }
                      },
                      "cold": {
                        "min_age": "30d",
                        "actions": {
                          "readonly": {},
                          "allocate": {
                            "number_of_replicas": 0
                          },
                          "set_priority": {"priority": 0}
                        }
                      },
                      "delete": {
                        "min_age": "60d",
                        "actions": {
                          "delete": {"delete_searchable_snapshot": true}
                        }
                      }
                    }
                  }
                }'
              echo ""
              echo "‚úÖ logs-warn-policy updated (0 replicas in cold)"

              # Verify updates
              echo ""
              echo "üîç Verifying policy updates..."

              # yamllint disable-line rule:line-length
              CRITICAL=$(curl -sk -u "elastic:$ELASTIC_PASSWORD" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-critical-policy" \
                | grep -o '"number_of_replicas":0' | wc -l)

              # yamllint disable-line rule:line-length
              WARN=$(curl -sk -u "elastic:$ELASTIC_PASSWORD" \
                "https://production-cluster-es-http.elastic-system.svc.cluster.local:9200/_ilm/policy/logs-warn-policy" \
                | grep -o '"number_of_replicas":0' | wc -l)

              echo ""
              echo "üìä Verification Results:"
              # yamllint disable-line rule:line-length
              echo "  logs-critical-policy: Cold tier has 0 replicas: $([ $CRITICAL -eq 1 ] && echo '‚úÖ YES' || echo '‚ùå NO')"
              # yamllint disable-line rule:line-length
              echo "  logs-warn-policy:     Cold tier has 0 replicas: $([ $WARN -eq 1 ] && echo '‚úÖ YES' || echo '‚ùå NO')"

              echo ""
              echo "üéâ Cold Tier Optimization Complete!"
              echo ""
              echo "üìà Storage Savings (Basic License):"
              echo "  - Warm tier: ~30% (forcemerge + shrink)"
              echo "  - Cold tier: ~50% (0 replicas + readonly)"
              echo "  - Total: ~40-50% reduction"
              echo ""
              echo "‚è∞ Timeline:"
              echo "  Day 0-7:   Hot tier (local SSD, 1 replica)"
              echo "  Day 7-30:  Warm tier (optimized, 1 replica)"
              echo "  Day 30+:   Cold tier (0 replicas, readonly) ‚Üê 50% savings!"
              echo "  Day 60/90: Deleted"
              echo ""
              echo "‚ÑπÔ∏è  Note: For 90% savings, upgrade to Enterprise license"
              echo "    and enable Searchable Snapshots (~$8,400/year)"
          env:
            - name: ELASTIC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: production-cluster-es-elastic-user
                  key: elastic
