---
apiVersion: batch/v1
kind: Job
metadata:
  name: cleanup-old-vector-indices
  namespace: elastic-system
  annotations:
    argocd.argoproj.io/hook: Skip
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: cleanup
        image: curlimages/curl:8.11.0
        command:
          - sh
          - -c
          - |
            set -e
            echo "🗑️  Deleting all old vector-* indices..."

            # Get Elasticsearch password
            ES_PASSWORD="${ELASTICSEARCH_PASSWORD}"
            ES_HOST="https://production-cluster-es-http.elastic-system.svc.cluster.local:9200"

            # Get list of all vector-* indices
            echo "📋 Fetching list of vector-* indices..."
            INDICES=$(curl -sk -u "elastic:${ES_PASSWORD}" \
              "${ES_HOST}/_cat/indices/vector-*?h=index" | tr '\n' ' ')

            if [ -z "$INDICES" ]; then
              echo "✅ No vector-* indices found. Already clean!"
              exit 0
            fi

            echo "Found indices to delete:"
            echo "$INDICES" | tr ' ' '\n'

            # Count indices
            INDEX_COUNT=$(echo "$INDICES" | wc -w)
            echo ""
            echo "📊 Total indices to delete: $INDEX_COUNT"
            echo ""

            # Delete indices in batches of 50 (to avoid URL length limits)
            echo "$INDICES" | tr ' ' '\n' | while read -r index; do
              if [ -n "$index" ]; then
                echo "🗑️  Deleting: $index"
                curl -sk -X DELETE -u "elastic:${ES_PASSWORD}" \
                  "${ES_HOST}/${index}" > /dev/null
              fi
            done

            echo ""
            echo "✅ Cleanup complete! All old vector-* indices deleted."
            echo "🚀 New enterprise indices will be created with logs-{layer}-{severity} pattern."
        env:
        - name: ELASTICSEARCH_PASSWORD
          valueFrom:
            secretKeyRef:
              name: production-cluster-es-elastic-user
              key: elastic
