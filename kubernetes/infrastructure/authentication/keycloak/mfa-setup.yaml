apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-mfa-setup
  namespace: keycloak
spec:
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        app: keycloak-mfa-setup
    spec:
      restartPolicy: OnFailure
      containers:
        - name: setup
          image: quay.io/keycloak/keycloak:26.0.7
          env:
            - name: KEYCLOAK_ADMIN
              value: admin
            - name: KEYCLOAK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin
                  key: password
            - name: KEYCLOAK_URL
              value: "http://keycloak:8080"
          command:
            - /bin/bash
            - -c
            - |
              set -e

              echo "=== Logging in to Keycloak ==="
              /opt/keycloak/bin/kcadm.sh config credentials \
                --server "$KEYCLOAK_URL" \
                --realm master \
                --user "$KEYCLOAK_ADMIN" \
                --password "$KEYCLOAK_ADMIN_PASSWORD"

              echo "=== Enable OTP Required Action (Google Authenticator) ==="
              /opt/keycloak/bin/kcadm.sh update authentication/required-actions/CONFIGURE_TOTP -r kubernetes \
                -s enabled=true \
                -s defaultAction=true

              echo "=== Configure OTP Policy (6 digits, 30s period) ==="
              /opt/keycloak/bin/kcadm.sh update realms/kubernetes -r kubernetes \
                -s 'otpPolicyType=totp' \
                -s 'otpPolicyAlgorithm=HmacSHA1' \
                -s 'otpPolicyDigits=6' \
                -s 'otpPolicyPeriod=30'

              echo "=== Configure Session Timeouts ==="
              /opt/keycloak/bin/kcadm.sh update realms/kubernetes -r kubernetes \
                -s 'ssoSessionIdleTimeout=1800' \
                -s 'ssoSessionMaxLifespan=36000' \
                -s 'accessTokenLifespan=300'

              echo ""
              echo "=========================================="
              echo "MFA Setup Complete!"
              echo "=========================================="
              echo "Next login: Setup Google Authenticator"
              echo "- Login with username/password"
              echo "- Scan QR code with Authenticator app"
              echo "- Enter 6-digit code"
              echo "=========================================="
