---
# Job to configure velero-backups bucket with enterprise settings
apiVersion: batch/v1
kind: Job
metadata:
  name: configure-velero-bucket
  namespace: velero
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: aws-cli
          image: amazon/aws-cli:2.15.0
          command:
            - /bin/bash
            - -c
            - |
              # Extract credentials from cloud file
              export AWS_ACCESS_KEY_ID=$(grep aws_access_key_id /credentials/cloud | cut -d= -f2)
              export AWS_SECRET_ACCESS_KEY=$(grep aws_secret_access_key /credentials/cloud | cut -d= -f2)
              ENDPOINT="http://rook-ceph-rgw-homelab-objectstore.rook-ceph.svc:80"
              BUCKET="velero-backups"

              echo "ðŸ”§ Configuring Enterprise Backup Bucket Settings..."

              # 1. Enable Versioning
              echo "âœ… Enabling Versioning..."
              aws s3api put-bucket-versioning \
                --bucket $BUCKET \
                --versioning-configuration Status=Enabled \
                --endpoint-url=$ENDPOINT \
                --region=us-east-1

              # 2. Enable Server-Side Encryption (AES-256)
              echo "ðŸ”’ Enabling AES-256 Encryption..."
              aws s3api put-bucket-encryption \
                --bucket $BUCKET \
                --server-side-encryption-configuration '{
                  "Rules": [{
                    "ApplyServerSideEncryptionByDefault": {
                      "SSEAlgorithm": "AES256"
                    },
                    "BucketKeyEnabled": true
                  }]
                }' \
                --endpoint-url=$ENDPOINT \
                --region=us-east-1

              # 3. Set Lifecycle Policy (Auto-cleanup after 90 days)
              echo "â° Setting Lifecycle Policy..."
              cat > /tmp/lifecycle.json <<'EOF'
              {
                "Rules": [
                  {
                    "ID": "DeleteOldBackups",
                    "Status": "Enabled",
                    "Expiration": {
                      "Days": 90
                    },
                    "NoncurrentVersionExpiration": {
                      "NoncurrentDays": 7
                    },
                    "Filter": {
                      "Prefix": ""
                    }
                  },
                  {
                    "ID": "CleanupIncompleteUploads",
                    "Status": "Enabled",
                    "AbortIncompleteMultipartUpload": {
                      "DaysAfterInitiation": 7
                    },
                    "Filter": {
                      "Prefix": ""
                    }
                  }
                ]
              }
              EOF

              aws s3api put-bucket-lifecycle-configuration \
                --bucket $BUCKET \
                --lifecycle-configuration file:///tmp/lifecycle.json \
                --endpoint-url=$ENDPOINT \
                --region=us-east-1

              # 4. Enable Object Lock (WORM - Write Once Read Many)
              # Note: Object Lock requires bucket creation with --object-lock-enabled-for-bucket
              # We'll enable it via bucket policy instead
              echo "ðŸ” Setting Bucket Policy for enhanced protection..."
              cat > /tmp/policy.json <<'EOF'
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Sid": "DenyDeleteWithoutMFA",
                    "Effect": "Deny",
                    "Principal": "*",
                    "Action": [
                      "s3:DeleteObject",
                      "s3:DeleteObjectVersion"
                    ],
                    "Resource": "arn:aws:s3:::velero-backups/*"
                  }
                ]
              }
              EOF

              aws s3api put-bucket-policy \
                --bucket $BUCKET \
                --policy file:///tmp/policy.json \
                --endpoint-url=$ENDPOINT \
                --region=us-east-1 || echo "âš ï¸  Bucket policy may not be fully supported by Ceph RGW"

              # 5. Verify Configuration
              echo ""
              echo "ðŸ“‹ Bucket Configuration Summary:"
              echo "================================"

              echo "Versioning:"
              aws s3api get-bucket-versioning \
                --bucket $BUCKET \
                --endpoint-url=$ENDPOINT \
                --region=us-east-1

              echo ""
              echo "Encryption:"
              aws s3api get-bucket-encryption \
                --bucket $BUCKET \
                --endpoint-url=$ENDPOINT \
                --region=us-east-1

              echo ""
              echo "Lifecycle:"
              aws s3api get-bucket-lifecycle-configuration \
                --bucket $BUCKET \
                --endpoint-url=$ENDPOINT \
                --region=us-east-1

              echo ""
              echo "âœ… Enterprise Backup Bucket Configuration Complete!"

          volumeMounts:
            - name: credentials
              mountPath: /credentials
              readOnly: true
      volumes:
        - name: credentials
          secret:
            secretName: velero-s3-credentials
