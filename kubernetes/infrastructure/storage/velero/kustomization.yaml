apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization


namespace: velero

resources:
  - ns.yaml
  # ObjectBucketClaim removed - using manual CephObjectStoreUser + bucket creation
  # Separate buckets per backup type for better isolation and management
  # Note: CephObjectStoreUser resources are applied directly (not via kustomization)
  # to avoid namespace override conflicts (they need rook-ceph namespace)
  - sealed-secret-s3.yaml    # Ceph RGW S3 credentials
  - velero-restic-credentials-sealedsecret.yaml  # Restic encryption key (client-side encryption)
  # - sealed-secret-aws.yaml   # OPTIONAL: AWS S3 credentials for offsite DR (uncomment to activate)
  # Backup schedules moved to separate ArgoCD Application (Enterprise best practice)
  # See: kubernetes/infrastructure/storage/velero-schedules/

patches:
  - path: patches/upgrade-job-initcontainer-resources.yaml
    target:
      kind: Job
      name: velero-upgrade-crds

helmCharts:
  - name: velero
    repo: https://vmware-tanzu.github.io/helm-charts
    version: 10.1.3
    releaseName: velero
    namespace: velero
    includeCRDs: true
    valuesInline:
      image:
        repository: velero/velero
        tag: v1.14.1
      replicas: 2
      credentials:
        useSecret: true
        existingSecret: velero-s3-credentials
        extraSecretRef: velero-restic-credentials
      upgradeJobResources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 100m
          memory: 256Mi
      configuration:
        features: ""  # CSI DISABLED - CSI plugin ignores uploaderType and always creates Kopia repos!
        defaultBackupTTL: 8760h
        uploaderType: restic  # Use Restic File System Backup (direct mount, no CSI)
        backupStorageLocation:
          - name: cluster-backups
            provider: aws
            default: true
            bucket: velero-cluster-backups
            config:
              region: us-east-1
              s3ForcePathStyle: "true"
              s3Url: http://rook-ceph-rgw-homelab-objectstore.rook-ceph.svc:80
              insecureSkipTLSVerify: "true"
          - name: pv-backups
            provider: aws
            bucket: velero-pv-backups
            config:
              region: us-east-1
              s3ForcePathStyle: "true"
              s3Url: http://rook-ceph-rgw-homelab-objectstore.rook-ceph.svc:80
              insecureSkipTLSVerify: "true"
          # OPTIONAL: AWS S3 Offsite Backup (Disaster Recovery)
          # ACTIVATION STEPS:
          # 1. Create AWS S3 bucket: timour-homelab-velero-dr
          # 2. Create IAM user with S3 full access policy
          # 3. Create sealed-secret-aws.yaml with AWS credentials (see template below)
          # 4. Uncomment sealed-secret-aws.yaml in resources section
          # 5. Uncomment this BackupStorageLocation
          # 6. Uncomment AWS schedules in velero-schedules/backup-schedules-aws.yaml
          # 7. kubectl apply -f infrastructure/storage/velero/
          # Estimated cost: EUR 0.50/month for ~50GB (Glacier Instant Retrieval)
          # - name: aws-s3-offsite
          #   provider: aws
          #   bucket: timour-homelab-velero-dr
          #   credential:
          #     name: velero-aws-credentials
          #     key: cloud
          #   config:
          #     region: eu-central-1  # Frankfurt (closest to Germany)
      snapshotsEnabled: false  # Disable CSI snapshots - use Restic FS backup only
      resources:
        limits:
          cpu: 1000m
          memory: 512Mi
        requests:
          cpu: 500m
          memory: 256Mi
      metrics:
        enabled: true
        scrapeInterval: 30s
        scrapeTimeout: 10s
        service:
          annotations:
            prometheus.io/scrape: "true"
            prometheus.io/port: "8085"
            prometheus.io/path: "/metrics"
      deployNodeAgent: true
      nodeAgent:
        resources:
          limits:
            cpu: 1000m
            memory: 1Gi
          requests:
            cpu: 500m
            memory: 512Mi
        podSecurityContext:
          runAsUser: 0  # Must run as root for host path access
        containerSecurityContext:
          privileged: false  # Not fully privileged
          allowPrivilegeEscalation: false
      # ENTERPRISE ENCRYPTION - Client-Side with Restic
      # Backups are encrypted BEFORE upload to S3!
      defaultVolumesToFsBackup: true  # Force Restic FS backup for all PVs (no CSI snapshots)
      podSecurityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containerSecurityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop:
            - ALL
        # readOnlyRootFilesystem: true  # Disabled - Velero/Kopia needs write access to /udmrepo
        runAsNonRoot: true
      serviceAccount:
        server:
          create: true
          name: velero
      initContainers:
        - name: velero-plugin-for-aws
          image: velero/velero-plugin-for-aws:v1.11.0
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              cpu: 10m
              memory: 32Mi
            limits:
              cpu: 50m
              memory: 64Mi
          volumeMounts:
            - mountPath: /target
              name: plugins
