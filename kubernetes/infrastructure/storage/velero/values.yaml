# DISASTER RECOVERY - Tier 0 Backup
# ===================================================

# Velero Configuration
image:
  repository: velero/velero
  tag: v1.17.1

# Enterprise HA Configuration
replicas: 2

# Credentials for backup storage (Ceph RGW S3 + Restic encryption)
credentials:
  useSecret: true
  existingSecret: velero-s3-credentials  # SealedSecret mit Ceph RGW credentials
  extraSecretRef: velero-restic-credentials  # SealedSecret with encryption key

# Backup Configuration
configuration:
  # Default Backup TTL (7 days for Homelab)
  defaultBackupTTL: 168h

  backupStorageLocation:
    - name: default
      provider: aws
      bucket: velero-backups
      config:
        region: eu-west-1  # Berlin
        s3ForcePathStyle: "true"
        s3Url: http://rook-ceph-rgw-homelab-objectstore.rook-ceph.svc:80

  # Volume Snapshot Location (for PV snapshots)
  volumeSnapshotLocation:
    - name: default
      provider: csi

# Enable CSI Snapshots
snapshotsEnabled: true

# Resource Configuration (Homelab-optimized)
resources:
  limits:
    cpu: 500m
    memory: 512Mi
  requests:
    cpu: 100m       # Homelab: reduced from 500m
    memory: 128Mi

# Monitoring
metrics:
  enabled: true
  scrapeInterval: 30s
  scrapeTimeout: 10s
  service:
    annotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8085"
      prometheus.io/path: "/metrics"

# Node Agent (for pod volume backup with Kopia encryption)
nodeAgent:
  podVolumePath: /var/lib/kubelet/pods
  privileged: false
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m       # Homelab: reduced from 500m (DaemonSet on every node!)
      memory: 256Mi

# ENCRYPTION - Client-Side with Kopia
# Backups are encrypted BEFORE upload to S3!
uploaderType: kopia  # Kopia replaces deprecated restic

# Security
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

containerSecurityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true

# Service Account
serviceAccount:
  server:
    create: true
    name: velero

# Init Containers (for S3 plugin support)
initContainers:
  - name: velero-plugin-for-aws
    image: velero/velero-plugin-for-aws:v1.13.1
    imagePullPolicy: IfNotPresent
    volumeMounts:
      - mountPath: /target
        name: plugins
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 100m
        memory: 64Mi

# Upgrade CRDs Job Configuration
# DISABLED: ArgoCD cannot handle Helm hooks properly
# CRDs are already installed - no upgrade needed
upgradeCRDs: false
upgradeJobResources:
  requests:
    cpu: 10m
    memory: 16Mi
  limits:
    cpu: 100m
    memory: 64Mi

upgradeCRDsJob:
  podLabels:
    app.kubernetes.io/name: velero
    app.kubernetes.io/instance: velero
    app.kubernetes.io/component: upgrade-crds
