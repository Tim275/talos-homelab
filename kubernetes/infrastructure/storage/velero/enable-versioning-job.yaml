#  S3 Bucket Versioning Job - Ransomware Protection
# : Enable versioning for backup immutability
apiVersion: batch/v1
kind: Job
metadata:
  name: enable-velero-bucket-versioning
  namespace: velero
  labels:
    app: velero
    component: bucket-config
    backup.tier: tier0
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      labels:
        app: velero
        job: enable-versioning
    spec:
      restartPolicy: OnFailure
      serviceAccountName: velero
      containers:
        - name: enable-versioning
          image: amazon/aws-cli:2.33.20@sha256:3a6dd5403e6509efc130a7e2ace86ff2e2238a7c9b588f6277451b22cf905413
          command:
            - /bin/bash
            - -c
            - |
              echo " Configuring S3 bucket versioning for velero-backups..."

              # AWS CLI configuration for Ceph RGW
              export AWS_ACCESS_KEY_ID=$(cat /credentials/cloud | \
                grep aws_access_key_id | cut -d'=' -f2 | tr -d ' ')
              export AWS_SECRET_ACCESS_KEY=$(cat /credentials/cloud | \
                grep aws_secret_access_key | cut -d'=' -f2 | tr -d ' ')
              export AWS_DEFAULT_REGION=us-east-1

              BUCKET_NAME="velero-backups"
              S3_ENDPOINT="http://rook-ceph-rgw-homelab-objectstore.rook-ceph.svc:80"

              # Enable versioning (best effort for Ceph RGW)
              echo " Enabling bucket versioning..."
              if aws s3api put-bucket-versioning \
                --bucket "$BUCKET_NAME" \
                --versioning-configuration Status=Enabled \
                --endpoint-url "$S3_ENDPOINT" 2>&1; then
                echo " Versioning command executed successfully"
              else
                echo "  Versioning command failed (Ceph RGW may not support this)"
              fi

              # Verify versioning is enabled (Ceph RGW compatibility)
              echo " Verifying versioning status..."
              VERSIONING_OUTPUT=$(aws s3api get-bucket-versioning \
                --bucket "$BUCKET_NAME" \
                --endpoint-url "$S3_ENDPOINT" \
                --output text 2>&1 || true)

              if echo "$VERSIONING_OUTPUT" | grep -q "Enabled"; then
                echo " SUCCESS: Bucket versioning is enabled!"
                echo " Ransomware Protection: Active"
              else
                echo "  WARNING: Could not verify versioning status"
                echo "â„¹  Ceph RGW may not fully support S3 versioning API"
                echo " Versioning command executed (best effort)"
                echo " Output: $VERSIONING_OUTPUT"
              fi
          volumeMounts:
            - name: credentials
              mountPath: /credentials
              readOnly: true
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              cpu: 100m
              memory: 128Mi
          securityContext:
            runAsNonRoot: true
            runAsUser: 65534
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
      volumes:
        - name: credentials
          secret:
            secretName: velero-s3-credentials
