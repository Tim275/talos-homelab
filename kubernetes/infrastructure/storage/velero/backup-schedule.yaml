# ENTERPRISE VELERO BACKUP SCHEDULES
# ========================================
# Tier-based backup strategy following enterprise best practices
# Reference: Velero Best Practices, GitLab/Netflix/Spotify backup patterns

---
# TIER 0: CRITICAL DATABASES - Every 24h, 7 days retention (Homelab optimized)
# PostgreSQL, Redis, LLDAP, Authelia secrets
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: tier0-databases-24h
  namespace: velero
  labels:
    backup.tier: tier0
    backup.type: database
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM
  template:
    ttl: 168h  # 7 days retention
    includedNamespaces:
      - lldap
      - authelia
      - n8n-dev
      - n8n-prod
      - postgres-operator
    labelSelector:
      matchLabels:
        backup.tier: tier0
    snapshotVolumes: true
    defaultVolumesToFsBackup: false  # Use CSI snapshots
    storageLocation: default
    volumeSnapshotLocations:
      - default

---
# TIER 1: STATEFUL APPLICATIONS - Daily, 14 days retention
# N8N workflows, Grafana dashboards, ArgoCD config
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: tier1-stateful-apps-daily
  namespace: velero
  labels:
    backup.tier: tier1
    backup.type: stateful-app
spec:
  schedule: "0 2 * * *"  # Daily at 02:00 AM
  template:
    ttl: 336h  # 14 days retention
    includedNamespaces:
      - n8n-dev
      - n8n-prod
      - grafana
      - argocd
    labelSelector:
      matchExpressions:
        - key: backup.tier
          operator: In
          values:
            - tier0
            - tier1
    snapshotVolumes: true
    defaultVolumesToFsBackup: false
    storageLocation: default
    volumeSnapshotLocations:
      - default

---
# TIER 2: PLATFORM SERVICES - Weekly, 30 days retention
# Identity platform (LLDAP, Authelia), Cert-Manager, Sealed Secrets
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: tier2-platform-weekly
  namespace: velero
  labels:
    backup.tier: tier2
    backup.type: platform-service
spec:
  schedule: "0 3 * * 0"  # Weekly on Sunday at 03:00 AM
  template:
    ttl: 720h  # 30 days retention
    includedNamespaces:
      - lldap
      - authelia
      - cert-manager
      - sealed-secrets
      - istio-system
    snapshotVolumes: true
    defaultVolumesToFsBackup: false
    storageLocation: default
    volumeSnapshotLocations:
      - default

---
# TIER 3: FULL CLUSTER BACKUP - Monthly, 90 days retention
# Complete cluster state backup for disaster recovery
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: tier3-full-cluster-monthly
  namespace: velero
  labels:
    backup.tier: tier3
    backup.type: full-cluster
spec:
  schedule: "0 4 1 * *"  # Monthly on 1st at 04:00 AM
  template:
    ttl: 2160h  # 90 days retention
    # Backup ALL namespaces except system
    excludedNamespaces:
      - kube-system
      - kube-public
      - kube-node-lease
    snapshotVolumes: true
    defaultVolumesToFsBackup: false
    storageLocation: default
    volumeSnapshotLocations:
      - default

---
# TIER 4: CONFIGURATION BACKUP - Every 4 hours, 3 days retention
# ArgoCD Applications, Kyverno Policies, Network Policies (lightweight)
apiVersion: velero.io/v1
kind: Schedule
metadata:
  name: tier4-config-4h
  namespace: velero
  labels:
    backup.tier: tier4
    backup.type: configuration
spec:
  schedule: "0 */4 * * *"  # Every 4 hours
  template:
    ttl: 72h  # 3 days retention
    includedNamespaces:
      - argocd
      - kyverno
    # Only backup specific resources (no PVs)
    includedResources:
      - applications.argoproj.io
      - applicationsets.argoproj.io
      - clusterpolicies.kyverno.io
      - policies.kyverno.io
      - networkpolicies.networking.k8s.io
    snapshotVolumes: false  # No volumes for config-only backup
    storageLocation: default
