apiVersion: v1
kind: ConfigMap
metadata:
  name: n8n-configmap
  namespace: n8n-prod
data:
  # ==========================================
  # CORE CONFIGURATION (Enterprise)
  # ==========================================
  N8N_PORT: "3008"
  N8N_PROTOCOL: "https"
  N8N_HOST: "n8n.timourhomelab.org"
  N8N_EDITOR_BASE_URL: "https://n8n.timourhomelab.org"
  WEBHOOK_URL: "https://n8n.timourhomelab.org/"

  # Proxy settings (critical for reverse proxy)
  N8N_PROXY_HOPS: "1"
  N8N_SECURE_COOKIE: "false"
  N8N_TRUST_PROXY: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"

  # ==========================================
  # PUSH BACKEND (WebSocket/SSE)
  # ==========================================
  # SSE is more reliable through proxies than WebSocket
  N8N_PUSH_BACKEND: "sse"

  # ==========================================
  # QUEUE MODE (Enterprise HA)
  # ==========================================
  EXECUTIONS_MODE: "queue"
  QUEUE_HEALTH_CHECK_ACTIVE: "true"

  # Redis Configuration
  QUEUE_BULL_REDIS_HOST: "redis-n8n.n8n-prod.svc.cluster.local"
  QUEUE_BULL_REDIS_PORT: "6379"
  QUEUE_BULL_REDIS_DB: "0"
  QUEUE_BULL_PREFIX: "n8n-queue"

  # Worker Configuration
  QUEUE_WORKER_LOCK_DURATION: "30000"
  QUEUE_WORKER_LOCK_RENEW_TIME: "15000"
  QUEUE_WORKER_STALLED_INTERVAL: "30000"
  QUEUE_WORKER_MAX_STALLED_COUNT: "3"

  # ==========================================
  # DATABASE (PostgreSQL CNPG)
  # ==========================================
  DB_TYPE: "postgresdb"
  DB_POSTGRESDB_HOST: "n8n-postgres-rw.n8n-prod.svc.cluster.local"
  DB_POSTGRESDB_PORT: "5432"
  DB_POSTGRESDB_DATABASE: "n8n"
  DB_POSTGRESDB_USER: "n8n"
  DB_POSTGRESDB_SCHEMA: "public"

  # ==========================================
  # EXECUTION SETTINGS
  # ==========================================
  EXECUTIONS_TIMEOUT: "3600"
  EXECUTIONS_TIMEOUT_MAX: "7200"
  EXECUTIONS_DATA_SAVE_ON_ERROR: "all"
  EXECUTIONS_DATA_SAVE_ON_SUCCESS: "all"
  EXECUTIONS_DATA_SAVE_ON_PROGRESS: "true"
  EXECUTIONS_DATA_MAX_AGE: "168"
  EXECUTIONS_DATA_PRUNE: "true"

  # ==========================================
  # LOGGING & MONITORING
  # ==========================================
  N8N_LOG_LEVEL: "info"
  N8N_LOG_OUTPUT: "console"
  N8N_METRICS: "true"
  N8N_METRICS_INCLUDE_QUEUE_METRICS: "true"
  N8N_METRICS_QUEUE_METRICS_INTERVAL: "30"

  # ==========================================
  # SECURITY
  # ==========================================
  N8N_BASIC_AUTH_ACTIVE: "false"
  N8N_JWT_AUTH_ACTIVE: "false"
  N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS: "false"
  N8N_BLOCK_ENV_ACCESS_IN_NODE: "false"

  # Security: Disable bare repos in Git node
  N8N_GIT_NODE_DISABLE_BARE_REPOS: "true"

  # ==========================================
  # TASK RUNNERS
  # ==========================================
  N8N_RUNNERS_ENABLED: "true"

  # ==========================================
  # TEMPLATES & FEATURES
  # ==========================================
  N8N_TEMPLATES_ENABLED: "true"
  N8N_ONBOARDING_FLOW_DISABLED: "false"
  N8N_PERSONALIZATION_ENABLED: "true"
